\newcommand{\textoperatorname}[1]{
  \operatorname{\textnormal{#1}}
}
\newcommand{\et}{\text{ét}}
\newcommand{\Et}{\text{Ét}}
\newcommand\stacksymbol[3]{
  \mathrel{\stackunder[2pt]{\stackon[4pt]{$#3$}{$\scriptscriptstyle#1$}}{
  $\scriptscriptstyle#2$}}
}
\newcommand{\ext}{\operatorname{Ext}}
\newcommand{\Ext}{\operatorname{Ext}}
\newcommand{\Endo}{\operatorname{End}}
\newcommand{\Ind}{\operatorname{Ind}}
\newcommand{\ind}{\operatorname{Ind}}
\newcommand{\coind}{\operatorname{Coind}}
\newcommand{\proj}{\operatorname{Proj}}
\newcommand{\Proj}{\operatorname{Proj}}
\newcommand{\res}{\operatorname{Res}}
\newcommand{\Res}{\operatorname{Res}}
\newcommand{\Hol}{\operatorname{Hol}}
\newcommand{\Br}{\operatorname{Br}}
\newcommand{\coh}{\operatorname{coh}}
\newcommand{\colspace}{\operatorname{colspace}}
\newcommand{\rowspace}{\operatorname{rowspace}}
\newcommand{\codom}{\operatorname{codom}}
\newcommand{\range}{\operatorname{range}}
\newcommand{\nullspace}{\operatorname{nullspace}}
\newcommand{\nullity}{\operatorname{nullspace}}
\newcommand{\projection}{\operatorname{Proj}}
\newcommand{\Der}{\operatorname{Der}}
\renewcommand{\AA}[0]{{\mathbb{A}}}
\newcommand{\Af}[0]{{\mathbb{A}}}
\newcommand{\CC}[0]{{\mathbb{C}}}
\newcommand{\CP}[0]{{\mathbb{CP}}}
\newcommand{\DD}[0]{{\mathbb{D}}}
\newcommand{\FF}[0]{{\mathbb{F}}}
\newcommand{\fq}[0]{{\mathbb{F}_{q}}}
\newcommand{\fqr}[0]{{\mathbb{F}_{q^r}}}
\newcommand{\GF}[0]{{\mathbb{GF}}}
\newcommand{\GG}[0]{{\mathbb{G}}}
\newcommand{\HH}[0]{{\mathbb{H}}}
\newcommand{\HP}[0]{{\mathbb{HP}}}
\newcommand{\KK}[0]{{\mathbb{K}}}
\newcommand{\kk}[0]{{\mathbb{k}}}
\newcommand{\bbm}[0]{{\mathbb{M}}}
\newcommand{\NN}[0]{{\mathbb{N}}}
\newcommand{\OP}[0]{{\mathbb{OP}}}
\newcommand{\PP}[0]{{\mathbb{P}}}
\newcommand{\QQ}[0]{{\mathbb{Q}}}
\newcommand{\RP}[0]{{\mathbb{RP}}}
\newcommand{\RR}[0]{{\mathbb{R}}}
\newcommand{\SpSp}[0]{{\mathbb{S}}}
\renewcommand{\SS}[0]{{\mathbb{S}}}
\newcommand{\TT}[0]{{\mathbb{T}}}
\newcommand{\ZZ}[0]{{\mathbb{Z}}}
\newcommand{\znz}[0]{\mathbb{Z}/n\mathbb{Z}}
\newcommand{\zpz}[0]{\mathbb{Z}/p\mathbb{Z}}
\newcommand{\zlz}[0]{\mathbb{Z}/\ell\mathbb{Z}}
\newcommand{\zlnz}[0]{\mathbb{Z}/\ell^n\mathbb{Z}}
\newcommand{\Qp}[0]{\mathbb{Q}_{(p)}}
\newcommand{\Zp}[0]{\mathbb{Z}_{(p)}}
\newcommand{\Arg}[0]{\operatorname{Arg}}
\newcommand{\PGL}[0]{\operatorname{PGL}}
\newcommand{\GL}[0]{\operatorname{GL}}
\newcommand{\Gl}[0]{\operatorname{GL}}
\newcommand{\gl}[0]{\operatorname{GL}}
\newcommand{\mat}[0]{\operatorname{Mat}}
\newcommand{\Mat}[0]{\operatorname{Mat}}
\newcommand{\Rat}[0]{\operatorname{Rat}}
\newcommand{\Perv}[0]{\operatorname{Perv}}
\newcommand{\Gal}[0]{\operatorname{Gal}}
\newcommand{\Hilb}[0]{\operatorname{Hilb}}
\newcommand{\Quot}[0]{\operatorname{Quot}}
\newcommand{\Art}[0]{\operatorname{Art}}
\newcommand{\red}[0]{\operatorname{red}}
\newcommand{\Pic}[0]{{\operatorname{Pic}}}
\newcommand{\lcm}[0]{\operatorname{lcm}}
\newcommand{\maps}[0]{\operatorname{Maps}}
\newcommand{\maxspec}[0]{{\operatorname{maxSpec}}}
\newcommand{\Tr}[0]{\operatorname{Tr}}
\newcommand{\adj}[0]{\operatorname{adj}}
\newcommand{\ad}[0]{\operatorname{ad}}
\newcommand{\ann}[0]{\operatorname{Ann}}
\newcommand{\Ann}[0]{\operatorname{Ann}}
\newcommand{\arcsec}[0]{\operatorname{arcsec}}
\newcommand{\ch}[0]{\operatorname{ch}}
\newcommand{\Sp}[0]{{\operatorname{Sp}}}
\newcommand{\syl}[0]{{\operatorname{Syl}}}
\newcommand{\ff}[0]{\operatorname{ff}}
\newcommand{\txand}[0]{{\operatorname{ and }}}
\newcommand{\fppf}[0]{\mathrm{\operatorname{fppf}}}
\newcommand{\Fppf}[0]{\mathrm{\operatorname{Fppf}}}
\newcommand{\zar}[0]{{\mathrm{zar}}}
\newcommand{\Zar}[0]{{\mathrm{Zar}}}
\newcommand{\qcoh}[0]{{\mathrm{QCoh}}}
\newcommand{\Qcoh}[0]{{\mathrm{QCoh}}}
\newcommand{\QCoh}[0]{{\mathrm{QCoh}}}
\newcommand{\codim}[0]{\operatorname{codim}}
\newcommand{\coim}[0]{\operatorname{coim}}
\newcommand{\ssets}[0]{\operatorname{sSets}}
\newcommand{\dom}[0]{\operatorname{dom}}
\newcommand{\txor}[0]{{\operatorname{ or }}}
\newcommand{\txt}[1]{{\operatorname{ {#1} }}}
\newcommand{\Gr}[0]{{\operatorname{Gr}}}
\newcommand{\gr}[0]{{\operatorname{gr}}}
\newcommand{\dcoset}[3]{
    {\textstyle #1}
    \mkern-4mu\scalebox{1.5}{$\diagdown$}\mkern-5mu^{\textstyle #2}
    \mkern-4mu\scalebox{1.5}{$\diagup$}\mkern-5mu{\textstyle #3} }
\newcommand{\grdim}[0]{{\operatorname{gr\,dim}}}
\newcommand{\Aut}[0]{{\operatorname{Aut}}}
\newcommand{\aut}[0]{\operatorname{Aut}}
\newcommand{\Inn}[0]{{\operatorname{Inn}}}
\newcommand{\Out}[0]{{\operatorname{Out}}}
\newcommand{\mltext}[1]{\left\{\begin{array}{c}#1\end{array}\right\}}
\newcommand{\Fun}[0]{{\operatorname{Fun}}}
\newcommand{\SL}[0]{{\operatorname{SL}}}
\newcommand{\PSL}[0]{{\operatorname{PSL}}}
\newcommand{\SO}[0]{{\operatorname{SO}}}
\newcommand{\SU}[0]{{\operatorname{SU}}}
\newcommand{\SP}[0]{{\operatorname{SP}}}
\newcommand{\per}[0]{{\operatorname{Per}}}
\newcommand{\loc}[0]{{\operatorname{loc}}}
\newcommand{\Top}[0]{{\operatorname{Top}}}
\newcommand{\Ab}[0]{{\operatorname{Ab}}}
\newcommand{\mcTop}[0]{\mathcal{T}\operatorname{op}}
\newcommand{\hoTop}[0]{{\operatorname{hoTop}}}
\newcommand{\Sch}[0]{{\operatorname{Sch}}}
\newcommand{\sch}[0]{{\operatorname{Sch}}}
\newcommand{\Sing}[0]{{\operatorname{Sing}}}
\newcommand{\alg}[0]{\mathrm{Alg}}
\newcommand{\scalg}[0]{\mathrm{sCAlg}}
\newcommand{\calg}[0]{\mathrm{CAlg}}
\newcommand{\dR}[0]{\mathrm{dR}}
\newcommand{\poly}[0]{\operatorname{poly}}
\newcommand{\Vect}[0]{{\operatorname{Vect}}}
\newcommand{\Sh}[0]{{\operatorname{Sh}}}
\newcommand{\presh}[0]{{\operatorname{Presh}}}
\newcommand{\Presh}[0]{{\operatorname{Presh}}}
\newcommand{\ab}[0]{{\operatorname{ab}}}
\newcommand{\op}[0]{^{\operatorname{op}}}
\newcommand{\Op}[0]{{\operatorname{Op}}}
\newcommand{\Ob}[0]{{\operatorname{Ob}}}
\newcommand{\prim}[0]{{\operatorname{prim}}}
\newcommand{\Set}[0]{{\operatorname{Set}}}
\newcommand{\Sets}[0]{{\operatorname{Set}}}
\newcommand{\Grp}[0]{{\operatorname{Grp}}}
\newcommand{\Groups}[0]{{\operatorname{Groups}}}
\newcommand{\Homeo}[0]{{\operatorname{Homeo}}}
\newcommand{\Diffeo}[0]{{\operatorname{Diffeo}}}
\newcommand{\MCG}[0]{{\operatorname{MCG}}}
\newcommand{\set}[0]{{\operatorname{Set}}}
\newcommand{\Tor}[0]{\operatorname{Tor}}
\newcommand{\sets}[0]{{\operatorname{Set}}}
\newcommand{\Sm}[0]{{\operatorname{Sm}_k}}
\newcommand{\orr}[0]{{\operatorname{ or }}}
\newcommand{\annd}[0]{{\operatorname{ and }}}
\newcommand{\bung}[0]{\operatorname{Bun}_G}
\newcommand{\const}[0]{{\operatorname{const.}}}
\newcommand{\disc}[0]{{\operatorname{disc}}}
\newcommand{\id}[0]{\operatorname{id}}
\newcommand{\im}[0]{\operatorname{im}}
\newcommand{\pt}[0]{{\{\operatorname{pt}\}}}
\newcommand{\sep}[0]{^\operatorname{sep}}
\newcommand{\tors}[0]{{\operatorname{tors}}}
\newcommand{\tor}[0]{\operatorname{Tor}}
\newcommand{\height}[0]{\operatorname{ht}}
\newcommand{\cpt}[0]{\operatorname{compact}}
\newcommand{\abs}[1]{{\left\lvert {#1} \right\rvert}}
\newcommand{\stack}[1]{\mathclap{\substack{ #1 }}} 
\newcommand{\qtext}[1]{{\quad \operatorname{#1} \quad}}
\newcommand{\qst}[0]{{\quad \operatorname{such that} \quad}}
\newcommand{\actsonl}[0]{\curvearrowleft}
\newcommand{\actson}[0]{\curvearrowright}
\newcommand{\bd}[0]{{\del}}
\newcommand{\bigast}[0]{{\mathop{\Large \ast}}}
\newcommand{\coker}[0]{\operatorname{coker}}
\newcommand{\cok}[0]{\operatorname{coker}}
\newcommand{\conjugate}[1]{{\overline{{#1}}}}
\newcommand{\converges}[1]{\overset{#1}}
\newcommand{\correspond}[1]{\theset{\substack{#1}}}
\newcommand{\cross}[0]{\times}
\newcommand{\by}[0]{\times}
\newcommand{\dash}[0]{{\hbox{-}}}
\newcommand{\dd}[2]{{\frac{\partial #1}{\partial #2}\,}}
\newcommand{\definedas}[0]{\coloneqq}
\newcommand{\da}[0]{\coloneqq}
\newcommand{\del}[0]{{\partial}}
\newcommand{\directlim}[0]{\varinjlim}
\newcommand{\inverselim}[0]{\varprojlim}
\newcommand{\disjoint}[0]{{\coprod}}
\newcommand{\Disjoint}[0]{\displaystyle\coprod}
\newcommand{\dual}[0]{^\vee}
\newcommand{\sm}[0]{\setminus}
\newcommand{\smz}[0]{\setminus\theset{0}}
\newcommand{\eps}[0]{\varepsilon}
\newcommand{\equalsbecause}[1] {\stackrel{\mathclap{\scriptscriptstyle{#1}}}{=}}
\newcommand{\floor}[1]{{\left\lfloor #1 \right\rfloor}}
\newcommand{\up}[0]{\uparrow}
\newcommand{\generators}[1]{\left\langle{#1}\right\rangle}
\newcommand{\gs}[1]{\left\langle{#1}\right\rangle}
\newcommand{\homotopic}[0]{\simeq}
\newcommand{\injectivelim}[0]{\varinjlim}
\newcommand{\inner}[2]{{\left\langle {#1},~{#2} \right\rangle}}
\newcommand{\ip}[2]{{\left\langle {#1},~{#2} \right\rangle}}
\newcommand{\union}[0]{\cup}
\newcommand{\Union}[0]{\bigcup}
\newcommand{\intersect}[0]{\cap}
\newcommand{\Intersect}[0]{\bigcap}
\newcommand{\into}[0]{\to}
\newcommand{\inv}[0]{^{-1}}
\newcommand{\mfa}[0]{{\mathfrak{a}}}
\newcommand{\mfb}[0]{{\mathfrak{b}}}
\newcommand{\mfc}[0]{{\mathfrak{c}}}
\newcommand{\mff}[0]{{\mathfrak{f}}}
\newcommand{\mfi}[0]{{\mathfrak{I}}}
\newcommand{\mfm}[0]{{\mathfrak{m}}}
\newcommand{\mfn}[0]{{\mathfrak{n}}}
\newcommand{\mfp}[0]{{\mathfrak{p}}}
\newcommand{\mfq}[0]{{\mathfrak{q}}}
\newcommand{\mfr}[0]{{\mathfrak{r}}}
\newcommand{\lieb}[0]{{\mathfrak{b}}}
\newcommand{\liegl}[0]{{\mathfrak{gl}}}
\newcommand{\lieg}[0]{{\mathfrak{g}}}
\newcommand{\lieh}[0]{{\mathfrak{h}}}
\newcommand{\lien}[0]{{\mathfrak{n}}}
\newcommand{\liesl}[0]{{\mathfrak{sl}}}
\newcommand{\lieso}[0]{{\mathfrak{so}}}
\newcommand{\liesp}[0]{{\mathfrak{sp}}}
\newcommand{\lieu}[0]{{\mathfrak{u}}}
\newcommand{\Lie}[0]{\operatorname{Lie}}
\newcommand{\nilrad}[0]{{\mathfrak{N}}}
\newcommand{\jacobsonrad}[0]{{\mathfrak{J}}}
\newcommand{\mm}[0]{{\mathfrak{m}}}
\newcommand{\pr}[0]{{\operatorname{pr}}}
\newcommand{\mapsvia}[1]{\xrightarrow{#1}}
\newcommand{\fromvia}[1]{\xleftarrow{#1}}
\newcommand{\mapstovia}[1]{\xmapsto{#1}}
\newcommand{\ms}[0]{\xrightarrow{\sim}}
\newcommand{\from}[0]{\leftarrow}
\newcommand{\mapstofrom}[0]{\rightleftharpoons}
\DeclareMathOperator*{\mapbackforth}{\rightleftharpoons}
\newcommand{\mapscorrespond}[2]{\mathrel{\operatorname*{\rightleftharpoons}_{#1}^{#2}}}
\newcommand{\injects}[0]{\hookrightarrow}
\newcommand{\injectsvia}[1]{\xhookrightarrow{#1}}
\newcommand{\surjects}[0]{\twoheadrightarrow}
\newcommand{\surjectsvia}[2][]{
  \xrightarrow[#1]{#2}\mathrel{\mkern-14mu}\rightarrow
}
\newcommand{\adjoint}[0]{\leftrightarrows}
\newcommand{\kx}[1]{k[x_1, \cdots, x_{#1}]}
\newcommand{\kxn}[0]{k[x_1, \cdots, x_{n}]}
\newcommand{\MM}[0]{{\mathcal{M}}}
\newcommand{\OO}[0]{{\mathcal{O}}}
\newcommand{\OX}[0]{{\mathcal{O}_X}}
\newcommand{\imaginarypart}[1]{{\mathcal{Im}({#1})}}
\newcommand{\mca}[0]{{\mathcal{A}}}
\newcommand{\mcb}[0]{{\mathcal{B}}}
\newcommand{\mcc}[0]{{\mathcal{C}}}
\newcommand{\mcd}[0]{{\mathcal{D}}}
\newcommand{\mce}[0]{{\mathcal{E}}}
\newcommand{\mcf}[0]{{\mathcal{F}}}
\newcommand{\mcg}[0]{{\mathcal{G}}}
\newcommand{\mch}[0]{{\mathcal{H}}}
\newcommand{\mci}[0]{{\mathcal{I}}}
\newcommand{\mcj}[0]{{\mathcal{J}}}
\newcommand{\mck}[0]{{\mathcal{K}}}
\newcommand{\mcl}[0]{{\mathcal{L}}}
\newcommand{\mcm}[0]{{\mathcal{M}}}
\newcommand{\mcp}[0]{{\mathcal{P}}}
\newcommand{\mcs}[0]{{\mathcal{S}}}
\newcommand{\mct}[0]{{\mathcal{T}}}
\newcommand{\mcu}[0]{{\mathcal{U}}}
\newcommand{\mcv}[0]{{\mathcal{V}}}
\newcommand{\mcx}[0]{{\mathcal{X}}}
\newcommand{\mcz}[0]{{\mathcal{Z}}}
\newcommand{\kfq}[0]{K_{/\mathbb{F}_q}}
\newcommand{\cl}[0]{\operatorname{cl}}
\newcommand{\Cl}[0]{\operatorname{Cl}}
\newcommand{\St}[0]{\operatorname{St}}
\newcommand{\trdeg}[0]{\operatorname{trdeg}}
\newcommand{\dist}[0]{\operatorname{dist}}
\newcommand{\Dist}[0]{\operatorname{Dist}}
\newcommand{\crit}[0]{\operatorname{crit}}
\newcommand{\diam}[0]{{\operatorname{diam}}}
\newcommand{\gal}[0]{\operatorname{Gal}}
\newcommand{\diff}[0]{\operatorname{Diff}}
\newcommand{\diag}[0]{\operatorname{diag}}
\newcommand{\soc}[0]{\operatorname{Soc}}
\newcommand{\hd}[0]{\operatorname{Head}}
\newcommand{\grad}[0]{\operatorname{grad}}
\newcommand{\hilb}[0]{\operatorname{Hilb}}
\newcommand{\minpoly}[0]{{\operatorname{minpoly}}}
\newcommand{\Hom}[0]{{\operatorname{Hom}}}
\newcommand{\shom}{\mathscr{H}\operatorname{\kern -3pt {\calligra\large om}}}
\newcommand{\Map}[0]{{\operatorname{Map}}}
\newcommand{\multinomial}[1]{\left(\!\!{#1}\!\!\right)}
\newcommand{\nil}[0]{{\operatorname{nil}}}
\newcommand{\normalneq}{\mathrel{\reflectbox{$\trianglerightneq$}}}
\newcommand{\normal}[0]{{~\trianglelefteq~}}
\newcommand{\norm}[1]{{\left\lVert {#1} \right\rVert}}
\newcommand{\pnorm}[2]{{\left\lVert {#1} \right\rVert}_{#2}}
\newcommand{\notdivides}[0]{\nmid}
\newcommand{\notimplies}[0]{\centernot\implies}
\newcommand{\onto}[0]{\twoheadhthtarrow}
\newcommand{\ord}[0]{{\operatorname{Ord}}}
\newcommand{\pic}[0]{{\operatorname{Pic}}}
\newcommand{\projectivelim}[0]{\varprojlim}
\newcommand{\rad}[0]{{\operatorname{rad}}}
\newcommand{\ralg}[0]{\operatorname{R-alg}}
\newcommand{\kalg}[0]{k\dash\operatorname{alg}}
\newcommand{\rank}[0]{\operatorname{rank}}
\newcommand{\realpart}[1]{{\mathcal{Re}({#1})}}
\newcommand{\Log}[0]{\operatorname{Log}}
\newcommand{\reg}[0]{\operatorname{Reg}}
\newcommand{\restrictionof}[2]{ {\left.{{#1}} \right|_{{#2}} } }
\newcommand{\ro}[2]{{ \left.{{#1}} \right|_{{#2}} }}
\newcommand{\rk}[0]{{\operatorname{rank}}}
\newcommand{\evalfrom}[0]{\Big|}
\renewcommand{\mod}{\pmod}
\newcommand{\rmod}[0]{{R\dash\operatorname{mod}}}
\newcommand{\mods}[1]{{{#1}\dash\operatorname{mod}}}
\newcommand{\modr}[0]{{\operatorname{mod}}}
\newcommand{\kmod}[0]{{k\dash\operatorname{mod}}}
\newcommand{\Mod}[0]{{\operatorname{Mod}}}
\newcommand{\rotate}[2]{{\style{display: inline-block; transform: rotate(#1deg)}{#2}}}
\newcommand{\selfmap}[0]{{\circlearrowleft}}
\newcommand{\semidirect}[0]{\rtimes}
\newcommand{\sgn}[0]{\operatorname{sgn}}
\newcommand{\sign}[0]{\operatorname{sign}}
\newcommand{\spanof}[0]{{\operatorname{span}}}
\newcommand{\spec}[0]{\operatorname{Spec}}
\newcommand{\mspec}[0]{\operatorname{mSpec}}
\newcommand{\Jac}[0]{\operatorname{Jac}}
\newcommand{\stab}[0]{{\operatorname{Stab}}}
\newcommand{\stirlingfirst}[2]{\genfrac{[}{]}{0pt}{}{#1}{#2}}
\newcommand{\stirling}[2]{\genfrac\{\}{0pt}{}{#1}{#2}}
\newcommand{\strike}[1]{{\enclose{horizontalstrike}{#1}}}
\newcommand{\suchthat}[0]{{~\mathrel{\Big|}~}}
\newcommand{\st}[0]{{~\mathrel{\Big|}~}}
\newcommand{\supp}[0]{{\operatorname{supp}}}
\newcommand{\sym}[0]{\operatorname{Sym}}
\newcommand{\Sym}[0]{\operatorname{Sym}}
\newcommand{\Wedge}[0]{\Lambda}
\newcommand{\tensor}[0]{\otimes}
\newcommand{\connectsum}[0]{\mathop{\Large \#}}
\newcommand{\theset}[1]{\left\{{#1}\right\}}
\newcommand{\ts}[1]{\left\{{#1}\right\}}
\newcommand{\infsum}[1]{\sum_{{#1=0}}^\infty}
\newcommand{\gens}[1]{\left\langle{#1}\right\rangle}
\newcommand{\thevector}[1]{{\left[ {#1} \right]}}
\newcommand{\tv}[1]{{\left[ {#1} \right]}}
\newcommand{\too}[1]{{\xrightarrow{#1}}}
\newcommand{\transverse}[0]{\pitchfork}
\newcommand{\trianglerightneq}{\mathrel{\ooalign{\raisebox{-0.5ex}{\reflectbox{\rotatebox{90}{$\nshortmid$}}}\cr$\triangleright$\cr}\mkern-3mu}}
\newcommand{\tr}[0]{\operatorname{Tr}}
\newcommand{\uniformlyconverges}[0]{\rightrightarrows}
\newcommand{\abuts}[0]{\Rightarrow}
\newcommand{\covers}[0]{\rightrightarrows}
\newcommand{\units}[0]{^{\times}}
\newcommand{\nonzero}[0]{^{\bullet}}
\newcommand{\wait}[0]{{\,\cdot\,}}
\newcommand{\wt}[0]{{\operatorname{wt}}}
\renewcommand{\bar}[1]{\mkern 1.5mu\overline{\mkern-1.5mu#1\mkern-1.5mu}\mkern 1.5mu}
\renewcommand{\div}[0]{\operatorname{Div}}
\newcommand{\Div}[0]{\operatorname{Div}}
\newcommand{\Prin}[0]{\operatorname{Prin}}
\newcommand{\Frac}[0]{\operatorname{Frac}}
\renewcommand{\hat}[1]{\widehat{#1}}
\renewcommand{\mid}[0]{\mathrel{\Big|}}
\renewcommand{\qed}[0]{\hfill\blacksquare}
\renewcommand{\too}[0]{\longrightarrow}
\renewcommand{\vector}[1]{\mathbf{#1}}
\newcommand*\dif{\mathop{}\!\operatorname{d}}
\newcommand{\ddt}{\tfrac{\dif}{\dif t}}
\newcommand{\ddx}{\tfrac{\dif}{\dif x}}
\renewcommand{\labelitemiii}{$\diamondsuit$}
\renewcommand{\labelitemiv}{$\diamondsuit$}
\newcommand\vecc[2]{\textcolor{#1}{\textbf{#2}}}
\newcommand*{\vertbar}{\rule[-1ex]{0.5pt}{2.5ex}}
\newcommand*{\horzbar}{\rule[.5ex]{2.5ex}{0.5pt}}
\newcommand\aug{\fboxsep=-\fboxrule\!\!\!\fbox{\strut}\!\!\!}
\newcommand\rref{\operatorname{RREF}}
\newcommand{\interior}[0]{^\circ}
\newcommand{\increasesto}[0]{\nearrow}
\newcommand{\decreasesto}[0]{\searrow}
\newcommand\jan{\operatorname{Jan}}
\DeclareMathOperator{\righttriplearrows} {{\; \tikz{ \foreach \y in {0, 0.1, 0.2} { \draw [-stealth] (0, \y) -- +(0.5, 0);}} \; }}
\DeclareMathOperator{\Exists}{\exists}
\DeclareMathOperator{\Forall}{\forall}
\DeclarePairedDelimiter{\ceil}{\lceil}{\rceil}
\DeclareMathOperator*{\hocolim}{hocolim}

\newcommand{\contains}[0]{\supseteq}
\newcommand{\containing}[0]{\supseteq}

\newcommand{\cat}[1]{\mathcal{#1}}
\newcommand{\thecat}[1]{\mathbf{#1}}
\newcommand{\sheaf}[1]{\operatorname{\mathcal{#1}}}

\newcommand\rrarrows{\rightrightarrows}
\newcommand\rrrarrows{
    \mathrel{\substack{\textstyle\rightarrow\\[-0.6ex]
        \textstyle\rightarrow \\[-0.6ex]
        \textstyle\rightarrow}}
}

\newcommand{\colim}{\operatornamewithlimits{\underset{\longrightarrow}{colim}}}


\newcommand\fp[1]{\underset{\scriptscriptstyle {#1} }{\times}}
\newcommand\ul[1]{\underline{#1}}

\newcommand\Hc[0]{{\check{H}}}
\newcommand\Cc[0]{{\check{C}}}

# References


## References 

- Stichtenoth[@stichtenoth_2009].

# Lecture 1: Field Theory Preliminaries

The main theorems in this course, in order of importance:

- The Riemann-Roch Theorem
- The Riemann-Hurwitz Formula

## Finite Generation of Fields

See Chapter 11 of Field Theory notes.

### Notion 1

:::{.definition title="Finitely Generated Field Extension"}
A field extension $\ell/k$ is *finitely generated* if there exists a finite set $x_1, \cdots, x_n \in \ell$ such that $\ell = k(x_1, \cdots, x_n)$ and $\ell$ is the smallest field extension of $k$.

Concretely, every element of $\ell$ is a quotient of the form ${p(x_1, \cdots, x_n) \over q(x_1, \cdots, x_n)}$ with $p, q\in k[x_1, \cdots, x_n]$.
:::

There are three different notions of finite generation for fields, the above is the weakest.

### Notion 2

The second is being finitely generated as an algebra:

:::{.definition title="Finitely Generated Algebras"}
For $R\subset S$ finitely generated algebras, $S$ is finitely generated over $R$ if every element of $S$ is a polynomial in $x_1, \cdots, x_n$, with coefficients in $R$, i.e. $S = R[x_1, \cdots, x_n]$.
:::

Note that this implies the previous definition, since anything that is a polynomial is also a quotient of polynomials.

### Notion 3

The final notion: $\ell/k$ is finite (finite degree) if $\ell$ is finitely generated as a $k\dash$module, i.e. a finite-dimensional $k\dash$vector space.


:::{.definition title="Rational Function Field"}
A *rational function field* is $k(t_1, \cdots, t_n) \da ff \qty{ k[t_1, \cdots, t_n]}$.
:::

Note that we can make a similar definition for infinitely many generators by taking a direct limit (here: union), and in fact every element will only involve finitely many generators.

:::{.exercise}
\envlist
a. Show $k(t) / k$ is finitely generated by notion (3) but not by (2).

b. Show that $k[t]/k$ is (2) but not (1).[^not_a_field]


c. Show that it is not possible for a **field** extension to satisfy (2) but not (1).[^hint_zariskis_lemma_111]


d. Show that if $\ell/k$ is finitely generated by (3) and algebraic, then it satisfies (1).


[^hint_zariskis_lemma_111]: 
Hint: Zariski's lemma.

[^not_a_field]: 
Note $k[t]$ is not a field.

:::


:::{.theorem title="Field Theory Notes 11.19"}
If $L/K/F$ are field extensions, then $L/F$ is finitely generated $\iff$ $K/F$ and $L/K$ are finitely generated.[^see_artin_tate_lemma]

[^see_artin_tate_lemma]: 
See Artin-Tate Lemma, this doesn't necessarily hold for general rings.

:::


:::{.definition title="Algebraically Independent"}
For $\ell/k$, a subset $\ts{x_i}\subset \ell$ is *algebraically independent* over $k$ if no finite subset satisfies a nonzero polynomial with $k$ coefficients.

In this case, $k[\ts{x_i}] / k$ is *purely transcendental* as a rational function field.
:::

:::{.theorem title="Existence of transcendence bases"}
For $\ell/k$ a field extension,

a. There exists a subset $\ts{x_i}\subset \ell$ algebraically independent over $k$ such that $\ell/k(\ts{x_i})$ is algebraic. 

b. If $\ts{y_t}$ is another set of algebraically independent elements such that $\ell/k(\ts{y_t})$ is algebraic, then $\abs{\ts{x_i}} = \abs{\ts{y_t}}$.
:::

Thus every field extension is algebraic over a purely transcendental extension.
A subset as above is called a *transcendence basis*, and every 2 such bases have the same cardinality.

We have a notion of generation (similar to "spanning"), independence, and bases, so there are analogies to linear algebra (e.g. every vector space has a basis, any two have the same cardinality).[^note_on_matroids_common_gen]

[^note_on_matroids_common_gen]: 
There is a common generalization: matroids.

The following notion will be analagous to that of dimension in linear algebra:

:::{.definition title="Transcendence Degree"}
The *transcendence degree* of $\ell/k$ is the cardinality of any transcendence basis.
:::

:::{.theorem title="Transcendence Degree is Additive in Towers"}
If $L/K/F$ are fields then $\trdeg(L/F) = \trdeg(K/F) + \trdeg(L/K)$.
:::

:::{.theorem title="Bounds on Transcendence Degree"}
Let $K/k$ be finitely degenerated, so $K = k(x_1, \cdots, x_n)$.
Then $\trdeg(K/k) \leq n$, with equality iff $K/k$ is purely transcendental.
:::

:::{.proof}
Suppose $K$ is monogenic, i.e. generated by one element. Then $\trdeg(F(x)/F) = \indic{x/F\text{ is transcendental}}$.

So the degree increases when a transcendental element is added, and doesn't change when $x$ is algebraic.

By additivity in towers, we take $k \injects k(x_1) \injects k(x_1, x_2) \injects \cdots \injects k(x_1, \cdots, x)n) = K$ to obtain a chain of length $n$. 
The transcendence degree is thus the number of indices $i$ such that $x_i$ is transcendental over $k(x_1, \cdots, x_{i-1})$.[^checking_span]

[^checking_span]: 
This is similar to checking if a vector is in the span of a collection of previous vectors.

:::

:::{.definition title="Function fields in $d$ variables"}
For $d\in\ZZ^{\geq 0}$, an extension $K/k$ is *a function field in $d$ variables* (i.e. of dimension $d$) if $K/k$ is finitely generated of transcendence degree $d$.
:::

:::{.remark}
The study of such fields is birational geometry over the ground field $k$.
$k=\CC$ is of modern interest, things get more difficult in other fields.
The case of $d=1$ is much easier: the function field will itself be the geometric object and everything will built from that.
Our main tool will be **valuation theory**, where valuations will correspond to points on the curve.
:::


## Case Study: The Lüroth Problem.

:::{.question}
For which fields $k$ and $d\in \ZZ^{\geq 0}$ is it true that if $k \subset \ell \subset k(t_1, \cdots, t_d)$ with $k(t_1 ,\cdots, t_d)/\ell$ finite then $\ell$ is purely transcendental?
:::

:::{.answer}
It's complicated, and depends on $d$ and $k$.
We have the following partial results.
:::

:::{.theorem title="Lüroth"}
True for $d=1$: For any $k\subset \ell \subset k(t)$, $\ell = k(x)$.
:::

:::{.theorem title="Castelnuovo"}
Also true for $d=2, k=\CC$.
:::

:::{.theorem title="Zariski"}
No if $d= 2$, $k=\bar k$, and $k$ is positive characteristic.
Also no if $d=2, k\neq \bar k$ in characteristic zero.
:::

:::{.theorem title="Clemens-Griffiths"}
No if $d\geq 3$ and $k= \CC$.
:::

:::{.remark}
Note that unirational need not imply rational for varieties.
:::

:::{.exercise}
Let $k$ be a field, $G$ a finite group with $G\injects S_n$ the Cayley embedding.
Then $S_n$ acts by permutation of variables on $k(t_1, \cdots, t_n)$, thus so does $G$.
Set $\ell \da k(t_1, \cdots, t_n)^G$ the fixed field, then by Artin's observation in Galois theory: if you have a finite field acting effectively by automorphisms on a field then taking the fixed field yields a galois extension with automorphism group $G$.

So $\aut(k(t_1, \cdots, t_n)/ \ell) = G$.A

a. Suppose $k=\QQ$, and show that an affirmative answer to the Lüroth problem implies an affirmative answer to the inverse galois problem for $\QQ$.

  > Hint: works for any field for which Hilbert's Irreducibility Theorem holds.

b. $\ell /\QQ$ need not be a rational function field, explore the literature on this: first example due to Swan with $\abs{G} = 47$.

c. Can still give many positive examples using the Shepherd-Todd Theorem.
:::

\todo[inline]{What's a global field?}

## Integrals Closures and Constant Fields

:::{.definition title="Integral Closure and Field of Constants"}
For $K/k$ a field extension, set $\kappa(K)$ to be the algebraic closure of $k$ in $K$, i.e. special case of *integral closure*.
If $K/k$ is finitely generated, then $\kappa(K)/k$ is finite degree.

Here $\kappa(K)$ is called the *field of constants*, and $K$ is also a function field over $\kappa(K)$.
:::

:::{.remark}
In practice, we don't want $\kappa(K)$ to be a proper extension of $k$. 
If this isn't the case, we replace considering $K/k$ by $K/\kappa(K)$.
If $K/k$ is finitely generated, then

\begin{tikzcd}
k \arrow[rr, "\text{finite}", hook] &  & \kappa(K) \arrow[rr, "\text{finitely generated}", hook] &  & K
\end{tikzcd}

Where we use the fact that from above, $\kappa(K)/k$ is finitely generated and algebraic and thus finite, and by a previous theorem, if $K/k$ is transcendental then $K/\kappa(K)$ is as well, and thus finitely generated.
Thus if you have a function field over $k$, you can replace $k$ by $\kappa(K)$ and regard $K$ as a function field over $\kappa(K)$ instead.
:::















# Lecture 1: Discussion and Review

## Valuations

- Transcendence bases
- Lüroth problem

For $K/k$ a one variable function field, if we want a curve $C/k$, what are the points?
We'll use *valuations*, see NT 2.1.
See also completions, residue fields.
If $R \subset K$ a field, $R$ is a *valuation ring* of $K$ if for all $x\in K\units$, at least one of $x, x^{-1} \in R$.

:::{.example}
The valuation rings of $\QQ$ are $\ZZ_{(p)}\da \ZZ[\ts{{1\over \ell} \st \ell\neq p}]$ for all primes $p$.
:::

See also *Krull valuations*, which take values in some totally ordered commutative group.

:::{.exercise}
Show that a valuation ring is a local ring, i.e. it has a unique maximal ideal.
:::

:::{.example}
Where does the log come from?

There is a $p\dash$adic valuation:
\[  
v: \QQ &\to \ZZ_{(p)} \\
{a\over b} = p^n {u \over v} &\mapsto n
.\]
 
Then we recover
\[  
\ZZ_{(p)} = \ts {x\in \QQ\units \st v_p(x) \geq 0} \union \ts{0} \\
\mfm_{(p)} = \ts {x\in \QQ\units \st v_p(x) > 0} \union \ts{0} \\
.\]

There is a $p\dash$adic norm
\[  
\abs{\wait}_p: \QQ &\to \RR \\
0 & \mapsto 0 \\
x &\mapsto p^{-n} = p^{-v_p(x)}
.\]

Then we get an ultrametric function, a non-archimedean function
\[  
d_p: \QQ^2 \to \RR \\
(x, y) &\mapsto \abs{x- y}_p
.\]

We then recover $v_p(x) = -\log_p \abs{x}_p$.[^See_NT1]

[^See_NT1]: 
See NT 1 notes for more details on valuations.

:::


## Places

For $A\subset K$ a subring of a field, we'll be interested in the place $\tilde \Sigma = \ts{\text{Valuation rings } R_v \text{ of } K} \st A \subset R_v \subsetneq K$.
Thus the valuation takes non-negative values on all elements of $K$.
Can equip this with a topology (the "Zariski" topology, not the usual one).
This is always quasicompact, and called the *Zariski-Riemann space*.
Can determine a sheaf of rings to make this a locally ringed space.

We can define an equivalence of valuations and define the set of *places* 
\[  
\Sigma(K/k) \da \ts{\text{Nontrivial valuations } v\in K \st v(x) \geq 0\, \forall x\in k\units}
,\]
which will be the points on the curve.
Here the Zariski topology will be the cofinite topology (which is not Hausdorff).
Scheme-theoretically, this is exactly the set of closed points on the curve.

:::{.definition title="Generic Points"}
A point $p\in X$ a topological space is a **generic point** iff its closure in $X$ is all of $X$.
:::

:::{.remark}
Note we will have unique models for curves, but this won't be the case for surfaces: blowing up a point will yield a birational but inequivalent surface.
:::

## Divisors

:::{.definition title="Divisor Group"}
The *divisor group* of $K$ is the free $\ZZ\dash$module on $\Sigma(K/k)$
:::

:::{.remark}
This comes with a degree map
\[  
\deg: \Div(K) \to \ZZ
\]
which need not be surjective.
:::

:::{.definition title="Principal Divisors"}
Consider the map
\[  
\phi_d: K\units &\to \Div(K) \\
f &\mapsto (f)
.\]
Then we define $\im \phi_d$ as the subgroup of **principal divisors**.
:::


:::{.definition title="Class Group"}
Define the **class group** of $K$ as 
\[  
\cl(K) \da \ts{\text{Divisors}} / \ts{\text{Principal divisors}} \da \Div(K) / \im \phi_d
.\]
:::

We can define the **class group** as divisors modulo principle divisors $\cl(K) = \Div(K) / \im(K\units)$ and the Riemann-Roch space $\mathcal{L}(D)$.
The Riemann-Roch theorem will then be a statement about $\dim \mathcal{L}(D)$.


# Lecture 2: Field Theory Preliminaries

## Base Extension

Given some object $A/k$ and $k\injects \ell$ is a field extension, we would like some extended object $A/\ell$.

:::{.example}
An *affine variety* $V/k$ is given by finitely many polynomials in $p_i \in k[t_1, \cdots, t_n]$, and base extension comes from the map $k[t_1, \cdots, t_n] \injects \ell[t_1, \cdots, t_n]$.
More algebraically, we have the affine coordinate ring over $k$ given by $k[V] = k[t_1,\cdots, t_n]/\gens{p_i}$, the ring of polynomial functions on the zero locus corresponding to this variety.
We can similarly replace $k$ be $\ell$ in this definition.
Here we can observe that $\ell[V] \cong k[V] \tensor_k \ell$.
:::

In general we have a map
\[  
\wait \tensor_k \ell & \\
\ts{k\dash\text{vector spaces}} &\to \ts{\ell\dash\text{vector spaces}} \\
\ts{k\dash\text{algebras}} &\to\ts{\ell\dash\text{algebras}}
.\]
This will be an exact functor on the category $k\dash\text{Vect}$, i.e. $\ell$ is a flat module.
Here everything is free, and free $\implies$ flat, so things work out nicely.

What about for function fields?
Since $k$ is a $k\dash$algebra, we can consider $k\tensor_k \ell$, however this need not be a field.
Note that tensor products of fields come up very often, but don't seem to be explicitly covered in classes!
We will broach this subject here.

:::{.exercise}
If $\ell/k$ is algebraic and $\ell\tensor_k \ell$ is a domain, the $\ell = k$.

:::

:::{.remark}
In other words, this is rarely a domain.
A hint: start with the monogenic case, and also reduce to the case where the extension is not just algebraic but finite.
:::

:::{.remark}
Tensor products of field extensions are still interesting: if $\ell/k$ is finite, it is galois $\iff$ $\ell \tensor_k \ell \cong \ell^{[\ell: k]}$.
So its dimension as an $\ell\dash$algebra is equal to the degree of $\ell/k$, so it splits as a product of copies of $\ell$.

We'd like the tensor product of a field to be a field, or at least a domain where we can take the fraction field and get a field.
This hints that we should not be tensoring algebraic extensions, but rather transcendental ones.
:::

:::{.exercise}
For $\ell/k$ a field extension,

a. Show $k(t) \tensor_k \ell$ is a domain with fraction field $\ell(t)$.

b. Show it is a field $\iff$ $\ell/k$ is algebraic.
:::

:::{.proposition title="FT 12.7, 12.8"}
Let $k_1, k_2 / k$ are field extensions, and suppose $k_1 \tensor_k k_2$ is a domain.
Then this is a field $\iff$ at least one of $k_1/k$ or $k_2/k$ is algebraic.[^reminder_def_field_exts]

[^reminder_def_field_exts]: 
Reminder: for $\ell/k$ and $\alpha\in \ell$ algebraic over $k$, then $k(\alpha) = k[\alpha]$.

:::

So we'll concentrate on when $K \tensor_k \ell$ is a domain.

## When Extensions Preserve Being a Domain

:::{.question}
What's the condition on a function field $K/k$ that guarantees this, i.e. when extending scalars from $k$ to $\ell$ still yields a domain?
:::

:::{.definition title="Base Change"}
If this remains a domain, we'll take the fraction field and call it the **base change**.
:::

:::{.exercise}
If $K/k$ is finitely generated (i.e. a function field) and $K\tensor_k \ell$ is a domain, then $ff(K\tensor_k \ell)/\ell$ is finitely generated.

:::

:::{.remark}
The point here is that if taking a function field and extending scalars still results in a domain, we'll call the result a function field as well.
Most of all, we want to base change to the algebraic closure.
We'll have issues if the constant field is not just $k$ itself:
:::

:::{.lemma}
If $K\tensor_k \bar k$ is a domain, then the constant field $\kappa(K) = k$.

:::

:::{.proof}
Use the fact that $\wait \tensor_k V$ is exact.
We then get an injection
\begin{tikzcd}
\kappa(K) \tensor_k \kappa(K) \ar[rr, hookrightarrow]\ar[rd, hookrightarrow] & &
K \tensor_k \bar k \\
& \kappa(K) \tensor_k \bar k\ar[ru, hookrightarrow] & 
\end{tikzcd} 
Here we use the injections $\kappa(K) \injects \bar k$ and $\kappa(K) \injects K$.

We now have an injection of $k\dash$algebras, and subrings of domains are domains. 
So apply the first exercise: the only way this can happen is if $\kappa(K) = k$.
:::


:::{.exercise title="the simplest possible case"}
Describe $\CC(t) \tensor_\RR \CC$, tensored as $\RR\dash$algebras.
:::

:::{.remark}
Won't be a domain by the lemma, and will instead be some $\CC(t)\dash$algebra of dimension 2.
:::

## Good Base Change For Function Fields

In order to have a good base change for our function fields, we want to constant extension to be trivial, i.e. $\kappa(K) = k$. 
This requires that the ground field be algebraically closed.

In this case, you might expect that extending scalars to the algebraic closure would yield a field again.
This is true in characteristic zero, but false in positive characteristic.

:::{.question title="a more precise one"}
If $\kappa(K) = k$, must $K\tensor_K \bar k$ be a field?
:::

If that's true and we're in positive characteristic, recalling the for an algebraic extension this being a field is equivalent to it being a domain. 
But if that's a domain, the tensor product of every algebraic extension must be a domain, which is why this is an important case.

If so, then $K\tensor_k k^{1\over p}$ is a field, where $k^{1\over p} \da k\qty{\ts{x^{1\over p} \st x\in k }}$ is obtained by adjoining all $p$th roots of all elements.
This is a purely inseparable extension.
The latter condition (this tensor product being a field) is one of several equivalent conditions for a field to be separable.[^inverting_frob]

[^inverting_frob]: 
Note that the frobenius maps $k^{1\over p} \surjects k$, so this is sort of like inverting this map.

:::{.remark}
Recall that $K/k$ is transcendental, and there is an extended notion of separability for non-algebraic extensions.
Another equivalent condition is that every finitely generated subextension is separably generated, i.e. it admits a transcendence basis $\ts{x_i}$ such that $k\injects k(\ts{x_i}) \injects F$ where $F/k(\ts{x_i})$ is algebraic and separable.
Such a transcendence basis is called a *separating transcendence basis*.
Since we're only looking at finitely generated extensions, we wont' have to worry much about the difference between separable and separably generated.
:::


:::{.question}
What's the point? 
There's an extra technical condition to ensure the base change is a field: the function field being separable over the ground field.
Is this necessarily the case if $\kappa(K) = k$? 
:::

:::{.answer}
No, for fairly technical reasons.
\lmargnote{\danger}
:::


:::{.example ref="technical_example"}
Set $k = \FF_p(a, b)$ a rational function field in two variables as the ground field.
Set 
\[  
A \da k[x, y]/ \gens{ax^p + b-y^b}
.\]
Then $A$ is a domain, so set $k = ff(A)$.

:::{.claim}
$\kappa(K) = k$, so $k$ is algebraically closed in this extension, but $K/k$ is *not* separable.
:::

How to show: extending scalars to $k^{1\over p}$ does not yield a domain.

Let $\alpha, \beta \in \bar k$ such that $\alpha^p = a, \beta^b = b$, so
\[  
ax^p + b-y^b = (\alpha x + \beta - y)^p
,\]
which implies $K \tensor_k  k^{1\over p}$ is not a domain: $k[x, y]$ is a UFD, so the quotient of a polynomial is a domain iff the polynomial is irreducible.
However, the $p$th power map is a homomorphism, and this exhibits the image of the defining polynomial as something non-irreducible.
:::

:::{.remark}
Note that $f(x, y) = ax^p + b - y^p$ is the curve in this situation.
The one variable function field is defined by quotienting out a function in two variables and taking the function field.
Every 1-variable function field can be obtained in this way.
Therefore this polynomial is irreducible, but becomes reducible over the algebraic closure.
So we'd like the polynomial to be irreducible over both.
:::

:::{.remark}
This is pretty technical, but we won't have to worry if $k = k^{1\over p}$. 
Equivalently, frobenius is surjective on $k$, i.e. $k$ is a perfect field.

If $k$ is not perfect, it can happen (famous paper of Tate) making an inseparable base extension can decrease the genus of the curve.
:::

Recall that the perfect fields are given by:

- Anything characteristic zero, every reducible polynomial is separable.
- Any algebraically closed field 
- Finite fields (frobenius is always injective)

Imperfect fields include:

- Function fields in characteristic $p$
- Complete discretely valued fields $k((t))$ in characteristic $p$ [^recall_ntii_definitions]

[^recall_ntii_definitions]: 
This is a good time to review valuations and uniformizing elements from NTII.

:::{.theorem title="FT 12.20: Regular Field Extensions"}
For field extensions $K/k$, TFAE

1. $\kappa(K) = k$ and $K/k$ is separable

2. $K\tensor_k \bar k$ is a domain, or equivalently a field

3. For all field extensions $\ell/k$, $K\tensor_k \ell$ is a domain.

:::

:::{.remark}
Note that this allows making not just an algebraic base change, but a totally arbitrary one.
:::

:::{.definition title="?"}
A field extension satisfying these conditions is called **regular**.
:::


:::{.remark}
Regular corresponds to "nonsingular" in this neck of the woods.
The implication $2\implies 3$ is the interesting one.
To prove it, reduces to showing that if $k= \bar k$ and $R_i$ are domains that are finitely generated as $k\dash$algebras, then $R_1 \tensor_k R_2$ is also a domain.
This doesn't always happen, e.g. $\QQ(\sqrt{2}) \tensor_\QQ \QQ(\sqrt{2})$ is not a domain.
Really need algebraically closed.

This is a result in affine algebraic geometry.
An algebra that is a domain and finitely generated over a field is an *affine algebraic variety*, more precisely it is integral.
The tensor product on the coordinate ring side corresponds to taking the product of varieties.
Thus the fact here is that a product of integral varieties remains integral, as long as you're over an algebraically closed field.
Proof uses Hilbert's Nullstellensatz.
:::


:::{.exercise}
\envlist
a. Show that $k(t) / k$ is regular. [^means_to_be_regular_1]

b. Show every purely transcendental extension is regular.

c. Show that for a field $k$, every extension is regular $\iff$ $k = \bar k$.

d. Show $K/k$ is regular $\iff$ every finitely generated subextension is regular.


[^means_to_be_regular_1]: 
I.e. $k(t)\tensor_k \bar k$ is a domain.

:::

## Example of a Non-Regular Family of Function Fields

Choose an elliptic curve $E/\QQ(t)$ with $j\dash$invariant $t$.
For $N\in \ZZ^{+}$, define $\tilde K_N \da \QQ(t)(E[N])$ the $N\dash$torsion field of $E$.
Then $\tilde K_N/\QQ(t)$ is a finite galois extension with galois group isomorphic to the image of the modular galois representation [^see_proof_flt]

\[  
\rho_N: g(\QQ(t)) \to \GL(2, \ZZ/N\ZZ) \mod N
.\]

[^see_proof_flt]: 
See Cornell-Silverman-Stevens covering the proof of FLT, modular curves from the function field perspective.

:::{.proposition title="Some Facts"}
$\rho_N$ is surjective, and 
\[  
\Aut(\tilde K_N / \QQ(t))  \cong \GL(2, \ZZ/N\ZZ)
.\]

$\det \rho_N = \chi_N \mod N$, the cyclotomic character, and therefore $\chi_N$ restricted to $g(\tilde K_N)$ is trivial, so $\tilde K_N \supset \QQ(\zeta_N)$.
For $N\geq 3$, $\QQ(\zeta_N) \supsetneq \QQ$, so $\tilde K_N / \QQ(t)$ is a non-regular function field.
:::

:::{.remark}
Actually $\tilde K_N$ depends on the choice of $E$: difference choices of nonisomorphic curves with the same $j\dash$invariant differ by a quadratic twist and the $\rho_N$ differ by a quadratic character on $g(\QQ(t))$.
Importantly, this changes the kernel, and thus the field.
:::

To fix this, we look at the *reduced galois representation*, the following composition:
\[  
\bar \rho_N: g(\QQ(t)) \to \GL(2, \ZZ/N\ZZ) \surjects \GL(2, \ZZ/N\ZZ)/\ts{\pm I}
.\]

We obtain a field theory diagram
\begin{center}
\begin{tikzcd}
\ar[dd, bend right, "{\GL(2, \ZZ/N\ZZ)}"'] \bar K_N \ar[d, bend left, "\ts{\pm I}"] &\\
K_N \ar[d, bend left, "{\GL(2, \ZZ/N\ZZ)/\ts{\pm I}}"] &\\
\QQ(t)&
\end{tikzcd}
\end{center}

So if you just take the field fixed by $\pm I$, you get $K_N$.
In this case, the reduced galois representation depends only on the $j\dash$invariant, and not on the model chosen.
So the function field $K_N/\QQ(t)$ is the "canonical" choice.

:::{.question}
Does this make $K_N/\QQ(t)$ regular?
:::

:::{.answer}
No, $\rho_N(g(K_N)) = \ts{\pm I}$ and $\det(\pm I) = 1$, so we still have $K_N \supset \QQ(\zeta_N)$.
:::


In this course, we'll identify algebraic curves over $k$ and one-variable function fields $K/k$.
The function field $K_N$ corresponds to an algebraic curve $X(N)/\QQ$ that is "nicer" over $\QQ(\zeta_N)$.
In fact, see Rohrlich: $\kappa(K_N) = \QQ(\zeta_N)$.
Our curves will have points (equal to valuations) which will have degrees. 
If the constant subfield is not just $k$, this prevents degree 1 points on the curve.
By Galois theory, for every subgroup $H \subseteq \GL(2, \ZZ/N\ZZ) / \ts{\pm I}$, we'll get a function field $\QQ(H) \da H_N^H$.gg
In this case, $\QQ(H)/\QQ$ is regular $\iff$ $\det(H) = (\ZZ/N\ZZ)\units$.

Later we'll understand the residues at points as the residue fields of some DVRs, then the residue field will always contain the field of constants.






# Lecture 3: Last of Preliminaries

Today we'll be wrapping up the last of the preliminaries.
Upcoming: one-variable function fields and their valuation rings.

## Polynomials Defining Regular Function Fields

:::{.question}
Where's the curve in all of this?
:::

:::{.answer}
This will come from an equation like $f(x, y) = 0$.
:::

:::{.exercise}
Let $R_1, R_2$ be $k\dash$algebras that are also domains with fraction fields $K_i$.
Show $R_1 \tensor_k R_2$ is a domain $\iff$ $K_1 \tensor_k K_2$ is a domain.[^hint_for_exc1]

[^hint_for_exc1]: Hint: use a denominator clearing argument.

:::

## Geometric Irreducibility

:::{.definition title="Geometrically Irreducible Polynomial"}
A polynomial of positive degree $f\in k[t_1, \cdots, t_n]$ is **geometrically irreducible** if $f\in \bar k[t_1, \cdots, t_n]$ is irreducible as a polynomial.
:::

:::{.remark}
If $n=1$ then $f$ is geometrically irreducible $\iff$ $f$ is linear, i.e. of degree 1.
Let $f$ be irreducible, then since polynomial rings are UFDs then $\gens{f}$ is a prime ideal (irreducibles generate principal ideals) and $k[t_1, \cdots, t_n]/\gens{f}$ is a domain.
Let $K_f$ be the fraction field.
:::

:::{.exercise title="an easy one"}
\envlist
a. Above for $1\leq i \leq n$ let $x_i$ be the image of $t_i$ in $K_f$.
  Show that $K_f = k(x_1, \cdots, x_n)$.

b. Show that if $K/k$ is generated by $x_1, \cdots, x_n$, then it is the fraction field of $k[t_1, \cdots, t_n] /\mfp$ for some prime ideal $\mfp$ (equivalently, a height 1 ideal).
:::

:::{.proposition title="?"}
Suppose that $f$ is geometrically irreducible.

a. The function field $K/k$ is regular.

b. For all $\ell/k$, $f\in \ell[t_1, \cdots, t_n]$ is irreducible.

:::

:::{.definition title="Absolutely Irreducible Polynomial"}
In this case we say $f$ is **absolutely irreducible** as a synonym for geometrically irreducible.
:::

:::{.proof}
By definition of geometric irreducibility, $\bar k[t_1, \cdots, t_n]/\gens{f} = k[t_1, \cdots, t_n]/\gens{f} \tensor_k \bar k$ is a domain.
The exercise shows that $K_f \tensor_k k$ is a domain, so $K_f$ is regular.
It follows that for all $\ell/k$, $K_f \tensor_k \ell$ is a domain, so $\ell[t_1, \cdots, t_n]/\gens{f}$ is a domain.
:::

:::{.slogan}
Geometrically irreducible polynomials are good sources of regular function fields.
:::

:::{.exercise}
Let $k$ be a field, $d\in \ZZ^+$ such that $4\notdivides d$ and $p(x) \in k[x]$ be positive degree.
Factor $p(x) = \prod_{i=1}^r (x-a_i)^{\ell_i}$ in $\bar k[x]$.

a. Suppose that for some $i$, $d\notdivides \ell_i$. 
  Show that $f(x, y) \da y^d - p(x) \in k[x, y]$ is geometrically irreducible.
  Conclude that $K_f \da ff\qty{k[x, y] / \gens{y^d - p(x)}}$ is a regular one-variable function field over $k$, and thus elliptic curves yield regular function fields.[^hint_and_comment_on_exercise]

b. What happens when $4\divides d$?

[^hint_and_comment_on_exercise]: 
Referred to as *hyperelliptic* or *superelliptic* function fields.
Hint: use FT 9.21 or Lang's Algebra.

:::


:::{.exercise title="Nice, Recommended"}
Assume $k$ is a field, if necessary assuming $\ch(k) \neq 2$.

a. Let $f(x, y) = x^2 - y^2 -1$ and show $K_f$ is is rational: $K_f = k(z)$.

b. Let $f(x, y) = x^2 + y^2 - 1$.
  Show that $K_f$ is again rational.

c. Let $k = \CC$ and $f(x, y) = x^2 + y^2 + 1$, $K_f$ is rational.

d. Let $k= \RR$.
  For $f(x ,y) = x^2 + y^2 + 1$, is $K_f$ rational?[^example_genus_zero]

[^example_genus_zero]: 
This is an example of a non-rational genus zero function field.

:::

:::{.question}
Can we always construct regular function fields using geometrically irreducible polynomials?
:::

:::{.answer}
In several variables, no, since not every variety is birational to a hypersurface.
In one variable, yes, as the following theorem shows:
:::

## Our Function Fields are Geometrically Irreducible

:::{.theorem title="Regular Function Fields in One Variable are Geometrically Irreducible"}
Let $K/k$ be a one variable function field (finitely generated, transcendence degree one). 
Then

a. If $K/k$ is separable, then $K = k(x, y)$ for some $x, y\in K$.

b. If $K/k$ is regular (separable + constant subfield is $k$, so stronger) then $K \cong K_f$ for a geometrically irreducible $f\in k[x ,y]$.
:::

Recall separable implies there exists a separating transcendence basis.

:::{.proof title="of a"}
This means there exists a primitive element $x\in K$ such that $K/k(x)$ is finite and separable.
By the Primitive Element Corollary (FT 7.2), there exist a $y\in K$ such that $K = k(x, y)$.
:::

:::{.proof title="of b"}
Omitted for now, slightly technical.
:::

:::{.remark}
Importance of last result: a regular function field on one variable corresponds to a nice geometrically irreducible polynomial $f$.
:::

:::{.remark}
Note that the plane curve module may not be smooth, and in fact usually is not possible.
I.e. $k[x ,y]/\gens{f}$ is a one-dimensional noetherian domain, which need not be integrally closed.
:::

:::{.question}
Can every one variable function field be 2-generated?
:::

:::{.answer}
Yes, as long as the ground field is perfect.
In positive characteristic, the suspicion is no: there exists finite inseparable extensions $\ell/k$ that need arbitrarily many generators.
However, what if $K/k$ has constant field $k$ but is not separable?
Riemann-Roch may have something to say about this.
:::

:::{.example}
\hyperref[technical_example]{Example from earlier lecture:}
\[
ax^p + b - y^b
\]
:::


:::{.remark}
We can find examples of nice function fields by taking irreducible polynomials in two variables.
This will define a one-variable function field.
If the polynomial is geometrical reducible, this produces regular function fields.
:::


# Lecture 4: Chapter 1, One Variable Function Fields and Their Valuations

Since we have the field-theoretic preliminaries out of the way, we now start studying one-variable function fields in earnest.
The main technique that we use to extract the geometry will be the theory of valuations.
These may be familiar from NTII, but we will cover them in more generality here.

## Valuation Rings and Krull Valuations

Recall that NTII approach to valuations:

:::{.definition title="Valuation"}
A **valuation** on a field $K$ is a map $v:K\to \RR\union \ts\infty$ such that $v(K\units) \subset \RR$, $v(0) = \infty$, and $v$ is of the form $-\log(\abs{\wait})$ where $\abs{\wait}: K \to [0, \infty)$ is an *ultrametric norm*.[^efficient_valuation]
Recall that an *ultrametric norm* satisfies not only the triangle inequality but the ultrametric triangle inequality, i.e. $d(x, z) \leq \max(x, z)$.

[^efficient_valuation]: In other words, $e^{-v(\wait)}$ is an ultrametric norm.

:::

We now take an algebraic approach to this definition, where we'll end up replacing $\RR$ with something more general.

:::{.definition title="Valuation Ring"}
A subring $R$ of a field $K$ is a **valuation ring** if for all $x\in K\units$, at least one of $x$ or $x^{-1}$ is in $R$.
:::

:::{.remark}
This is a "largeness" property. 
It also implies that $K = \ff(R)$.
:::

## Group of Divisibility

:::{.definition title="Group of Divisibility"}
Given any integral domain $R$ with fraction field $K$, the **group of divisibility** $G(R)$ is defined as the *partially ordered commutative group*[^compatibility_note]

\[  
G(R) \da K\units / R\units
.\]
We will write the group law here additively.
The ordering is given by $x\leq y \iff y/x \in R$.

[^compatibility_note]: This means that the two structures are compatible.

:::

:::{.remark}
Note that the way the partial order is written, it's a relation on $K\units$, but it is not quite a partial ordering there.
It is reflexive and transitive, but need not be antireflexive: if $x/y, y/x\in R$ then $x,y$ differ by an element of $u\in R\units$ so that $x=uy$.
In particular, they need not be equal.
This gives a structure of a *quasiordering*, and if you set $x\sim y \iff x\leq y$ and $y\leq x$, this leads to an equivalence relation, and modding out by it yields a partial order.
Here this is accomplished by essentially trivializing units.
\

Another way to think of $G(R)$ is as the nonzero principal fractional ideals of $K$, since any two generators of an ideal will differ by a unit.
:::

:::{.remark}
Inside this group there is a *positive cone* $G(R)^+$ of elements that are "nonnegative": since we're in a commutative setting, the zero element is equal to 1, and the positive cone is given by $\ts{y\geq 0} = \ts{y\in R}$, and is thus given by the group $G(R)^+ = (R, \cdot)$.
\

This is very general: if you're studying factorization in integral domains, many properties are reflected in $G(R)$.
E.g. being a UFD (the most important factorization property!) implies that $G(R)$ is a free commutative group.
:::

:::{.remark}

In general this is only a *partially* ordered group and not totally ordered. 
For example, take $R = \ZZ$ and $x=2, y=3$, then neither of $2/3, 3/2$ are in $\ZZ$, so $x\not\leq y$ and $y\not\leq x$.
On the other hand, if we do have a total order, then either $x$ or $x^{-1}$ is in the ring, which are exactly valuation subring of a field.
:::

:::{.claim}
$R$ is a valuation ring $\iff$ $G(R)$ is totally ordered.
:::

:::{.remark}
Note that $\RR$ is a totally ordered group.
:::

## Generalized Valuations

This makes $G(R)$ the "target group" of a generalized analytic valuation.
Whenever we have a valuation ring, we have a totally ordered commutative group, and the valuation $v: K\units \to G(R)$ is a quotient map which we can extend to $K$ by $v(0) \da \infty$.
This has some familiar properties:

- (VRK1) For all $x,y\in K\units$,[^just_a_group_hopmp]

\[  
v(xy) = v(x) + v(y)
.\]

- (VRK2) For all $x,y \in K\units$ such that $x+y\neq 0$,
\[  
v(x+y) \geq \min(v(x), v(y))
.\]

[^just_a_group_hopmp]: This follows from the fact that the quotient map is a group morphism.
Note that the additive notation makes this more suggestive of what an original valuation satisfied.

For ultrametric norms, all triangles are isosceles: is that true for this type of function?
The answer is yes, by the following exercise: 

:::{.exercise title="?"}
If $v(x) \neq v(y)$, then $v(x+y) = \min(v(x), v(y))$.
:::

So the properties here are formally identical to the NTII notion of valuation, with $(\RR, +, \leq)$ replaced by $(G(R), +, \leq)$.

:::{.exercise title="?"}
Conversely, if $v: K\units \to G$ is a map into a totally ordered commutative group satisfying VRK1 and VRK2[^krull_valuation], then
\[  
R_v \da \ts {x\in K\units \st v(x) \geq 0} \union \ts{0}
\]
is a valuation ring.[^exc_hint_num1]
We can thus extract valuation rings in this situation.

[^krull_valuation]: Any such map satisfying these two properties is a **Krull valuation**, Krull's generalization of classical valuations.

[^exc_hint_num1]: Note that in a totally ordered group, either $v(x) \geq 0$ or $-v(x) \geq 0$, so we get the property that either $x, x^{-1} \in R_v$.

:::


:::{.exercise title="?"}
A valuation ring is **local**, i.e. there is a unique maximal ideal
\[  
\mathfrak{m}_v \da \ts{x\in K\units \st v(x) > 0} \union \ts{0}
.\]
:::

:::{.remark}
These two constructions are morally mutually inverse.
This doesn't hold on the nose, since there is extraneous data in the new analytic valuation.
Recall that in NTII we have a notion of equivalence of norms, and two distinct norms that are equivalent can give rise to the same valuation.
For example, given a valuation, one can scale it by $\alpha \in \RR$, and it's easy to check that this gives the same valuation.
It is possible for the valuation not to surject onto $\RR$, but this doesn't happen in practice.
The image is usually infinite cyclic, what we call a *discrete valuation*, and so one is led to the definition of the *value group* of the valuation as its image.
If you have a notion of equivalence of Krull valuations, you want to allow for isomorphisms of the value group.
The cleanest notion of equivalence is thus the following:
:::

:::{.definition title="Equivalence of Krull valuations"}
Two Krull valuations on a field $K$ are **equivalent** iff their valuation rings are *equal*.
:::

:::{.remark}
Going back to NTII, if you have two nonarchimedean norms on a field, then there are many equivalent conditions for equivalence, and this is one of them.
:::

Some general valuation theory:

- Every totally ordered commutative group is a group of divisibility.[^tot_ord_comm_div]

- A totally ordered group has **rank 1** if it is nontrivial and embeds into $\RR$
  - If the value group is trivial, $R = K$

- A Krull valuation of rank at most 1 is the NTII notion of a valuation.

[^tot_ord_comm_div]: Pete's Commutative Algebra Notes, Ch. 17.10
 

:::{.exercise title="?"}
For $n\geq 2$, put the lexicographic order on $\ZZ^n$, and show this has rank strictly larger than 1.
Thus $\ZZ^n\injects \RR$ as a commutative group, but not as a totally ordered commutative group.
:::

:::{.remark}
In fact, for any ordered group $G$, one can attach a rank: a cardinal number $r(G)$.
Here, $r((\ZZ^n, \text{lex})) = n$.
This is useful when studying $\spec(R)$ for $R$ a DVR.
:::

A valuation of rank bigger than 1 does not induce a norm on $K$ in the metric sense, although this is not so important.
A closer notion is expanding the notion of a metric space by allowing the metric to be defined on $X$ as $d: X\cross X \to R$ for some $R$ more general than $\RR$, like a totally ordered group or a nonarchimedean field.
This would yield a class of topological spaces that are reminiscent of metric spaces.

## Regular or Centered Valuations

:::{.definition title="Important: Regular and Centered"}
Let $v:K\units \to (G, +)$ be a Krull valuation and let $A \subset K$ be a subring of $K$.
Then $v$ is **$A\dash$regular** or **centered in $A$** if $A$ is a subset of some valuation ring $R_v$.
In this case, $\mathfrak{p} \da \mathfrak{m}_v \intersect A \in \spec(A)$ is denoted the **center of $v$ in $A$**.[^pullback_hom]

[^pullback_hom]: 
Here $\mathfrak{m}_v$ denotes pulling back the maximal ideal along this morphism of rings.

:::

:::{.remark}
The term regularity here arises because we'll want to think of elements of $A$ as functions and the valuation as a type of point, then the notion of being a regular function at a point will carry over.
The center is the subset of $A$ with strictly positive valuation.
Also recall that pulling back prime ideals yields prime ideals, and maximal ideals are a special kind of prime ideal, but in general pulling back a maximal ideal may not result in another maximal ideal.
So somehow the valuation affects every subring on which it is regular.
:::

:::{.definition title="Key: Zariski-Riemann Space"}
For $A \subset K$, define
\[  
\Sigma(K/A) &\da \ts{\text{valuation rings } A \subset R \subsetneq K \st K = \ff(R)} \\
\tilde \Sigma(K/A) &\da \ts{\text{valuation rings } A \subset R \subseteq K \st K = \ff(R)}
.\]
The set $\tilde \Sigma(K/A)$ is the **Zariski-Riemann space**.
:::

:::{.remark}
Note that in this definition, we're taking all $A\dash$regular valuation rings $R$ in $K$.
If someone says $R$ is a valuation ring of $K$, they likely mean that $K = \ff(R)$.
Note that fields are valuation rings, so otherwise, any subfield of $K$ would also be a valuation ring of $K$.
Here, $K$ itself plays the role of a generic point. (?)
The only difference in these two definitions is that in the first, the trivial valuation ring is being excluded.
:::

:::{.definition title="Key: Places, Points of a Curve"}
If $K/k$ is a one variable function field[^def_function_field_reminder]
, then $\Sigma(K/k)$ will be the **points of the associated algebraic curve** or **places**.
These can be thought of as valuation rings, or equivalence classes of Krull valuations, where two valuations are equivalent if they have the same valuation ring.

[^def_function_field_reminder]: Finitely generated field extension of transcendence degree one.

:::

:::{.remark}
In terms of scheme theory, these will be the closed points of our algebraic curve.
We will view elements $f\in K$ as meromorphic functions on $\Sigma(K/k)$.
:::

## Topological Considerations

:::{.definition title="Zariski Topology"}
The **Zariski topology** on $\Sigma(K/A)$ has a sub-base
\[  
\ts{U(f) \st f\in K } && U(f) \da \ts{v\in \tilde \Sigma(K/A) \st v(f) \geq 0} = \tilde \Sigma(K/ A[f])
.\]
and we thus take the minimal topology such that all of these sets are open.
In other words, every open set is a finite intersection and/or arbitrary unions, including empty intersections/unions.
The last term is precisely the subring generated by $A$ and $f$.
Thus a base is $U(f_1, \cdots, f_n) = \tilde \Sigma(K / A[f_1, \cdots, f_n])$.
The Zariski topology on $\Sigma(K/A)$ is defined the same way and/or via the subspace topology, since this removes a single point.
:::

:::{.remark}
We thus get the subrings of $K$ that contain $A$ and are finitely generated as $A\dash$algebras.
We'll be specifically looking at the case where $A$ is a field and $K$ is a one variable function field.
:::

:::{.theorem title="Zariski"}
$\tilde \Sigma(K/A)$ is quasi-compact.
:::

:::{.proof title="?"}
See Mazamara (?) in the chapter discussing valuation rings.
:::

Note that by definition, $v_n \not\in \Sigma(K/A)$.
In $\tilde \Sigma(K/A)$, we have a trivial valuation $v_n$ whose value group is trivial and valuation ring is $K$ itself, and $v_n$ is a generic point of $\Sigma(K/A)$: its closure is the entire space.
In other words, it is in every nonempty open subset.
Since we have at least one generic point, and in general there may be many, if $\abs{\tilde\Sigma(K/A) > 1}$ then this is not a separated ($T_1$) space since the point is not closed.[^French_note_separated]
Another example of such a space would be $\spec(R)$ for $R$ a commutative ring with positive Krull dimension, which will be Kolmogorov ($T_0$) but not separated.
Such a spectrum is the underlying topological space of some affine scheme, and in general, schemes will have these kinds of properties that are bad (but not *too* bad).

[^French_note_separated]: Note that in French, separated may be interpreted as Hausdorff, but here we mean points are closed or equivalently any two distinct points admit open neighborhoods that do not meet the other point.

In our case of interest, when $K/k$ is finitely generated of transcendence degree one, we'll see that this is the cofinite topology on an infinite space: the proper closed subsets are precisely the finite subsets, or equivalently every nonempty open subset has finite complement.
This is far from Hausdorff: the intersection of two open subsets will still have finite complement, so any two nonempty open subsets must intersect.
\

It's not generally true that just removing the generic point $v_n$ will make the space separated, but in our case, it will be.
So if we restrict to nontrivial valuation rings, then the underlying set will be infinite and we'll get the cofinite topology.
This will be the coarsest separated topology, i.e. if you want singletons to be closed, finite subsets must be closed.
If $k \subset A \subset K$ where $A$ is a Dedekind domain with fraction field $K$, we will see that if we consider not the $k\dash$regular elements but the $A\dash$regular ones, we'll get $\Sigma(K/A) = \maxspec(A)$ and both Zariski topologies are cofinite.
Note that in a Dedekind domain, trading in a prime spectrum for a max spectrum is removing a generic point, so this matches up.
The moral: the topology of $\Sigma(K/k)$ is not doing anything interesting and we won't need it much.

## Scheme Theory, Resolution of Singularities

When $K/k$ instead has transcendence degree *bigger* than 1, then $\tilde \Sigma(K/k)$ is much more interesting.
If we were doing things scheme-theoretically, we could try to define a structure sheaf: attaching a sheaf whose stalks are local commutative rings to make it a locally ringed space.[^Schemes_in_rings_spaces]
Here, the choice of a ring is straightforward: literally $\tilde \Sigma(A, A[f_1, \cdots, f_n])$.
There's an exercise that shows that although defining a sheaf on the entire space is somewhat annoying, defining it on a basis suffices.

:::{.exercise title="?"}
Endow $\tilde \Sigma(K/k)$ with the structure of a locally ringed space.
:::

:::{.remark}
In dimension 1 (the case we're studying), the corresponding Zariski-Riemann space will be the scheme associated to the complete nonsingular model of the curve.
So this valuation-theoretic approach will take you from the function field back to a nice model of the scheme itself.
But note that in larger dimensions, there is no unique complete nonsingular model -- for example, you can blow any one up to get another -- so this pattern can't possibly continue to hold.
In fact, it's not clear if we even know if there's *one* such model!
:::

[^Schemes_in_rings_spaces]: Schemes are a full subcategory of the much larger category of locally ringed spaces.


:::{.remark}
Thus in dimension $>1$, you get something that is decidedly not a scheme, but is still relevant to the study of resolution of singularities for your function field.
Where do these come up?
Zariski used $\Sigma(K/A)$ to prove resolution of singularities [^resolution_of_singularities]
in characteristic zero and dimensions 2 and 3 in 1944, although dimension 2 was classical by the Italian school.
Later, Hironaka (1984) got the Fields medal for proving resolution of singularities for all dimensions in characteristic zero using an ingenious inductive argument that avoided Zariski-Riemann spaces entirely.
It remarkably doesn't use any new objects/tools, just uses existing ones in a clever way.
So why talk about Zariski-Riemann spaces at all?
In the last 10 years or so, work of Ternkin and Conrad has revived and generalized them.
They study *relative* such spaces.

[^resolution_of_singularities]: Resolving means given $K/k$, we want to find a complete nonsingular affine variety whose function field is $K$.

:::

:::{.problem title="Open"}
In positive characteristic, resolution of singularities is only known up to dimension $\leq 3$.
:::

## Intermediate Rings

The following is an extremely important result from commutative algebra:

:::{.theorem title="CA 17.17"}
Let $A \subset K$ be a subring of a field, then 
\[  
\intersect_{v\in \tilde \Sigma(K/A)} R_v
,\]
the intersection of all valuation subrings of the field, is the integral closure of $A$ in $K$.
:::

The proof is mostly a Zorn's lemma type of argument.
Note that each $R_v$ is generally big, contains $A$, and $\ff(R_v) = K$.
Moreover, each valuation ring is integrally closed, although we haven't proved this yet.

:::{.corollary title="?"}
For $K/k$  function field, $\intersect_{v\in \Sigma(K/k)} R_v = \kappa(K)$, the constant subfield of $K$.
:::


:::{.proof title="?"}
Note that $\kappa(K)$ is the integral (algebraic) closure of $k$ in $K$.
Applying the theorem directly almost works, except the theorem involves $\tilde \Sigma$.
Can we remove the tilde?
Suppose not, this can only happen if $\Sigma(K/k) = \emptyset$ and the intersection is just $K$ itself, the largest thing in the intersection.
But can the integral closure of $k$ in $K$ be $K$ itself?
No, since the transcendence degree of the function field is positive.
So $K/k$ is transcendental, while $\kappa(K) / k$ is an algebraic extension, a contradiction.
:::

:::{.remark}
Note that $\Sigma(K/k)$ is nonempty: there is a nontrivial valuation ring between $k$ and $K$ in great generality, and there are often many.
:::


:::{.claim title="Key"}
If $\trdeg(K/k) = 1$, then every $v\in \Sigma(K/k)$ is discrete and thus has value group isomorphic to $\ZZ$.
:::

So despite the fact that we've introduced a more general notion of higher rank valuations, in dimension 1, every single valuation is discrete.


:::{.proof title="?"}
Let $v\in \Sigma(K/k)$ be a place, so its a valuation ring with fraction field $K$ that is not $K$, then $R_v$ is not a field.
So its maximal ideal $\mathfrak{m}_v$ is nonzero, so choose a nonzero element $t\in \mathfrak{m}_v$.
Then $t \in R_v$ and $R_v$ contains $k$, so $k[t] \subset R_v$.
Note that $k[t]$ is a PID sitting inside a valuation ring.
So restrict this maximal ideal down: $\mathfrak{m}_v \intersect k[t]$ is a prime ideal of $k[t]$ containing $t$, and thus the center $\mathfrak{m}_v \intersect k[t] = \gens{t}$.
This follows because a prime ideal in the polynomial ring $k[t]$ which contains $t$ is necessarily generated by $t$, since there's exactly one such ideal.
\

Now restricting the valuation on $K$ to $k(t) \subset K$, $K / k(t)$ will be a finite extension (from the first lecture).
We know $k(t) \subset K$, and we can now check that $\ro{v}{k(t)}$ is the $t\dash$adic valuation $v_t$.
Note that $\mathfrak{m}_v$ can not contain any other monic irreducible polynomials, since distinct such polynomials are coprime. 
Since we're in a PID, this ideal would contain any linear combination of them and thus contain 1.
So consider the map
\[  
k[t] \injects R_b \to G(R_v) = K\units / R\units
.\]
Note that the units of $k[t]$ map trivially, using the fact that any element in $k[t]$ can be written as $u \prod p_i^{a_i}$ with the $p_i$ monic irreducible polynomials. 
The unit maps to zero, along with all of the other monic irreducibles, and thus the image is determined entirely by the image of powers of $t$.
This whole term goes to zero unless some $p_i\mapsto t$, in which case it maps to some power of $t$.
\

So suppose $t\mapsto \gamma \neq 0\in G(R)$, which is nonzero because $t$ was not a unit (since it was in the maximal ideal).
Then the image is exactly $\gamma^\NN$, the non-negative integer powers of the image of $t$.
But if we know goes on this domain, taking denominators shows where it goes on the fraction field (of a UFD), so the image is the cyclic group generated by $\gamma$, i.e. the powers of $t$ are literally the only valuations we get.
So the image of $k(t)\units$ in $G(R_v)$ is $\gamma^\ZZ$, yielding a discrete valuation.
This proves that the restriction to the rational function field $k(t)$ is discrete, and we want to use this to deduce that the original valuation is discrete.
\

We can now use NTII:[^petes_notes_note] since $K/k(t)$ is finite, it follows that $v$ is discrete iff $\ro{v}{k(t)}$ is discrete, and thus $v$ is discrete.

[^petes_notes_note]: See NTII, Corollary 1.60: a valuation on a field whose restriction to a finite index subfield is discrete is itself discrete.

:::

## Valuations of Every Rank

So every place of $K/k$ is a discrete valuation as long as the transcendence degree is one, but this is far from the case for degree $\geq 2$!
In the following example, we'll have a rational function field, which makes things easier. 
You need a theory of extending Krull valuations, since we'll define a non-rank 1 valuation on the rational function field.
But an arbitrary finitely generated field extension of degree $d$ over $k$ is a finite degree extension of the rational function field, and valuation theory will tell you that every valuation downstairs can be extended in full generality to a finite degree field extension, and the rank will not change.

:::{.exercise title="?"}
If $K/k$ is finitely generated of $\trdeg \geq 2$, then $\Sigma(K/k)$ has valuations of rank $d$.
:::

Note that the Zariski-Riemann space only consists of discrete valuations, which is a characteristic property of one variable function fields.
So these higher rank valuations may look weird, but when studying a function field of higher transcendence degree (e.g. for an algebraic surface), these occur.

:::{.exercise title="Constructing valuations of arbitrary rank and value group"}
Let $k$ be a field and $K = k(t_1, \cdots, t_n)$.
Set $G = \ZZ^n$ with the lex order, so $G^{\geq 0} = \NN^n$.

- Show that $k[t_1, \cdots, t_n] = k[G^{\geq 0}]$, where the RHS is the associated semigroup ring.

- Define $v: k[G^{\geq 0}]\nonzero \to G^{\geq 0}$ by mapping each polynomial the minimal index of a monomial in its support.
  For example,
  \[  
  v(a_1 t_1^3 t_2 + a_2 t_1^2 t_2^{10})  = (2, 10)
  ,\]
  which has support $(3, 1)$ and $(2, 10)$, and we take the min in the lex order.

- Extend $v$ to $v: K\nonzero \surjects G$ satisfying VRK1 and VRK2.
  Show that $R_v \da v^{-1}(G^{\geq 0}) \union\ts{0}$ is a valuation ring with value group $G$, and in particular, the rank is $n$.

:::

Note that doing this for $n=1$ reduces to the $t\dash$adic valuation, which just keeps track of the smallest power of $t$ appearing.
Here you can extend to fraction fields by defining $v(x/y) = v(x) - v(y)$.
The semigroup ring can't *be* the valuation ring, since polynomial rings are not local rings, so it's much bigger.
Note also that $\ZZ$ can be replaced with any group $G$, since it's never used in anything but a psychological fashion.

:::{.slogan}
There is a huge difference between $\trdeg = 1$ and $\trdeg > 1$, and so we'll only be working with the former case in this course.
:::

# Lecture 5: Places

:::{.definition title="Affine Domain"}
An **affine domain** $R$ over a field $k$ is a domain that is finitely generated as a $k\dash$algebra.
:::

## Investigating the Set of Places

We saw an interesting example of a function field in more than one variable which showed that valuations of rank larger than 1 can arise, but this does not happen for one variable function fields.
That is, for $K/k$ of transcendence degree 1, all valuations on $K$ which are trivial on $k$ are discrete.
We'll now want to go farther and describe the places $\Sigma(K/k)$, which will be the set of points on an algebraic curve.
Scheme-theoretically, this will literally be the set of closed points on a certain projective curve whose function field is $K$.
Note that a priori, finding closed points on a curve over an arbitrary field is hard!

Recall that if $A$ is a Dedekind domain such that $\ff(A) = K$, then for all $\mathfrak{p}\in \mspec(A)$ there exists a discrete valuation $v_p$ on $K$.
I.e., every maximal ideal induces a discrete valuation that is $A\dash$regular, so the valuation ring will contain $A$.
How is this obtained?
Take a nonzero $x\in K\units$, and take the corresponding principal fractional ideal $\gens{x} \da Ax$, which we can factor in a Dedekind domain as $Ax = \prod_{\mathfrak{p} \in \mspec(A)} \mathfrak{p}^{\alpha_{\mathfrak{p}}}$ with $\alpha_{\mathfrak{p}} \in \ZZ$.
This looks like an infinite product, but for any fixed $x$, only finitely many $\alpha$ are nonzero.
Note that these $\alpha$ are exactly what we're looking for: the $\mathfrak{p}\dash$adic evaluation of $x$ is given precisely by $v_{\mathfrak{p}}(x) \da \alpha_{\mathfrak{p}}$, where we are using unique factorization of ideals in Dedekind domains.
Thus we have a map
\[  
v_{\wait}: \mspec(A) &\to \Sigma(K/A) \\
\mathfrak{p} &\mapsto v_{\mathfrak{p}}
.\]

So this sends a maximal ideal to a place that is $A\dash$regular, and it turns out to be a bijection.

:::{.proposition title="?"}
The map $v$ is a bijection, and thus we may write
\[  
\Sigma(K/A) \cong \mspec(A)
.\]
:::

:::{.proof title="?"}
:::{.claim}
$v$ is injective.
:::
If $\mathfrak{p}_1, \mathfrak{p}_2 \in \mspec(A)$ are two different maximal ideals.
Then there exists an element $x\in \mathfrak{p}_1 \sm \mathfrak{p}_2$, and so $x^{-1} \in A_{\mathfrak{p}_2} \sm A_{\mathfrak{p}_1}$.
This follows since if $x$ is not in $\mathfrak{p}_2$, its $\mathfrak{p}_2\dash$adic valuation is zero, and thus the $\mathfrak{p}_2\dash$adic valuation of $x^{-1}$ is $-0 = 0$ as well.
On the other hand, since $x\in \mathfrak{p}_1$, its $\mathfrak{p}_1\dash$adic valuation is positive and therefore $v_{\mathfrak{p}_1}(x^{-1}) < 0$ and $x^{-1}$ is not in $A_{\mathfrak{p}_1}$.

:::{.claim}
$v$ is surjective.
:::
Let $v\in \Sigma(K/A)$, so $A \subset R_v$, i.e. take a valuation whose valuation ring contains $A$.
Note that we're not assuming the valuation is discrete, this can be a general Krull valuation, but we're trying to show it's equal to a certain $p\dash$adic valuation.
As always with a subring of a valuation ring, we can pull back the maximal ideal and consider $\mathfrak{m}_v \intersect A \in \spec(A)$.
We're hoping that this is a maximal ideal, since maximals correspond to valuations.
Since we're in a Dedekind domain, the only prime ideal we *don't* want this to be is the zero ideal of $A$, so suppose it were.
Then $A\nonzero \subset R_v\units$, and so $K\units \subset R_v\units$.
This is because the only element of the maximal ideal that lies in $A$ is zero, so every nonzero element of $A$ is not in this maximal ideal and is thus a unit.
But for any unit, its inverse is also a unit, yielding the inclusion $K\units \subset R_v\units$.
The only way this could possibly happen is if $R_v = K$, which yields the trivial valuation ring.
However, by definition, in $\Sigma(K/A)$ we've excluded the trivial valuation, so this ideal can not be zero.
\

So we can conclude that the pullback $\mathfrak{m}_v \intersect A \in \mspec(A)$, and so $A_{\mathfrak{p}} \subset R_v$.
This is from viewing elements in $A_{\mathfrak{p}}$ as quotients of elements in $A$ whose denominator have $\mathfrak{p}\dash$adic valuation zero.
Recall that we want to show that $R_v = A_{\mathfrak{p}}$.
We know $R_v \subset K$ is a proper containment, and we can use the fact that a *discrete* valuation ring is maximal among all proper subrings of its fraction field.
In other words, for $R$ a DVR, there is no ring $R'$ such that $R \subset R' \subset \ff(R)$.
How do you prove this?
This is similar to an early exercise in commutative algebra, where we looked at all rings between $\ZZ$ and $\QQ$, which generalized to looking at all rings between a PID and its fraction field, and a DVR is a local PID.
So proving this statement is actually easier.
\

This is enough to show that $A_{\mathfrak{p}} = R_v$, and this $v\sim v_{\mathfrak{p}}$.
:::

:::{.remark}
What the idea?
For a general one variable function field $K/k$, we'll produce affine Dedekind domains $R$ with $k \subset R \subset K$ and $\ff(R) = K$.
This will give is subrings of this full ring of places that are $\mspec$ of Dedekind domains.
How many such domains will we need for their union to be the entire set of places?
Just one won't work, since $\Sigma(K/k)$ is like a complete or projective object, and a projective variety of dimension 1 can't be covered by a single affine variety.
However, it turns out that you can always cover it with 2.
In fact, if you take any Dedekind domain between $k$ and $\ff(K)$, the set of missing places (the ones that aren't regular for any of these domains) will be a nonempty finite set of places.
So you can always cover it by finitely many, and two suffices: as a consequence of the Riemann-Roch theorem, after removing any nonempty finite set of places, you'll have the $\mspec$ of a canonically associated Dedekind domain.
We'll prove this by starting with the case of $K = k(t)$.
:::

:::{.claim}
\[  
\abs{ \Sigma(k(t)/k) \sm \mspec k[t] } = 1
.\]
:::

:::{.question}
Note that $k \subset k[t] \subset k(t)$ and $k[t]$ is a Dedekind domain, so this fits into the above framework, and moreover we know the maximal ideals of polynomial rings: irreducible monic polynomials.
Taking all of these misses exactly one place.

How do we describe this missing place?
:::

## Describing the Missing Place

Suppose $v \in \Sigma(k(t) / k) \sm  \Sigma(k(t) / k[t])$, so the valuation ring of $v$ contains $k$ but does not contain $k[t]$.
Then the valuation ring can not contain $t$, and thus $v(t) < 0$ and $v(1/t) = -v(t) > 0$.
Since $k[1/t]$ is a PID, so if the valuation wasn't $t
dash$regular, it's $1/t\dash$regular by definition.
So $v\in \Sigma(k(t) / k[1/t])$.
Note that $k[1/t] \cong k[t]$ as rings.
How many valuations on this polynomial ring give positive valuation to $1/t$? 
Exactly one, since this corresponds to a prime ideal, namely $\gens{1/t}$, so this unique valuation is $v = v_{1 \over t}$, the $1/t\dash$adic valuation.

That is, if we write $f\in k(t)$ as $(1/t)^n a(1/t)/b(1/t)$ with $a, b\in k[t]$ polynomials with nonzero constant terms, then $v_{1\over t}(f) = n$.
Note that this process is the same as the one used to compute the $t\dash$adic valuation $v_t$.

Recall that a valuation on a domain can be uniquely extended to its fraction field by setting $v(x/y) = v(x) - v(y)$.

:::{.exercise title="?"}
Define $v_\infty: k(t)\units \to \ZZ$ by $p(t)/q(t) \mapsto \deg q - \deg p$.

a. Show $v_ \infty \in \Sigma(k(t) / k[1/t])$.

b. Show $v_ \infty \sim v_{1\over t}$ by showing they have the same valuation ring.

c. Show that $v_ \infty = v_{1\over t}$.

::: 

Note that $1/t$ is a uniformizer for $v_ \infty$

:::{.theorem title="Complete description of places"}
\[  
\Sigma(k(t) / k) = \mspec k[t] \disjoint \ts{v_ \infty}
.\]
:::

Note that we know the maximal ideals -- the irreducible monic polynomials -- but it takes some effort to write them down.
If $k$ is algebraically closed, however, every such polynomial is linear of the form $t-\alpha$ for $\alpha\in k$.
In this case, $\mspec k(t) \cong k$, and so $\sigma( \bar k (t) / \bar k) = \bar k \disjoint \ts{\infty} = \PP^1(\bar k)$.
More generally, the set of places on a rational function field will yield the scheme-theoretic set of closed points on the projective line over $k$, which is more complicated if $k\neq \bar k$ since not all closed points are $k\dash$rational.
Another way to say this is that if you have a valuation, there is a residue field, and for any place on a one variable function field the residue field will be a finite degree extension of $k$.
The degree 1 points will be the $k\dash$rational points, and so $\Sigma(k(t) / k)$ will always contain a copy of $k$ but may have closed points of larger degree, making things slightly more complicated.
This complication is handled well in both the scheme-theoretic and this valuation-theoretic approach.

## Finite Generation in Towers


The next theorem is a fact from commutative algebra:

:::{.theorem title="?"}
Let $A$ be a domain with $\ff(A) = K$.
Suppose $A$ is a finitely generated $k\dash$algebra, let $L/K$ be a finite degree field extension, and let $B$ be the integral closure of $A$ in $L$.
Then

a. $B$ is finitely generated as an $A\dash$module.[^second_normalization_theorem_ref]

[^second_normalization_theorem_ref]: See CA notes, "Second Normalization Theorem", where normalization is a more geometric synonym for integral closure.

b. $B$ is an integrally closed domain with $\ff(B) = L$ which is finitely generated as a $k\dash$algebra.

c. $\dim A = \dim B$[^Krull_dim_note]

[^Krull_dim_note]: Krull dimension, i.e. the supremum of lengths of chains of prime ideals.

d. If $A$ is Dedekind, so is $B$.

:::


:::{.proof title="?"}
See Pete's CA notes sections 18 and 14.
:::

:::{.remark}
On why these should be true: we have a NTI square

\begin{tikzcd}
	{B} && {L} \\
	\\
	{A} && {K} \\
  \\
  {k} && {} 
	\arrow[from=3-1, to=1-1, hook]
	\arrow[from=3-3, to=1-3, hook]
	\arrow[from=1-1, to=1-3, hook, "\subset"]
	\arrow[from=3-1, to=3-3, hook, "\subset"]
  \arrow[from=5-1, to=3-1, hook]
\end{tikzcd}

We have a domain $A$ with a fraction field $K$, we take a finite degree extension $L/K$, and to complete the square we let $B$ be the integral closure of $A$ in $L$: the collection of elements in $L$ satisfying monic  polynomials with coefficients in $A$.
\

In our case, we're additionally assuming that $A/k$ is finitely generated as a $k\dash$algebra.
:::

:::{.remark}
\envlist
On (b): $B$ being finitely generated as a $k\dash$algebra follows from assuming $A$ is, and additionally that $B$ is finitely generated as an $A\dash$module, and finite generation as a module provides finite generation as an algebra.
The result follows from transitivity of finite generation of algebras.

On (c): This is just a property of integral extensions.

On (d): Use the characterization of being Noetherian, integrally closed, and Krull dimension 1.
The only thing to check is that $B$ is Noetherian, which follows from $B$ being finitely generated as a $k\dash$algebra and applying the Hilbert basis theorem.
:::


:::{.remark}
Note that we are not assuming that $L/K$ is separable, which is an assumption that would simplify things.
By the Krull-Akuzuki theorem, $B$ will always be a Dedekind domain, but it need not be finitely generated over $A$.
So the "stem" to $k$ is grounding the situation: it's not just a Dedekind domain, but rather an *affine* domain: a domain that is finitely generated over a field.
Note that this is much better than an arbitrary Dedekind domain!
:::

## Regularity Lemma

:::{.proposition title="Regularity Lemma" ref="lemma:regularity"}
Suppose that instead of $K = \ff(A)$, we instead have $A \subset K$ an arbitrary subring, and $L/K$ a finite extension.
Taking the integral closure $B$ yields another NTI square:

\begin{tikzcd}
B\ar[r, "\subset", hook] & L \\
A\ar[r, "\text{subring}", hook]\ar[u, hook] & K \ar[u, hook]  
\end{tikzcd}

Suppose we have an upstairs valuation $v$ on $L$.
Then it makes sense to restrict valuations to subfields, so
\[  
v\in \Sigma(L/B) \iff \ro{v}{K} \in \Sigma(K/A)
.\]
So the original valuation is $B\dash$regular iff the restricted valuation is $A\dash$regular.
::: 

:::{.proof title="?"}
$\impliedby$:
Since $A \subseteq B$, being $B\dash$regular implies being $A\dash$regular.
\

$\implies$:
Suppose $A \subset R_v$ and $x\in B$, and choose $a_0, \cdots, a_{n-1} \in A$ such that
\[  
p(x) \da x^n + a_{n-1}x^{n-1} + \cdots + a_1 x + a_0 = 0
.\]
We can do this precisely because $B$ is integral over $A$.
So we have an integral relation for $x$, and we want to show $v(x) < 0$ and derive some contradiction from the fact that $v(a_i) \geq 0$.
Note that we aren't grounded to the base field here, so this valuation may not be discrete and is rather some arbitrary Krull valuation.
\

If $x\not \in R_v$, then $v(x) < 0$, and we can thus write
\[  
v(x^n) < \min \ts{ v(a_j x^j) \st 0\leq j \leq n-1 } \leq v(p(x))
.\]
This follows because the first term is $nv(x)$, and so the next term can only be *less* negative since $v(a_j) > 0$.
But this is a contradiction, since we know $v(x^n) = v(- \sum_{j=0}^{n-1} a_j x^j)$, and we've exhibited two elements that differ by a unit ($u=-1$) which have different valuations.
:::

Next, let $K/k$ be a one variable function, we want to give a nice description of its places.
We already described the places of a *rational* function field, and we know we can write the former function fields as finite degree extensions of the latter.
Choosing a transcendental $t\in K$, to $K/k(t)$ is a finite extension, restricting evaluations gives a map
\[  
r: \Sigma(K/k) \to \Sigma(k(t)/ k)
.\]

:::{.claim}
This is surjective with finite fibers, so it acts like a branched covering map.
:::

This follows from NTI or NTII.
The NTI method is taking an extension of Dedekind domains, taking a prime ideal downstairs, and pushing it forward to see how it factors upstairs.
The NTII method is a field with a valuation and an extension of the field and you try to figure out how many ways the downstairs valuation can be extended.
If the valuations are discrete, these are the same problem.

## An Inequality on Degrees

:::{.theorem title="Degree Inequality (NTII, 1.3)"}
Let $K$ be a field with $v$ a rank one valuation with valuation ring $R$.
Let $L/K$ be a finite extension of degree $n$.
Then the set of valuations on $L$ extending $v$ is finite and nonempty, say $\ts{w_1, \cdots, w_g}$.

For $1\leq i \leq g$, define
\[  
e_i(L/K) &\da \abs{ w_j (L\units) \over v(K\units) }  && \text{ramification index} \\
f_i(L/K) &\da [R_{w_i}/\mathfrak{m}_{w_i} : R_v/ \mathfrak{m}_v] && \text{residual degree}
,\]
so $e_i, f_i \in \ZZ{>0}$.
Then

a. We have a useful inequality:
\[  
\sum_{i=1}^g e_i(L/K) f_i(L/K) \leq [L: K] = n
.\]

b. If $v$ is discrete[^it_will_be] and the integral closure $S$ of $R$ in $L$ is finitely generated as an $R\dash$module, then this is an equality.

[^it_will_be]: It will be discrete in our case.
Note that this finiteness condition always holds if $L/K$ is separable.

:::

:::{.remark}
Note that a valuation can be extended in at least one way over *any* field extension, finite or not.
For finite extensions, there's a more precise statement involving completing and taking a tensor product, then identifying number of valuations with the size of some $\mspec$ over a finite-dimensional algebra over the field.

NTII shows that $e_i$ is a finite number by looking at the exponent of the pushforward.
Also note that we view $\mathfrak{m}_{w_i}$ as an ideal lying over $\mathfrak{m}_v$, and there is an inclusion of residue fields $R_v/\mathfrak{m}_v \injects R_{w_i} / \mathfrak{m}_{w_i}$ which is in fact a finite degree field extension.
:::


:::{.remark}
Part (a) already shows that $r$ is surjective with fibers of cardinality at most $[L: K]$, but we want equality.
We claim is always holds when $K/k$ is a one variable function field and $v\in \Sigma(K/k)$.
There are examples where the inequality is strict, however.
In our situation, it's not just an arbitrary extension, we have the aforementioned affine "grounding" phenomenon, and all of these DVRs are going to be localizations of affine Dedekind domains.
This is the key fact: arbitrary extensions of Dedekind domains are nowhere near as nice as those where the bottom one is finitely generated over a field.

:::

:::{.proof title="First step"}
We have a discrete valuation $v$ on $K$, so let $t$ be a uniformizing element[^uniformizer] for $v$.
Then the argument is that any such uniformizer $t$ is transcendental over $k$.
We'll do this by arguing $t\not\in k$ and then that $t$ is not algebraic over $k$ either.

Since we're assuming $v$ is $k\dash$regular, $t\in k \implies 1/t\in k$ and so $v(1/t) \geq 0$, since every element in $k$ should have nonnegative valuation.
But we're supposed to have $v(t) = 1$ by definition of being a uniformizer, so $t$ can not be in $k$.

Suppose that $t$ is algebraic over $k$, then $k(t)/k$ is an integral extension, since we're adjoining one algebraic element. 
By the previous proposition we have that $v$ is $k(t)\dash$regular, since being regular is preserved by integral extensions.
But now rerunning the argument in the previous paragraph shows that this is a contradiction: being $k(t)\dash$regular would force $v(1/t) \geq 0$, but we'd still need $v(1/t) = -1$.

So $t$ is transcendental over $k$, and $k[t]$ is a polynomial ring.

[^uniformizer]: An element of valuation one.

:::

:::{.proof title="Second step"}
Let 

- $A$ be the integral closure of $k[t]$ in $K$, and
- $B$ be the integral closure of $k[t]$ in $L$.

Instead of a NTI square, we'll have the following 3-step diagram:
\begin{tikzcd}
k[t] \ar[d, hook, "\subset"] \ar[r, hook, "\subset"] & A\ar[d, hook, "\subset"] \ar[r, hook, "\subset"] & B\ar[d, hook, "\subset"] \\
k(t) \ar[r, hook, "\subset"] & K\ar[r, hook, "\subset"] & L \\
\end{tikzcd}

So $A$ is a Dedekind domain with $\ff(A) = K$, as is $B$ with $\ff(B) = L$, making both $A$ and $B$ finitely generated $k[t]\dash$modules.
Why?
This comes from the theorem of finiteness of integral closure when the downstairs domain is grounded to a field.
Since $k[t]$ is finitely generated as a $k\dash$algebra, this finiteness applies, which tells us that $A$ finitely generated as a $k[t]\dash$module, as is $B$.
But if $B$ is finitely generated as a $k[t]\dash$module and $A\supseteq k[t]$ is an even larger ring, then $B$ is finitely generated as an $A\dash$module (potentially with fewer generators).

Thus $B$ is a finitely generated $A\dash$module, and $v$ is $k[t]\dash$regular since $t$ was a uniformizing element, making $v$ regular on both $k$ and $t$ and thus $k[t]$.
Then $v$ is also $A\dash$regular by the proposition, and thus $v = v_{\mathfrak{p}}$ for some $\mathfrak{p}\in \mspec(A)$ coming from our classification of $A\dash$regular valuations on a Dedekind domain.

So the valuation on $K$ is just the $\mathfrak{p}\dash$adic valuation on this Dedekind domain.
This means there is an equality of valuation rings $R = A_{\mathfrak{p}}$[^localization_at_p], the valuation ring of the Dedekind domain.
So we now consider $S$, the integral closure of $R$ in $L$.
This is a NTI situation, but the downstairs Dedekind domain is a DVR, so it's local downstairs.
We thus have compatibility between integral closure and localization in the form of $S = B_{\mathfrak{p}} = B \tensor_A A_{\mathfrak{p}}$.
This comes from taking the whole integral closure $B$, and only looking at the primes lying over $\mathfrak{p}$.
Base change preserves finite generation, and we know that $B$ was finitely generated as an $A\dash$module, so $S$ is finitely generated as an $A_{\mathfrak{p}}\dash$module and equality holds.


[^localization_at_p]: This is the localization at $\mathfrak{p}$.

:::

:::{.remark}
If $A_{\mathfrak{p}}$ was a *complete* DVR, as opposed to just some localization of an affine domain, $B$ will be a semilocal Dedekind domain and thus a PID, and again the number of primes it has will be the number of primes in the original Dedekind domain lying over the fixed prime $\mathfrak{p}$.
:::

:::{.remark}
We're not really using valuation theory here, and this could have been phrased purely in NTI language.
But even then, the degree inequality for extensions of Dedekind domains needs finite generated of the Dedekind domain as a module over the bottom Dedekind domain to ensure equality.
You'd need a suitably algebraic text that considers not necessarily separable $L/K$, and you really do want finite generation of $B$ over $A$ to make this work.
See Dino Lorenzini's textbook!
:::

:::{.exercise title="?"}
Let $K/k$ be a one variable function field, and show that the cardinality of the set of points is given by
\[  
\abs{\Sigma (K/k)} = \abs{\ts{ \text{monic irreducible polynomials } p \in k[t] }}  = \max( \abs{k}, \aleph_0 )
.\]
:::

:::{.remark}
If you know that $r$ is surjective with finite fibers, where the image is infinite (which it is here), the domain should be infinite of the same cardinality by an easy set-theoretic exercise.
Note that using Möbius inversion, over a finite field there is at least one irreducible polynomial of every degree, and finitely many of a fixed degree.
So the cardinality is $\aleph_0$ when $k$ is a finite field.
If we took a one variable function field over $\CC$, we would get the cardinality of the continuum.
In this case, $\Sigma(K/k)$ really is the set of points on some compact Riemann surface, although the Zariski topology will be too coarse to coincide with the induced Euclidean topology.
:::

:::{.remark}
Note that affine Dedekind domains are important for us because every finitely generated field extension of $k$ are precisely the fraction fields of affine domains over $k$, where the transcendence degree of the function field equals the Krull dimension of the affine domain.
We're especially interested in affine domains of dimension 1 over $k$.
We established something particularly important in this proof:
:::

## Affine Grounding and Residue Fields

:::{.lemma title="Affine Grounding"}
Let $K/k$ be a one variable function field and $v\in \Sigma(K/k)$ be a place on that function field.
Then there exists an affine Dedekind domain $A$ with $\ff(A) = K$ and a maximal ideal $\mathfrak{p}\in \mspec(A)$ such that $R_v = A_{\mathfrak{p}}$.
:::

Thus we should think of the set of places as the $\mspec$ of finitely many affine Dedekind domains glued together.
For each point (place), the basic open set around that point is the affine Dedekind domain.

:::{.corollary title="?"}
For $v \in \Sigma(K/k)$, define the **residue field** of the local ring $R_v$ as $k(v) \da R_v / \mathfrak{m}_v$.
Then $k(v)/ k$ is a finite degree extension.
:::

:::{.proof title="of corollary"}
If $R$ is a domain with maximal ideal $\mathfrak{p}$, then the quotient map factors through the localization, giving $R/\mathfrak{p} = R_{\mathfrak{p}} / \mathfrak{p} R_{\mathfrak{p}}$:[^comm_algebra_std_fact]


\begin{tikzcd}
R \ar[r]\ar[dr] & R_{\mathfrak{p}}\ar[d] \\
 & R/\mathfrak{p}
\end{tikzcd}

So by affine grounding, $k(v)$ is also $A/\mathfrak{p}$ where $A$ is an affine Dedekind domain and $\mathfrak{p}\in \mspec(A)$.
This is Zariski's lemma[^Zariskis_lemma] : we showed that $k(v) \cong A/\mathfrak{p}$, where $A$ is a finitely generated algebra and thus so are its quotients.
Thus $k(v)$ is not just finitely generated as a field extension, but also as a $k\dash$algebra, making $k(v)/k$ a finite extension.

[^comm_algebra_std_fact]: This is a truly standard fact from commutative algebra.


[^Zariskis_lemma]: A field extension that is finitely generated as an algebra is necessarily a finite degree extension.

:::

:::{.definition title="Degree of a Place"}
The **degree** of $v\in \Sigma(K/k)$ is $[k(v) : k] \in \ZZ^{\geq 0}$.
:::

We are especially interested in degree 1 places, i.e. those for which the residue field is equal to $k$ itself, so we denote these by $\Sigma_1(K/k)$.
In any other course, we'd call this $C(k)$, the rational points on the associated curve.

:::{.exercise title="Some motivation"}
Let $f\in k[x, y]$ be irreducible, so that $A \da k[x, y] / \gens{f}$ is a 1-dimensional affine domain[^not_nec_dedekind].
As above, the resude fields of maximal ideals are finite extensions of $k$.
Show that there is a correspondence
\[  
\correspond{\text{ Maximal ideals } \\ \mathfrak{p} \in \mspec(A)}
&\iff
\correspond{(x, y) \in k\cross k \st f(x, y) = 0}
.\]

[^not_nec_dedekind]: This may not necessarily be a Dedekind domain, since it need not be integrally closed.

:::

:::{.remark}
Note that the polynomial above may not define a smooth geometry, there may instead be singular points:

![Image](figures/image_2020-11-27-21-49-40.png)

These singular points are what stops $A$ from being integrally closed, which is literally true when $k$ is a perfect field.

:::

Whereas $\Sigma(K/k)$ is always infinite, $\Sigma_1(K/k)$ may be finite or even empty.
When $k = \QQ$, it may in fact be empty "most of the time"
When $k = \QQ$, it may in fact be empty "most of the time".

:::{.exercise title="?"}
For all $v\in \Sigma(K/k)$, the degree of the point $\deg(v)$ will be divisible by $[\kappa(K) : k]$.
Thus if $\kappa(L) \supsetneq k$, then $\Sigma_1(K/k) = \emptyset$.[^degree_big]

[^degree_big]: Use the fact that the degree will be bigger than 1 when the constant field is bigger than $k$.

:::

Note that before we were writing the residue field as an extension of $k$, and it's worth checking that the constant subfield embeds as a subfield of the residue field as well.

:::{.remark}
There is a tie to CM points on modular curves: if you have a function field over $\QQ$ which is not regular due to some proper algebraic subextension, the residue fields of all of the points on the curve will contain the algebraic closure of the field of definition.
Pete had some $\QQ(X_n)$ function field, whose constant subfield was $\QQ(\zeta_n)$ (adjoining the $n$th roots of unity), and none of these modular curves over $\QQ$ have closed points except when the residue fields contain $\QQ(\zeta_n)$.
:::

:::{.remark}
This is a way for there to not be points on the curve, so $\Sigma_1(K/k)$ is empty, but it's not the deepest reason -- this is a cheap trick to produce "pointless" function fields.
It can fail to have degree 1 places in many different ways!
:::

:::{.exercise title="?"}
Show that for for a one variable function field $K/k$ TFAE:

1. Every $v\in \Sigma(K/k)$ has degree 1,

2. $k$ is algebraically closed.

:::

:::{.remark}
One half is easy, since by definition the degree of the residue field is the degree of some finite extension of the base field, but if $k$ is algebraically closed, the degree of any finite extension is one.
:::

:::{.exercise title="?"}
For a field $k$, set $\PP^1(k) \da \PP(k^2)$, the projectivization of $k\cross k$, i.e. the lines through the origin in $\AA^2/k$.
By taking slopes of lines, $\PP^1(k) = k \disjoint \ts{\infty}$.

![Image](figures/image_2020-11-27-23-57-12.png){width=350px}

Show that $\Sigma_1(k(t)/k) = \PP^1(k)$, and deduce that
\[  
\Sigma(k(t)/k) = \PP^1(k) \iff k = \bar k
.\]
:::


Next up we'll talk about how the set of places is built from affine Dedekind domains.
After this, we'll be ready for chapter 2: divisors and Riemann-Roch.

# Lecture 6: Affine Domains and Places $\Sigma(K/k)$

The aim of this lecture is to explain the difference (including some technicalities) between $\Sigma(K/k)$ and affine Dedekind domains $R$ such that $K = \ff(R)$.


Recall that

- An **affine domain** over a field $k$ is a domain that is finitely generated as a $k\dash$algebra,[^rich_but_easy]


- An **affine Dedekind domain** is an affine domain that is also a Dedekind domain, so it is integrally closed and of Krull dimension 1,

- An **affine $k\dash$order** is a one-dimensional affine domain. [^order_is_noetherian]

[^order_is_noetherian]: These will be Noetherian by the Hilbert basis theorem, but may not be integrally closed.

[^rich_but_easy]: These are very rich but easier to understand: take a polynomial ring in finitely many variables and mod out by a prime ideal.

:::{.example title="?"}
If $f \in k[x, y]$ is irreducible, then $k[x, y]/\gens{f}$ is an affine $k\dash$order. 
It is an affine Dedekind domain if $f$ is *nonsingular* over $k$, i.e. for all $a, b\in \bar k$ such that $f(a, b) = 0$, the usual partial derivatives in the sense of Calculus $\dd{f}{x}$ and $\dd{f}{y}$ do not simultaneously vanish at $(a, b)$.
This is a sufficient condition, although it's not far from being necessary as well.
:::

:::{.remark}
Let $A/k$ be an affine Dedekind domain such that $\ff(A) = K$.
Then $\mspec(A) = \Sigma(K/A) \injects \Sigma(K/k)$.
This follows because $\Sigma(K/A)$ are the valuations that are not just regular on $k$, but also on $A$, (i.e. $A\dash$regular valuations) so the valuation ring contains the entirety of $A$.
It's thus natural to ask what its complement is, i.e. those valuations which are not regular on $A$ and give its elements negative valuation.
So define
\[  
\Sigma(A, \infty) \da \Sigma(K/k) \sm \Sigma(K/A)
,\]
the set of places at infinity with respect to $A$.

:::

:::{.example title="?"}
$\Sigma(k[t], \infty) = \ts{v_ \infty}$, which is the infinite place, so the terminology at least matches up!
:::

:::{.proposition title="Key"}
For any affine Dedekind domain $A$, $\Sigma(A, \infty)$ is finite and nonempty.
:::

:::{.remark}
This is striking!
This says that one affine Dedekind domain is giving almost all of this infinite set of places, but never all of it.
:::

:::{.proof title="?"}
By Noether Normalization [^noether_note]

there exists a $t\in A$ that that $A$ is a finitely generated (and thus integral) $k[t]\dash$module, and $A$ is the integral closure of $k[t]$ in $K$.
Why must this be the integral closure?
Any ring finitely generated over a subring will be an integral extension, and $A$ is a Dedekind domain and thus integrally closed.
So let
\[  
r: \Sigma(K/k) \to \Sigma(k(t)/k)
\]
denote the restriction map; then by the regularity property we established in \cref{lemma:regularity}, we have
\[  
\Sigma(K/A) = r^{-1}\qty{\Sigma(k(t)/k[t])}
.\]
Why?
A valuation upstairs in the NTI square is regular with respect to the integral extension upstairs iff it's regular with respect to the ring it is the integral extension *of*.
So regularity is preserved both ways by integral extensions.
This means you can check regularity either upstairs or downstairs, allowing us to identify the above preimage.

This means that the places where are *not* $A\dash$regular upstairs are precisely those which are not $k[t]\dash$regular downstairs, and so we have
\[  
\Sigma(A, \infty) = r^{-1}\qty{\Sigma(k[t], \infty)} = r^{-1}(v_ \infty)
,\]
since we now there is exactly one such non-regular valuation.
But we showed that $r$ was surjective with finite nonempty fibers, so we're done since our set is one of the fibers.


[^noether_note]: This says that if you have an affine domain $R$ of a certain Krull dimension, then it is finitely generated as a module over a subring which is a polynomial ring in $\trdeg(R)$ variables.
This is like a stronger integral version of taking a finitely generated field extension and writing it as a finite degree field extension of a purely transcendental extension.

:::

:::{.remark}
Thus is $K/k$ is a one variable function field and $A$ is an affine Dedekind domain with fraction field $K$, then $\Sigma(K/k) = \mspec(A) \disjoint S$ where $S$ is finite and nonempty.
Earlier we saw by affine grounding that for each $v\in \Sigma(K/k)$ there exists an affine Dedekind domain $A$ with $v\in \Sigma(K/A)$, and thus $\Sigma(K/k)$ admits a *finite* covering by $\mspec$ of affine Dedekind domains.
The picture of what's happening is that we have $\Sigma(K/k)$ which is quasicompact with respect to the Zariski topology, which contains many $\mspec$, at least one of which contains $v$.
Note that these $\mspec(A_j)$ for affine Dedekind domains $A_j$ is literally an open cover in this topology.
But the open sets are so large that they all have finite complement.
However, this means that instead of just an arbitrary open covering, one can choose a finite open covering: one $\mspec(A_j)$ will cover all but finitely many, and we can always find at least one $\mspec(A_{j'})$ covering all of the remaining points.

![Image](figures/image_2020-12-01-01-43-43.png)

It will in fact turn out that we only need **two** domains to cover everything.
:::

:::{.definition title="Holomorphy Rings"}
For a set $S \subseteq \Sigma(K/k)$, define the **holomorphy** ring as
\[  
R^s \da \Intersect_{v\in \Sigma(K/k)\sm S} R_v
.\]
::: 

:::{.remark}
This is the intersection of a bunch of valuation rings, so this contains elements that are simultaneously regular for this subset of valuations.
If $S \subseteq S'$, then $R^S \subseteq R^{S'}$, due to the fact that we're taking complements and $\Sigma(K/k) \sm S \supset \Sigma(K/k)\sm S'$, so we're removing bigger sets and thus intersecting over fewer things.
This can be thought of as relaxing some regularity conditions.
:::

:::{.remark}
How to think about holomorphy rings: if you take $S = \emptyset$, you intersect over all $R_v$ and obtain $R^\emptyset = \kappa(k)$.
You get a field that is algebraic over $k$, so it's very small compared to the other types of field extensions that arise.
We'll see that this is "unrepresentably" small.
:::

:::{.exercise title="Every affine Dedekind domain is a unique holomorphy ring"}
If $A$ is an affine Dedekind domain with fraction field $k$, then
\[  
A = R^S 
= \Intersect_{v\in \mspec(A)} R_v
&& S = \Sigma(K/k) \sm \mspec(A)
.\]

:::

:::{.remark}
This is a fact for any Dedekind domain, which is the intersection over all of its DVRs.
You obtain the integral closure for a Dedekind domain by intersecting all of the valuation rings, but here it is already integrally closed.
Its tautological that $A \subset R^S$ here, so $R^S$ is an *overring* of a Dedekind domain:  for $R$ a domain, an **overring** is any ring $T$ such that $R \subseteq T \subseteq \ff(R)$.
When $R$ is a PID, the overrings are in bijective correspondence with subsets of prime ideals (prime elements mod associates), so you get all overrings by inverting such subsets.
For Dedekind domains it's more complicated.
Can we classify all overrings of $R$ when it is a Dedekind domain?
The answer will eventually be yes.
Under what condition is every overring a localization?
When the class group is torsion.
What are the relationships between the class groups of the ring $R$ and its overrings $\hat R$?
It turns out that $\cl(\hat R)$ is a quotient of $\cl(R)$.
We will show that all such overrings are of the form $R^W$ for some $W$, i.e. they're obtained by intersecting some subset of the localizations of $R$ at its maximal ideals.

Note that the holomorphy ring in the exercise is obtained from a finite set of places.
Conversely, given any finite nonempty set of places, then the holomorphy of ring of all of the elements of $K$ that are regular with respect to all but this finite number of valuations will always be an affine Dedekind domain with fraction field $K$.

:::

## Holomorphy Rings are Affine Dedekind Domains with Fraction Field $K$

Next up is the main theorem of this lecture.

:::{.theorem title="Holomorphy rings on subsets are synonymous with affine Dedekind domains with fraction field $K$" ref="thm:main_lec_6"}
Let $K/k$ be a one variable function field and $S \subset \Sigma(K/k)$ finite and nonempty.
Then $R^S$ is an affine Dedekind domain with $\ff(R^S) = K$ and $\mspec(R^S) = \Sigma(K/k)\sm S$.
::: 


:::{.exercise title="?"}
If $S \subset \Sigma(K/k)$ is infinite, then $R^S$ is Dedekind with fraction field $K$ but is *not* finitely generated as a $k\dash$algebra.
:::

:::{.remark}
So what happens when you allow elements to fail regularity at an infinite set of places instead of just a finite set?
From the theory of Dedekind domains, this will again be a Dedekind domain, but will be more exotic than an affine Dedekind domain.
What if it were finitely generated as a $k\dash$algebra?
Then it would be an affine Dedekind domain, and we have a good understanding of $\mspec$ of these types of rings, and it would have to be a holomorphy ring with respect to some finite set.
Note that holomorphy rings for different subsets are distinct.
:::

:::{.remark}
We have an interesting class of rings: Dedekind domain which are holomorphy rings with respect to an infinite set of places.
What are they good for?
They're used in Pete's paper "Elliptic Dedekind domains revisited" to give a new proof of a theorem of Clayborne (60s, at least the third proof) that every commutative group is the ideal class group of some $R^S$.
\todo[inline]{Get citation.}
The Dedekind domain used was a holomorphy ring $R^S$ with respect to some infinite set $S$.
He starts out with an elliptic function field $K$ (so of genus 1 with a degree 1 place), and taking the standard affine coordinate ring of the curve is $R^S$ for $S$ the single degree 1 place.
This is particularly nice, since its class group is canonically isomorphic to $C(k)$, the $k\dash$rational points of the elliptic curve.
When you pass from a Dedekind domain to an overring you get some quotient of the class group.
Note that there are three degrees of freedom here: you get to pick $k$ to be any field, then $K/k$ some function field, and then $S$.
For this paper, $k$ was already some weird transfinitely iterated field.
The upshot here is that not only is every commutative group isomorphic to $\cl(T)$ for $T$ *some* Dedekind domain, $T$ is in particular a holomorphy ring of the form $R^S$.
This is pretty useful, but not nearly as much as $R^S$ for $S$ a finite set of places.
:::

:::{.definition title="Poles and Zeros"}
Let $f\in K\units$, then a place $v\in \Sigma(K/k)$ is a **pole** of $f$ iff $f\not\in R_v$, and $v$ is a **zero** of $f$ iff $f\in \mathfrak{m}_v$.
:::

:::{.lemma title="The divisor of a rational function is well-defined." ref="lem:poles_and_zeros"}
Let $f\in K\units$ be nonzero, then
\[  
\abs{\ts{v\in \Sigma(K/k) \st f\not\in R_vS}} &< \infty  && \text{(finite poles)}\\
\abs{\ts{v\in \Sigma(K/k) \st f\in \mathfrak{m}_v S}} &< \infty && \text{(finite zeros)}
.\]

So $f$ is not regular at only a finite set of places, as as the set of points such that "$f(p) = 0$", i.e. $f$ is in the maximal ideal which makes it zero in the residue field.
:::

:::{.remark}
Thinking of $f$ as a rational function, this says that the sets of points which are poles or zeros are both finite.
:::

:::{.proof title="of first statement"}
If $f \in \kappa(K)$, then both sets are empty, so assume otherwise that $f$ is transcendental.
This is because if $f$ is a nonzero constant function, i.e. it is algebraic over $k$, and both $f, f^{-1}$ lie in all of the valuation rings and none of the maximal ideals.
Then the integral closure $A$ of $k[f]$ in $K$ is an affine Dedekind domain containing $f$.[^ca_thm_18.14]
But we're done: for all $v\in \Sigma(K/A)$, we have $f\in R_v$ and thus
\[  
\Sigma(A, \infty) = \Sigma(K/k) \sm \Sigma(K/A)
,\]
which is finite by affine grounding.
This is because $\Sigma(K/A)$ already has finite complement, so all but finitely many valuations are $A\dash$regular, and $f\in A$.
Conversely, if $f$ is nonconstant it can not be regular at all places since it would then lie $\kappa(K)$.

[^ca_thm_18.14]: Pete's Commutative Algebra, Theorem 18.4 (a normalization theorem).

:::

:::{.proof title="of second statement"}
Note that $f\in \mathfrak{m}_v \iff v_p(f) > 0 \iff v_p(1/f) < 0 \iff 1/f\not\in R_v$, so we can just apply the first statement to $1/f$.
:::

:::{.exercise title="Function fields are always covered by $\mspec$ of two affine Dedekind domains (too easy!)"}
Show that there exist $A_1, A_2$ affine Dedekind domain such that 
\[  
\Sigma(K/k) = \Sigma(K/A_1) \union \Sigma(K/A_2)
.\]
:::

:::{.remark}
This will follow from a theorem we haven't proved yet.
If we think of $\Sigma(K/k)$ as a compact Riemann surface, the theorem is saying that pulling out a single point (or any finite number) then what's left is $\mspec(A)$ for $A$ an affine Dedekind domain.
So just pull out two different points.
:::

:::{.remark}
The lemma is allowing us to define the divisor of a rational function.
We'll define $\Div K$ as the free $\ZZ\dash$module with bases $\Sigma(K/k)$.
Any divisor will be of the form
\[  
D = \sum_{p\in \Sigma(K/k)} n_p [p]
,\]
where all but finitely many of the $n_p$ are zero.
If we have a rational function $f\in K\units$, we'll define
\[  
\Div f = \sum_{p\in \Sigma(K/k)} v_p(f) [p]
.\]
How do we know this is well-defined?
We need $v_p(f) = 0$ for all but finitely many places $p$.
But $v_p(f) > 0 \implies f \not \in \mathfrak{m}_p$, and one part of the lemma said $f$ can only lie in finitely many $\mathfrak{m}_p$.
On the other hand, $v_p(f)$ can't be negative, since this would imply $f\not\in R_v$.

This is extremely important: the map that sends a rational function to its divisor is multiplicative and additive, so this yields a subgroup of $\Div K$ called the **principal divisors**.
The quotient is the **class group** of $K$, and now we are cooking with gas (as Pete's undergraduate instructor used to say).
:::

:::{.theorem title="Strong Approximation"}
Let $X \subsetneq \Sigma(K/k)$ be proper and let $p_1, \cdots, p_r\in X$.
Let $\ts{x_j}_{j=1}^r \subset K$ and $\ts{n_j}_{j=1}^r \subset \ZZ$.
Then there exists a single $x\in K$ such that
\[  
\forall 1\leq j \leq r,\, v_{p_j} (x-x_j) &= n_j \\
\forall p\in X\sm\ts{p_j}_{j=1}^r,\, v_p(x) &\geq 0
.\]
:::

:::{.remark}
Note that $X$ is allowed to be infinite, so the statement only gets stronger if we allow a maximal proper subset where its complement is just a point.
If we only had the first statement, this would be *weak approximation*.
The conclusion is weaker, but it applies much more generally.
One first learns this in NTII, and it applies to any finite set of inequivalent norms on a field.
The second statement is a requirement that $x$ is regular.
If $X$ were *not* all but one place, we should replace it by that since it'd still satisfy the hypotheses.
Enlarging $X$ only makes the conclusion of the second statement stronger, since this is enforcing more integrality conditions.
:::

:::{.proof title="?"}
Without loss of generality, assume that the complement $\Sigma(K/k) \sm X = \ts{p_0} \da S$ is a single place.
We know that $R^S$ is an affine Dedekind domain (by a theorem stated but not proved yet), so apply the *Dedekind Approximation Theorem*[^ntii_prop117].

[^ntii_prop117]: Pete's NTII, Proposition 1.17

:::

:::{.remark}
Note that Stichtenoth uses Weil's proof of Riemann-Roch to prove this.
Too bad he doesn't have several hundred pages of lecture notes to draw on!
The difference between weak and strong approximation: weak applies to a finite set of places, and strong applies to all but one place.
Later in NTII there's an adelic statement of strong approximation, which works in the more general setting of a linear algebraic group over a global field.
You can take the adelic points of that group, remove one place, and ask if strong approximation holds.
It turns out to depend on what kind of algebraic group you have.
::: 

## Proof of Main Theorem

We return now to the proof of \cref{thm:main_lec_6}.

We're trying to show that $R^S$ for $S$ a finite and nonempty set of places is an affine Dedekind domain.
So we need to show that it's Dedekind, and that it's finitely generated over a field.

If $\emptyset \subsetneq S_1 \subsetneq S_2$ are finite subsets of $\Sigma(K/k)$, then $R^{S_1} \subseteq R^{S_2} \subset K$.
By the structure theory of Dedekind domains,
[^ca_232]
every overring of a Dedekind domain is again a Dedekind domain.
This allows us to restrict to the case where $\abs S = 1$.

[^ca_232]: Pete's CA, Section 23.2.


### Case 1

We start with the case where $K$ is a one variable function field, since it should certainly be true there.
So assume $K = k(t)$.
If $S = \ts{v_\infty}$ is just the infinite place, then $R^S = k[t]$ from a previous discussion.
This is definitely a Dedekind domain, since it's an affine PID.

### Case 2

The next case is one place of degree 1, so $S= \ts{v_{t-a}}$ corresponds to a monic irreducible polynomial, where we use the fact that the degree of the residue field is the degree of the polynomial.
Then $R^S = k\left[{1\over t-a}\right]$.
This is holomorphic at $\infty$, since the degree in the denominator is bigger than that of the numerator.
So it lies in $R_{v_\infty}$ as well as $R_{v_q}$ for every monic irreducible polynomial $q$ except for $t-a$.
This is a PID since it's isomorphic to a polynomial ring, and has fraction field $K$. (?)
We certainly have a containment $\supseteq$, but the RHS is already an affine Dedekind domain whose $\mspec$ is everything but this single place.
By the theory of overrings, the only other possibility is that the RHS is bigger, but going from a Dedekind domain to a larger Dedekind domain removes elements from $\mspec$.

### Case 3

Now consider the case $S = \ts{v_p}$ with $\deg p \da d > 1$.
This corresponds to a monic irreducible polynomial of degree bigger than 1.
Note that $k[t] \cong k[\alpha]$ for any transcendental $\alpha$, so we can take $k[1/p] \subset R^S$.
This is an affine PID, and the containment follows from the fact that $1/p$ is holomorphic at $\infty$ (for the same reason as above). 
The only way it could *not* be regular with respect to some polynomial $q$ would be that after cancelling the numerator and denominator, $q$ appears in the denominator, and that happens precisely at $p$. 
Now taking fraction fields, we have $\ff{k[t]} = k(t)$ and $[k(t) : k(1/p)] = d$, the degree of the denominator, which follows from this exercise:

:::{.exercise title="Basic but important"}
If $p(t)/q(t) \in k(t)$ is a nonconstant rational function, then what is the degree $d \da [k(t) : k(p/q)]$?
Show that $d = \max\ts{\deg p, \deg q}$.
:::

So $k[1/p] \subset R^S$ must be proper, since $\ff(R^S) = K$ but $\ff(k[1/p])$ is a proper extension.
We can't have equality, so instead let $A$ be the integral closure of $k[1/p]$ in $k(t)$.
Then $A$ is a Dedekind domain with $\ff(A) = k(t)$ and $\mspec(A) = \Sigma(k(t)/k) \sm\ts{v_p}$ from the following NTI square:

\begin{tikzcd}
	{A} && {k(t)} \\
	\\
	{k[1/p]} && {k(1/p)} \\
	\\
	{k}
	\arrow[from=5-1, to=3-1, no head]
	\arrow[from=3-1, to=1-1, hook]
	\arrow[from=3-3, to=1-3, hook]
	\arrow["{\subseteq}" description, from=1-1, to=1-3, hook]
	\arrow["{\subseteq}" description, from=3-1, to=3-3, hook]
\end{tikzcd}
[Link to diagram](https://q.uiver.app/?q=WzAsNSxbMCwyLCJrWzEvcF0iXSxbMiwyLCJrKDEvcCkiXSxbMCwwLCJBIl0sWzIsMCwiayh0KSJdLFswLDQsImsiXSxbNCwwLCIiLDAseyJzdHlsZSI6eyJoZWFkIjp7Im5hbWUiOiJub25lIn19fV0sWzAsMiwiIiwwLHsic3R5bGUiOnsidGFpbCI6eyJuYW1lIjoiaG9vayIsInNpZGUiOiJ0b3AifX19XSxbMSwzLCIiLDAseyJzdHlsZSI6eyJ0YWlsIjp7Im5hbWUiOiJob29rIiwic2lkZSI6InRvcCJ9fX1dLFsyLDMsIlxcc3Vic2V0ZXEiLDEseyJzdHlsZSI6eyJ0YWlsIjp7Im5hbWUiOiJob29rIiwic2lkZSI6InRvcCJ9fX1dLFswLDEsIlxcc3Vic2V0ZXEiLDEseyJzdHlsZSI6eyJ0YWlsIjp7Im5hbWUiOiJob29rIiwic2lkZSI6InRvcCJ9fX1dXQ==)

By affine grounding, we know $k[1/p]$ is an affine Dedekind domain, and by the second normalization theorem we know that $A$ is finitely generated as a module over $k[1/p]$, which is in turn finitely generated as an algebra over $k$, making $A$ a finitely generated $k\dash$algebra.
The key ingredient in identifying $\mspec(A)$ is that $1/p\in A$.
By a previous exercise, we can conclude that $A$ is a holomorphy ring, and since we know the exact excluded set is $S$, we can conclude $A = R^S$.
This makes $A$ an affine Dedekind domain.
\

For the final case, suppose $S$ is finite and nonempty.
Choose $v\in S$ and define $S_1 \da \ts{v}$.
Then $R^{S_1} \subseteq R^S \subset K$, so $R^S$ is a Dedekind domain since it's an overring of a Dedekind domain.
A surprising fact is that $A \da R^S$ is not a PID when the degree is greater than 1, and instead $\cl(A) \cong \ZZ/d\ZZ$ and is thus torsion.
It'll be enough to show that $R^S$ is finitely generated as an algebra (but not a module?) over $R^{S_1}$, which will make it a finitely generated $k\dash$algebra, and we'd really like it to be a localization.
We examined this before: is every overring of a Dedekind domain a localization?
A theorem of Clayborne shows that this is true when the class group is torsion.

Let $v_2 \in S\sm S_1$, so that every such $v_2$ yields an ideal $\mathfrak{p}_{v_2} \in \mspec R^{S_1}$.
Since $\cl(R^S) = \ZZ/d\ZZ$, we don't know that $\mathfrak{p}_{v_2}$ is principal, but we do know that $\mathfrak{p}_{v_2}^\alpha$ is for some power $\alpha$
Note that localization is forgiving in the sense that inverting an element $x$ is equivalent to inverting any power $x^k$ (e.g. using that $1/x = x^{k}/x^{k+1})$.
So we can write $\mathfrak{p}_{v_2}^\alpha = \gens{f}$, and it follows that $R^{\ts{v, v_2}} = R_v[1/f]$ is an affine domain which is obtained by localizing $f$.
Note that we can think of this overring as puncturing or removing one place (a certain maximal ideal) at a time, i.e. intersecting over all of the maximal ideals except one in order to go from $R^{S_1} = R^{\ts{v_1}}$ to $R^{\ts{v_1, v_2}}$.
You can continue this inductively using the fact that $R_v[1/f]$ is a different Dedekind domain -- since it's an overring, the corresponding class group is a quotient and thus still torsion.
You could also continue this inductively by just puncturing one point at a time.
You can also do it all at once: for each element in $S$ not equal to $v_1$, obtain an $f_j$, and invert the product $\prod_j f_j$.[^alt_ca_236]


**Key fact**:
We're in a lucky situation where we don't have a PID, but we have a torsion class group.
Anytime you pass to an overring by puncturing finitely many maximal ideals, it will always be a localization and thus monogenic as an algebra over the smaller Dedekind domain.

[^alt_ca_236]: Alternatively, see Pete's Commutative Algebra, Corollary 23.6.

## Case 3: Fixed Proof

The remainder of the proof will go toward reducing to the first step of a function field and exactly one place.
We'll apply the Riemann-Roch theorem, however this does not rely on results on holomorphy rings, so there's no logical circularity.
As usual, we lose no generality by replacing $k$ with $\kappa(K)$ and just assuming that $\kappa(k) = k$.
\

Let $S \subset \Sigma(K/k)$ be finite and nonempty.
Then by Riemann-Roch there exists an $f\in K\units$ having poles precisely at the elements of $S$, i.e. $f$ is regular away from $S$.

> Recall that poles were defined as elements not in $R_v$.
This is motivated by considering meromorphic functions $f$ on $\CC$, then the order of vanishing of $f$ at $p$ is a discrete valuation, and if that valuation is negative then $p$ is a pole.

Note that we're specifying the poles but not their orders, and allowing poles of arbitrary orders would still allow us such a rational function by a result like the Riemann inequalities, which is easier to prove than the Riemann-Roch theorem.
You can also obtain such a function from the Strong Approximation theorem.
\

Since $f$ has poles, it's nonconstant, so we have a nontrivial map $r: \Sigma(K/k)  \to \Sigma(k(f)/k)$ to a rational function field and thus $r^{-1}(\infty) = S$ since the poles all like above the place at $\infty$.
The analogy here is a holomorphic function $f$ from a compact Riemann surface to $\PP^1_{/\CC}$, in which case $f^{-1}(\infty)$ is the set of poles.
Since $k[f]$ is a polynomial ring, we can take the integral closure of $k[f]$ in $K$, say $B$, in which case $B$ is an affine Dedekind domain and $\mspec(B) = \Sigma(K/k)\sm S$.

The picture is as follows: think of $k(f)$ as the Riemann sphere with the point $\infty$ and $\Sigma(K/k)$ as a Riemann surface above it, then $S$ is the preimage of $\infty$.

![Image](figures/image_2020-12-01-22-09-07.png)

If you have an upstairs valuation $v \in \Sigma(K/k)$ in an integral extension, then it is regular upstairs iff its restriction downstairs is regular.
Completing the NTI square yields


\begin{tikzcd}
	{B} && {K} \\
	\\
	{k[f]} && {k(f)}
	\arrow["{\subseteq}" description, from=3-1, to=1-1, hook]
	\arrow["{\subseteq}" description, from=3-3, to=1-3, hook]
	\arrow["{\subseteq}" description, from=1-1, to=1-3, hook]
	\arrow["{\subseteq}" description, from=3-1, to=3-3, hook]
\end{tikzcd}
[Link to diagram](https://q.uiver.app/?q=WzAsNCxbMCwyLCJrW2ZdIl0sWzAsMCwiQiJdLFsyLDAsIksiXSxbMiwyLCJrKGYpIl0sWzAsMSwiXFxzdWJzZXRlcSIsMSx7InN0eWxlIjp7InRhaWwiOnsibmFtZSI6Imhvb2siLCJzaWRlIjoidG9wIn19fV0sWzMsMiwiXFxzdWJzZXRlcSIsMSx7InN0eWxlIjp7InRhaWwiOnsibmFtZSI6Imhvb2siLCJzaWRlIjoidG9wIn19fV0sWzEsMiwiXFxzdWJzZXRlcSIsMSx7InN0eWxlIjp7InRhaWwiOnsibmFtZSI6Imhvb2siLCJzaWRlIjoidG9wIn19fV0sWzAsMywiXFxzdWJzZXRlcSIsMSx7InN0eWxlIjp7InRhaWwiOnsibmFtZSI6Imhvb2siLCJzaWRlIjoidG9wIn19fV1d)

Here $B$ is the integral closure.
So if we take a valuation in $K$, it is $B\dash$regular iff its restriction to $k(f)$ is $A\dash$regular.
But $R_v$ contains $k[f]$ iff it contains $f$, since it's already a $k\dash$valuation, so the non-regular valuations are those that restrict to $\infty$.


Now if you have an extension of Dedekind domains, then the maximal ideals upstairs are everything which restricts to a finite place downstairs.
So those that don't restrict to a finite place restrict to $\infty$, which is precisely the preimage of $\infty$.
With the identification of $\mspec(B) = \Sigma(K/k) \sm S$,we have $B \subset R^S$ since every valuation in the complement of $S$ is regular at $B$ by this argument.
Since $B \subset R^S \subset K$, we can use the classification of overrings of Dedekind domains, and the $\mspec$ corresponds to precisely the maximal ideals that are being intersected.
The only way this could be a *proper* extension would be if the $\mspec$ shrank, but then $R^S$ would be the holomorphy ring attached to a larger set than $S$.
So we obtain an equality.

$\qed$

# Lecture 7: Riemann-Roch

## Divisors

:::{.definition title="Divisor group"}
The **divisor group** $\Div K$ is the free $\ZZ\dash$module with basis $\Sigma(K/k)$, so
\[  
\Div K \da \bigoplus_{p\in \Sigma(K/k)} \ZZ
.\]
Thus every $D\in \Div K$ is of the form $D = \sum_{p\in \Sigma(K/k)} n_p p$ where $n_p\in \ZZ$ and are almost all zero, recalling that a point $p\in \Sigma(K/k)$ is an equivalence class of valuations.
:::

:::{.definition title="Effective Divisor"}
A divisor $D = \sum n_p p$ is **effective** iff $n_p \geq 0$ for all $p$ and write $D\geq 0$.
:::

:::{.definition title="Support of a divisor"}
The **support** of a divisor $D$ is the set of places $p\in \Sigma(K/k)$ such that $n_p(D) \neq 0$.
Note that this is always a finite set, and the zero divisor is the unique divisor supported on $\emptyset$.
:::

:::{.definition title="Partial order on divisor"}
We write $D_1 \leq D_2$ iff $D_2 - D_1 \geq 0$ is effective.
Note that this holds iff for all places $p\in \Sigma(K/k)$, if $D_1 = \sum_p m_p p$ and $D_2 = \sum_p n_p p$, then $m_p\leq n_p$ for all $p$.
:::

This is a partially ordered commutative group, which came up when we were talking about groups of divisibility.
It's a reasonable group when studying domains with nice factorization properties: if $R$ is a UFD with a set of principal prime ideals[^primes_ufd]
denoted $\Sigma(R)$, then the group of divisibility $G(R)$ is isomorphic to $\bigoplus_{(p) \in \Sigma(R)} \ZZ$ as a partially ordered commutative group.

[^primes_ufd]: Note that primes in a UFD are principal.

There is an analogy: comparing UFDs to Dedekind domains, we trade unique factorization of elements for factorization of ideals, and the group of all fractional ideals in a Dedekind domain is a free commutative group on its set of prime ideals.
So $\Div K$ is analogous to the group of divisibility of a UFD and to the group of fractional ideals of a Dedekind domain, the latter of which is the closer analogy.
So $\Div K$ is a geometric or projective analog of the group of fractional ideals, and is more than an analogy as we'll see later.

:::{.definition title="Degree of a Divisor"}
There is a group morphism
\[  
\deg: \Div K &\to \ZZ \\
D = \sum_p n_p p &\mapsto \sum_p n_p \deg p
.\]
Its kernel is denoted $\Div^0 K$, the **degree zero divisors**.
Note that if $k = \bar k$, then $\deg p = 1$ for all $p$.
:::

:::{.remark}
Note that this is similar to the augmentation in a group ring.
This construction can be done with any free $\ZZ\dash$module, and makes sense because only finitely many terms are nonzero.
Recall that to define the degree of a place $v\in \Sigma(K/k)$, we consider $R_v \da \ts{x\in K \st v(x) \geq 0}$ and $\mathfrak{m}_v \da \ts{x\in K \st v(x) >0}$, and $k(v) \da R_v / \mathfrak{m}_v$ is the residue field.
Note that $k(v)$ is a field extension of $k$ by composing $k\injects R_v \surjects k(v)$, and we proved used affine grounding and Zariski's lemma that this was a finite degree extension.
We can then define $\deg v \da [k(v) : k]$.
Note that it's more natural to think of valuations $v$ as points $p$.
:::

:::{.definition title="Index of a divisor"}
The **index** of $K$ is defined as
\[  
I(K) \da \abs{\coker \deg}
.\]
[^ec_appearance]

[^ec_appearance]: This quantity made an appearance near the end of Pete's advanced course on elliptic curves.

:::

:::{.remark}
Note that $I(K)$ is nonzero, since we can think of $p\in \Div K$ as the divisor with $n_q = \indic{q=p}$, so the image contains a subset consisting of all degrees of all places, so the image is of the form $d\ZZ$ for some $d$.
Some other characterizations:

- $\deg\qty{\Div K} = I(K)\ZZ$, so $I(K)$ is the generator of the degree ideal.
- $I(K)$ is the least positive degree of a divisor on $K$.
- $I(K) = \gcd\qty{\ts{\deg p \st p\in \Sigma(K/k)}}$, i.e. the $\gcd$ of the closed points.


The last characterization follows because we have generators of $\Div K$ given by "skyscraper" divisors $p$ where $n_q = 1 \iff p=q$, so the image is the subgroup of $\ZZ$ generated by the degrees of the points, i.e. the $\gcd$ of the degrees.

:::

:::{.exercise title="?"}
Let $K/k$ be a one variable function field.

a. Show that if $\Sigma_1(K/k) \neq \emptyset$ then $I(K) = 1$.

b. Later we will show that if $\abs{k} < \infty$ then $I(K) = 1$ but $\Sigma_1(K/k)$ may be empty. 
  Try to show this.

c. Show that if $k=\bar k$ then $I(K) = 1$.

:::

:::{.remark}
(a) follows from the Riemann hypothesis for curves over a finite field, although this is not how you should prove it.
It was proved by F.K. Schmidt much earlier in the 20th century, and this is the basic way of understanding the zeta function of a curve.
(b) says that over a finite ground field, you may not have any degree 1 places.
You can try constructing a hyperelliptic curve over a finite field $\fq$ with no rational points, which is always possible if the genus is large compared to the size of $\fq$.
:::

:::{.lemma title="?"}
For a nonzero rational function $f\in K\units$ we have $v_p(f) = 0$ for almost every place $p\in \Sigma(K/k)$.
:::

:::{.proof title="?"}
See previous lecture, in particular 
\cref{lem:poles_and_zeros}.
:::

This says that the set of places for which the valuation is nonzero is finite, so except for finitely many places the valuation is zero.
This allows us to define the divisor of a rational function:
\[  
(\wait): K\units &\to \Div K \\
f &\mapsto (f) \da \sum_p v_p(f) p
,\]
which is a group morphism.

:::{.exercise title="?"}
Show that $(f) = 0 \iff f \in \kappa(K)$, which we're assuming is equal to $k$.
This happens when it has neither zeros nor poles, so it's an intersection of all of the $R_v$, which is the integral closure of $k$ in $K$.
In general, this would mean that $f$ is algebraic over $k$.
So $\ker (\wait) = k\units$.
:::

:::{.definition title="Poles and Zeros of Elements of $K$"}
For any $D\in \Div K$ one may uniquely write it as $D = D_+ - D_-$, which are both effective divisors and so $D_+, D_- \geq 0$, and the uniqueness follows from requiring $\supp(D_+) \intersect \supp(D_-) = \emptyset$.
Note that this is just collecting positive and negative $n_p$ into each term, and leaving out all divisors for which $n_p = 0$.


For $f\in K\units$, we define
\[  
(f)_+ &\da \text{the divisor of zeros of } f \\
(f)_- &\da \text{the divisor of poles of } f 
,\]
where we can note that $(f) = (f)_+ - (f)-$.
:::

The next proposition shows that these geometric divisors can be interpreted in terms of $\fq$ points.

:::{.proposition title="?"}
Let $f\in K\sm k$ be transcendental.

a. Let $B_0$ be the integral closure of $k[f]$ in $K$, which is an affine Dedekind domain of $K$, i.e. its fraction field is $K$.[^as_usual_dd]

  Then
  \[  
  fB_0 = \prod_{j=1}^r p_j^{a_j} \implies (f)_+ = \sum_{j=1}^r a_j p_j
  .\]

b. Let $B_ \infty$ be the integral closure of $k[1/f]$ in $K$, which is an affine Dedekind domain of $K$.
  Then
  \[  
  \qty{1\over f} B_ \infty = \prod_{j=1}^s q_j^{b_j} \implies (f)_+ = \sum_{j=1}^s b_j q_j
  .\]


[^as_usual_dd]: As usual for an extension of Dedekind domains, we push forward an ideal (maybe principal) into its integral closure and see how it factors.

:::

:::{.exercise title="?"}
Prove this proposition.
:::

:::{.remark}
This says that pushing forward an ideal and looking at the factorization is precisely what's needed to determine the divisor of zeros.
There aren't many new ideas for this proof, the point is that the set of places upstairs is being controlled by $\mspec$ of Dedekind domains.
:::

:::{.slogan}
In any affine coordinate chart, the divisor of a function is a principal fractional ideal.
:::

## The Degree of the Divisor of a Rational Function is Zero

:::{.corollary title="Excruciatingly Important: the degree of the divisor of any rational function is zero."}
Let $f\in K\sm k$ be transcendental, then

a. $\deg(f)_+ = [K : k(f) ] = \deg (f)_-$

b. $\deg (f) = 0$.

:::

:::{.remark}
Here think of $f$ as a holomorphic map from a curve to $\PP^1_{/\CC}$, and the degree of this extension is the degree of the corresponding branched cover.
For $\CC$, this is literally the cardinality of any finite fibers.
Note that (a) follows by symmetry sense $k(f) \cong k(1/f)$.
:::

:::{.proof title="?"}
This comes down to NTI.
We know $\deg(f)_+ = \sum{j=1}^r a_j \deg p_j$.
In $K/k(f)$, the places $p_1, \cdots, p_r$ all lie over the degree 1 place $v_f$ of $k(f)$.
The places where upstairs you have a zero are the places where to coordinate downstairs is equal to zero, which corresponds to the irreducible polynomial in $f$ given by $f$ itself.
Since the residue field at $v_f$ downstairs is $k$ itself, since it is $k[f]/\gens{f}$.
So the downstairs places has degree 1, and so the degree of the upstairs places, whatever the residue field is, its degree over $k$ is equal to its degree over the downstairs residue field.
Thus the geometric $\deg p_j$ coincides with the residual degree $f_i$, and $a_i$ is the ramification index in the extension of Dedekind domains $B_0 / k[f]$.
\

So we have a degree equality,
\[  
\sum_{j=1}^r a_j \deg p_j = \sum e_j f_j = [K: k(f)]
,\]
where the second equality follows from having an extension of Dedekind domains with this nice finite generation hypothesis.
We similarly get $[k: k(f)] = \deg(f)_-$.
\

Note that part (b) follows immediately, since $(f) = (f)_+ - (f)_-$ implies that \
\[
\deg(f) = \deg(f)_+ - \deg(f)_- = [k: k(f)] - [k: k(f)] = 0
.\]

:::

:::{.remark}
We have two different things that sound like the degree of a rational function.
We define the degree of a rational function $f\in K\sm k$ as $[K: k(f)]$, otherwise it is the degree (number of sheets) of the corresponding branched covering of $\PP^1$.
But note that we also attached a divisor to $f$, which may be confusing, be hard to confuse in practice because we found that $\deg(f) = 0$ always.
:::

:::{.definition title="Principal Divisors"}
The divisor of a rational function is called **principal**, we define $\Prin K$ to be the group of principal divisors.
:::

:::{.exercise title="$\Prin K$ is a group"}
For $f, g\in K\units$, show that

a. $(1/f) = -(f)$,

b. $(fg) = (f) + (g)$,

c. $\Prin K \leq \Div^0 K$ is a subgroup (since we know they're degree zero).

:::


:::{.definition title="Linear Equivalence"}
For $D_i \in \Div K$, we set $D_1 \sim D_2 \iff D_1 - D_2 \in \Prin K$, in which case we say these divisors are **linearly equivalent**.
:::

:::{.remark}
Near the end of the course we'll see why this is good terminology: it's related to morphisms of projective space attached to linear systems.
:::

:::{.definition title="Divisor Class Group"}
We define the **divisor class group** as 
\[  
\cl K \da \Div K/\sim = \Div K / \Prin K
.\]
:::

But note that there's something between $\Prin K$ and $\Div K$, namely $\Div^0 K$:

:::{.definition title="Degree 0 Divisor Class Group (Important! Fundamental!)"}
We define the **degree 0 divisor class group** as 
\[  
\Cl^0 K  \da \Div^0 K / \sim = \Div^0 K / \Prin K
.\]
:::

:::{.remark}
This is extremely important!
Attached to a curve is a Jacobian abelian variety, a nice group variety whose dimension is equal to the genus of the curve, and the $k\dash$rational point of the Jacobian will become a commutative group that is isomorphic to $\Div^0 K$.
:::


:::{.exercise title="?"}
Show that we have the following exact sequences:

a. 
\[  
1 \to k\units \to K\units \mapsvia{(\wait)} \Prin K \to 0
.\]


b.
\[  
0 \to \Cl^0 K \to \Cl K \mapsvia{\deg} I(K) \ZZ \to 0
.\]

Deduce that $\Cl K \cong \Cl^0 K \oplus \ZZ$.

:::

:::{.remark}
For (a), we saw that rational functions that have zero divisors are constants, assuming that $\kappa(K) = k$.
For (b), because principal divisors have degree zero, the degree map factors through the quotient.
The deduction comes from that fact that we have a free and hence project $\ZZ\dash$module, yielding a splitting.
:::

:::{.exercise title="Very important, Pete insists that someone solves it!"}
\envlist
a. Show that $\Div ^0 k(t) = \Prin k(t)$.

b. Deduce that $\deg: \Cl k(t) \mapsvia{\sim} \ZZ$ and $\cl^0 k(t) = 0$.

:::

:::{.remark}
Note that $I(K) = 1$ in this case since both the $t\dash$adic or $\infty\dash$adic valuation have degree one.
Moral: the class groups are not interesting on rational function fields.
You have to take a degree zero divisor on a rational function field and build a rational function whose divisor is any given degree.
This is extremely useful!
:::

:::{.remark}
More general if $K/k$ has genus zero (e.g. a rational function field), then working over $\CC$ we would have $\Cl^0 K$ equal to the points of some compact complex Lie group of $\CC\dash$dimension $g$, so a large complex torus, unless $g=0$.
So if $k= \bar k$, $\Cl^0 K$ will be uncountably infinite when $g>0$.
If not, it might trivial, or it might be anything in between.
:::

The following result appears in a 1973 paper of Rosen, where he attributes it to F. K. Schmidt.
It gives a close relationship between $\Cl^0 K$ and the class groups $\Cl R^S$ of the affine Dedekind domains of $K$.
This shows that instead of $\Cl^0 K$ just being an analogue of the class group of a Dedekind domain, there's almost the same.
If you fix $K$, $\Cl^0 K$ is just one group attached to it, but there are infinitely many $R^S$ since there are infinitely many places.
So these groups can not be equal, since we could change the size of $S$ to obtain overrings of Dedekind domains, where the resulting class groups are quotients.
So you could kill finitely many elements in the class group of the Dedekind domain by just passing to an overring by adding finitely more places.

:::{.theorem title="Rosen"}
Let $S \subset \Sigma(K/k)$ be nonempty and finite, and recall that the holomorphy ring was defined as
\[  
R^S = \intersect_{v\in \Sigma(K/k)} R_v
.\]

Define the following:

- $D^0(S)$: the degree 0 divisors with support in $S$.
- $P(S) \da \Prin K \intersect D^0(S)$, the principal divisors supported in $S$.
  - Divisors of rational functions all of whose zeros and poles lie in $S$.
- $d_S$: The least positive degree of a divisor supported on $S$.
  - Note that this is different to the index in that we restrict to $S$, and is thus a multiple of $I(K)$.

Then there is an exact sequence
\[  
0 \to D^0(S) / P(S) \mapsvia{\iota} \Cl^0 K \mapsvia{\alpha} \Cl R^S \mapsvia{\beta} C(d/ I(K)) \to 0
.\]

:::

:::{.proof title="?"}
See NTII, Theorem 3.27.
:::

:::{.remark}
Note that the kernel $D(S)/P(S)$ could be infinite but is always finitely generated.
The map $\alpha$ is induced by
\[  
\alpha': \Div K &\to \Frac R^S \\
\sum n_p p  &\mapsto \prod_{p\in \mspec R^S} p^{n_p}
,\]
where we note that $\mspec R^S \subset \Sigma(K/k)$, and in fact $\Sigma(K/k) = \mspec R^S \disjoint S$.
We can do this because if $p$ is already in $\maxspec R^S$, we raise it to an appropriate power, and otherwise, for the finitely many $p\in S$ we just get rid of them.
But this kills of some elements, namely those things supported in $S$, hence the kernel in the exact sequence.
\

Note that the last group appearing is finite cyclic of order $d/I(K)$.
If you just looked at $D^0(S)$ before modding out by principal divisors, if you didn't impose degree zero, the subgroup would be isomorphic to $\ZZ^{\abs{S}}$.
But there's a linear condition that the degree is equal to zero, which cuts down the dimension by 1, yielding $\ZZ^{\abs S - 1}$.
It's hard to say how much $P(S)$ is cutting down the size.
:::

:::{.remark}
The moral is that there is a map, but the kernel and cokernel both depend on $S$.
If you understand $\Cl^0 K$, however, you have a good handle on all $\Cl R^S$.
:::

:::{.exercise title="?"}
\envlist

a. Show that $D^0(S) \cong \ZZ^{\abs S - 1}$.

b. Suppose $S$ consists of a single place whose degree is the quantity $d_S$ appearing in the previous theorem, the least positive degree of a divisor supported on $S$.
  Show that there is an exact sequence
  \[  
  0 \to \Cl^0 K \mapsvia{\alpha} \Cl R^S \mapsvia{\beta} C(d_S/I(K)) \to 0
  .\]

c. Deduce that $\alpha$ is an isomorphism iff $I(K) = d$.

d. Deduce that if $p\in \Sigma(k(t)/k)$ has degree $d$, then $\Cl R^{\ts p} \cong \ZZ/d\ZZ$.

e. Deduce that if $S = \ts p$ and $\deg p = 1$, then $\alpha: \Cl^0 K \to \Cl R^S$ is an isomorphism.
:::

:::{.remark}
Note that if you're given a finite set of places and ask for all of the rational functions that have zeros and poles only at those places, it is difficult to determine how close that is to filling out the entire degree zero divisor class group?
If you have two degree 1 points $p_i$, so $\abs S = 2$, do you have a rational function whose divisor is $p_1 - p_2$?
Probably not, because then the divisor of such a function would have degree 1.
You can continue this line of thought, but already using elliptic function fields you can see that all of these algebraic possibilities can occur.
:::

:::{.remark}
Note that in the case where $S$ is a single point of degree $d$, then $d_S$ is equal to the degree of the point $d$.
On the other extreme, consider what happens when $I(K) = 1$.
Then $C(d_S)$ is cyclic of order $d$, so in (c) if we have a rational function field, we know it has degree 1 places (like $0, \infty$), and the class group is zero.
So if you take one place on $\PP^1$ of degree $d$ and look at the correspond affine Dedekind domain of functions that are regular away from that one place 
$R^{\ts p}$, then the class group is nontrivial and it's thus not a PID.
Note that $\Cl^0 \PP^1$ is trivial, and puncturing it has an effect on the divisor class.
:::

:::{.exercise title="?"}
\envlist

a. Suppose $\Cl^0 K$ is finite, and show that every $\Cl R^S$ is finite.
[^later_we_will_show_finite]

b. Suppose $\Cl^0 K$ is finitely generated, and show that for all finite nonempty $S \subset \Sigma(K/k)$, there exists a finite $S' \supset S$ such that $\Cl R^{S'}$ is trivial.

[^later_we_will_show_finite]: Later we will show that $\Cl^0 K$ is finite when $k$ is finite.

:::

:::{.remark}
This is the positive characteristic version of one of the basic finiteness theorems from NTI: the ring of integers of any number field has finite class group.
But the $S\dash$class group is always finite, since it's a quotient of the class group, and that's what's happening here.
It's enough to show that the $\Cl^0 K$ and $C(d_S/ I(K))$ appearing in the SES in the previous theorem are finite, since the first term can only cut down the size.
The groups $\Cl R^S$ when $k$ is finite are analogues of the $S\dash$class groups of number fields.
In the function field case, you can't get away from the $S\dash$class group, since if $S= \emptyset$ then $R^S$ is not an interesting Dedekind domain: it's just $\kappa(K)$.
So you have to put something at $\infty$ to even get a 1-dimensional domain, whereas in the number field case, you always have a finite nonempty set of nonarchimedean places.

This allows us to deduce from the finiteness of this one geometric group the finiteness of $S\dash$class groups in the characteristic $p$ case.
If done correctly, this can be used to prove the finiteness of class groups of all number fields, e.g. if you do things in an adelic way in NTII.
:::

:::{.theorem title="Trotter, 1988"}
The ring $R[\cos \theta, \sin \theta]$ of real trigonometric polynomials is not a UFD, while $\CC[\cos \theta, \sin \theta]$ is a PID.
:::

:::{.remark}
Trotter shows that using $\sin(\theta)\sin(\theta) = (1+\cos(\theta))(1-\cos(\theta))$ exhibits non-unique factorization, since the terms appearing are non-associate irreducible elements in an integral domain.
See Pete's list of exercises.
Note that given an affine Dedekind domain how one figures out what the infinite places are concretely, but this will come up when discussing hyperelliptic curves.
:::

:::{.remark}
One exercise applies Rosen's theorem to show that $\Cl \RR [\cos(\theta), \sin(\theta)] = \ZZ/2\ZZ$ while $\Cl \CC[\cos(\theta), \sin(\theta)] = 1$.
What's happening is that over $\RR$, there is perhaps one degree 2 place at $\infty$, but after extending scalars to $\CC$ it breaks up into two degree 1 places.
:::


# Lecture 8: Riemann-Roch Spaces  (Part 1)

## Setup for the Riemann-Roch Theorem

Setting up for the single most important theorem in the course: the Riemann-Roch theorem.
We start by motivating this by considering the following property of $K\da k(t)$: for any degree 1[^res_field_reminder]
place $p \in \Sigma(K/k)$, there exists an $f\in K\units$ such that $(f)_- = p$.
In other words, $f$ is a rational function with a simple pole at the given place, and no other poles.
Why?
We just know precisely what all of the places are for this function field.


[^res_field_reminder]: So the residue field of the corresponding DVR is $k$ itself rather than some proper finite degree extension.

If $p= \infty$, we can just take $f(t) = t$, since any polynomial is regular away from $\infty$ and the valuation is $-\deg(f) = -1$
The other places $p$ correspond to $t-\alpha$ (the uniformizing element) for $\alpha\in k$, since they correspond to other points on $\AA^1_{/k}$, and so we can take $f(t) = 1/(t-\alpha)$.
This $f$ is regular at infinity since the degree of the numerator is larger than the degree of the denominator, and the denominator doesn't vanish at any other place.

:::{.remark}
With some thought, it can be found that this is a *characteristic* property of rational function fields: if $f\in K$, a one variable function field, and $\deg(d)_- = 1$[^recall_div_pole]
then the degree of the function is equal to the degree of the divisor of the zeros and the divisor of the poles, and thus the degree of the extension $[K: k(t)] = 1$ and thus $K = k(t)$ is rational.
So having a rational with a simple pole at only one point *only* happens in you're in a rational function field.

On the other hand, we both wanted and used in our discussion of holomorphy rings the fact that given a nonempty finite subset $S \subset \Sigma(K/k)$, we want to find a rational function $f\in K\units$ has poles at all of the points in $S$, so $\supp (f)_- = S$.
Better yet, we'd like a bound on the degree of any such $f$, i.e. the orders of all of these poles. 
If $S$ is a single place, unless the function field is rational, we can't require the function to have a pole of degree 1 at that point.
But can it admit a pole of degree at most 10, for example?
This is what motivates the Riemann-Roch spaces and the Riemann-Roch theorem.
If you're trying to give a quantitative bound on how high of an order of a pole you have to allow in order to have a rational function, this comes from a key invariant called the *genus* of the function field.
The theorem that will tell us about the existence of rational functions with poles of prescribed degrees in terms of the genus is precisely the Riemann-Roch theorem, so that's where we are headed.

[^recall_div_pole]: Recall that this is the divisor pole. 

:::

## The Riemann-Roch Space

:::{.definition title="Riemann-Roch Space of $D$ (Key Definition)"}
For $D\in \Div K$, the **Riemann-Roch space** of $D$ is defined as 
\[  
\mathcal{L}(D) \da \ts { f\in K\units \st (t) \geq - D} \union\ts{0}
.\]

:::

:::{.remark}
This will turn out to be a $k\dash$vector space, and is a sub $k\dash$vector space of $K$.
One of the first things we'll prove is that it's always finite dimensional.
This is only interesting when $D$ is linearly equivalent to an effective divisor, so we should think of $D$ as having a nonnegative degree, and in fact itself being an effective divisor.
So this is the space of rational functions that have prescribes poles of a prescribed order.
:::

:::{.question}
Does $\mathcal{L}(D)$ contain any rational functions other than zero?
:::

:::{.answer}
For any nonzero $f\in \mathcal{L}(D)\nonzero$, the divisor $D + (f)$ is effective, since $(f) \geq -D$, and also linearly equivalent to $D$.
If $D$ is not linearly equivalent to an effective divisor, this is just the zero vector space.
:::

:::{.exercise title="?"}
Let $K = k(t)$ and $n\in \ZZ^{\geq 0}$.
Show that 
\[
L(n\infty) = \ts{f\in k[t] \st \deg f \leq n}
\]
and in particular is a $k\dash$vector space of dimension $n+1$.[^infty_as_a_place]

[^infty_as_a_place]: Recall that $\infty$ is the $1/t\dash$adic place.

:::

:::{.remark}
Note that $\infty$ is a degree 1 place, and multiplying it by $n$ yields an effective divisor.
The Riemann-Roch space here is comprised of rational functions that regular away from $\infty$, which are polynomials, whose pole at $\infty$ has order at worst $n$.
But the order of a pole at infinity is its degree as a polynomial, since the $\infty\dash$adic valuation is the negative degree, so this yields polynomials of degree at most $n$.
:::

## Working with Divisors

:::{.lemma title="?"}
For $D\in \Div K$,
\[  
\mathcal{L}(D) \neq \ts{0} \iff 0 \text{ is equivalent to an effective divisor}
.\]
:::

:::{.proof title="?"}
$\implies$:
If $f\in \mathcal{L}(D)\nonzero$, then $D + (f)$ is effective and linearly equivalent to zero.

$\impliedby$:
If $D' \geq 0$ and $D' \sim D$, then $D' = D + (f) \geq 0$.
So $(f) \geq -D$ and thus $f\in \mathcal{L}(D)$.
:::


:::{.example title="?"}
$\mathcal{L}(0) = \ts{f \st (f) \geq 0} \union\ts{0}$, which consists of rational functions with no poles (so their divisor is the zero divisor), and thus $\mathcal{L}(0) = \kappa(K)$.
I.e., these are the constants: they are regular everywhere and have no zeros or poles.
We would like this space to have $k\dash$dimension 1, so we impose $\kappa(K) = k$.
:::

:::{.exercise title="?"}
\envlist
a. Show that for all $D$, $\mathcal{L}(D) \in \Vect_k$.
b. 
\[  
D\sim D' \implies \mathcal{L}(D) \cong_{\Vect_k} \mathcal{L}(D')
.\]
:::

:::{.remark}
You can frame the above as taking rational functions with poles of certain orders, and analyzing the orders of poles of their sums.
If you take $D'$ and write it as $D + (f)$ for $f$ a rational function, then $f$ should produce this isomorphism.
The moral: $\mathcal{L}(D)$ only depends on the linear equivalence class of $D$.
:::


:::{.exercise title="?"}
Let $D\in \Div^0 K$ be a degree zero divisor, then TFAE:

a. $\dim \mathcal{L}(D) \geq 1$
b. $\dim \mathcal{L}(D) = 1$,
c. $D$ is principal, i.e. the divisor of a rational function or linearly equivalent to zero.
:::

:::{.slogan}
The only way a degree zero divisor can have a nontrivial Riemann-Roch space is if it's linearly equivalent to zero.
::: 


## Subspaces and Dimension of Riemann-Roch Spaces

:::{.lemma title="?" ref="lemma:divisor_order_to_subspaces"}
Let $A \leq B$[^def_from_places]
in $\Div K$, then

a. $\mathcal{L}(A) \leq_{\Vect_k} \mathcal{L}(B)$ is a subspace,
b. $\dim \mathcal{L}(B) / \mathcal{L}(A) \leq \deg B - \deg A = \deg(B - A)$.


[^def_from_places]: These are formal linear combinations of places, so the coefficients in front of each place in $A$ should be less than the corresponding coefficient for $B$, or equivalently $B-A$ is effective.

:::

:::{.remark}
Since $B \geq A$, you can think of this as starting with $A$ and adding an effective divisor to get $B$, namely $A + (B-A) = B$.
How much does that decrease the dimension of the Riemann-Roch space?
At most, by the degree of $B-A$ as a divisor.
:::

:::{.corollary title="?"}
For $D\in \Div K$,

a. If $\deg D < 0$ then $\mathcal{L}(D) = 0$.
b. If $\deg (D) \geq 0$ then $\dim_k \mathcal{L}(D) \leq \deg(D) + 1 < \infty$.

:::

:::{.remark}
This shows that Riemann-Roch spaces are always finite dimensional, and also gives a simple upper bound on that dimension.
:::

:::{.proof title="of corollary"}
For (a), a divisor of negative degree is not linearly equivalent to an effective divisor, so we might as well assume it's effective.


For (b), the dimension of $\mathcal{L}(D)$ doesn't change if $D$ is replaced by a linearly equivalent divisor, so wlog assume $D$ is effective.
Now write $D = \sum_{i=1}^r p_i$ as a sum of not necessarily distinct places, and use the lemma: each time you add an effective divisor, the dimension either stays the same or increases by at most the degree of the added divisor.
So start with the zero divisor, use the fact that $\dim_k \mathcal{L}(0) = 1$, and apply the lemma $r$ times.
This yields a space of dimension at most $1 + \sum \deg p_i = \deg D$.
:::

:::{.proof title="of lemma, part (a)"}
If $A\leq B$ and $f\in \mathcal{L}(A)$, then $(f) \geq - A$.
Since $-A \geq -B$, we have $(f) \geq -A \geq -B$, so $f\in \mathcal{L}(B)$.
:::


For the next part, it's perhaps easiest to consider the case $k = \bar k$ so everything has degree 1.
If you go from a divisor to adding a single degree 1 place, this lemma says that if you increase your Riemann-Roch space by either allowing a pole at a point you didn't allow before or allowing a pole of order 1 greater, then the dimension increases by at most 1.

:::{.proof title="of lemma, part (b)"}
From the previous argument, we see that it's enough to do this one place at a time.
So we can easily reduce to the case $B = A + P$ for $P$ some place of degree not necessarily equal to 1 (since we're not assuming $k=\bar k$), using that fact that $B \geq A$.
So choose an element $t\in K$ such that 
\[  
v_p(t) = v_p(B) = v_p(A) + 1
,\]
since $B$ is built from $A$ by adding a single copy of $P$.
For $f\in \mathcal{L}(B)$, we have by definition[^valuation_note]
\[  
v_p(f) \geq -v_p(B) = -v_p(t)
,\]
and so by bringing $t$ to the other side we get $v_p(ft) \geq 0$ 
and thus $ft\in R_p$ (the corresponding local ring).
This allows us to define a $k\dash$linear map
\[  
\psi: \mathcal{L}(B) &\to k(P) = R_p/\mathfrak{m}_p \\
f & \mapsto ft \mod \mathfrak{m}_p
.\]
In words, we multiply $f$ by $t$ to make it $p\dash$adically regular, then look at its image in the residue field.
The kernel is precisely those elements $x$ such that multiplying by $t$ lands in the maximal ideal $\mathfrak{m}_p$, which means that $v(x)$ as 1 more than it could have been.
So the kernel is all elements such that multiplying by $t$ and taking the valuation gives at least one, thus
\[  
\ker \psi = \ts{f\in \mathcal{L}(B) \st v_p(f) \geq -v_p(t) + 1 = -v_p(A)} = \mathcal{L}(A)
,\]
which follows since $B$ and $A$ only differ at $P$, since $B = A+P$, so the divisors $A, B$ have the same coefficient at every other place.
We thus have the following diagram:

\begin{tikzcd}
	{0} & {\mathcal{L}(A)} & {\mathcal{L}(B)} & {\mathcal{L}(B)/\mathcal{L}(A)} & {0} \\
	\\
	{} & {} & {} & k(P) = {R_p / \mathfrak{m}_p} & {\cdots}
	\arrow[from=1-1, to=1-2, hook]
	\arrow[from=1-2, to=1-3, hook]
	\arrow[from=1-3, to=1-4, two heads]
	\arrow[from=1-4, to=1-5, two heads]
  \arrow[from=1-4, to=3-4, dotted, hook, "\exists \iota"]
	\arrow[from=1-2, to=3-4, "\psi"]
  \arrow[from=3-4, to=3-5]
\end{tikzcd}
[Link to diagram](https://q.uiver.app/?q=WzAsMTAsWzAsMCwiMCJdLFsxLDAsIlxcbWF0aGNhbHtMfShBKSJdLFsyLDAsIlxcbWF0aGNhbHtMfShCKSJdLFszLDAsIlxcbWF0aGNhbHtMfShCKS9cXG1hdGhjYWx7TH0oQSkiXSxbNCwwLCIwIl0sWzAsMiwiMCJdLFsxLDIsIlxcbWF0aGNhbHtMfShBKSJdLFsyLDIsIlxcbWF0aGNhbHtMfShCKSJdLFszLDIsIlJfcCAvIFxcbWF0aGZyYWt7bX1fcCJdLFs0LDIsIlxcY2RvdHMiXSxbMCwxLCIiLDAseyJzdHlsZSI6eyJ0YWlsIjp7Im5hbWUiOiJob29rIiwic2lkZSI6InRvcCJ9fX1dLFsxLDIsIiIsMCx7InN0eWxlIjp7InRhaWwiOnsibmFtZSI6Imhvb2siLCJzaWRlIjoidG9wIn19fV0sWzIsMywiIiwwLHsic3R5bGUiOnsiaGVhZCI6eyJuYW1lIjoiZXBpIn19fV0sWzMsNCwiIiwwLHsic3R5bGUiOnsiaGVhZCI6eyJuYW1lIjoiZXBpIn19fV0sWzEsNiwiIiwwLHsic3R5bGUiOnsiaGVhZCI6eyJuYW1lIjoibm9uZSJ9fX1dLFsyLDcsIiIsMCx7InN0eWxlIjp7ImhlYWQiOnsibmFtZSI6Im5vbmUifX19XSxbMyw4LCIiLDAseyJzdHlsZSI6eyJ0YWlsIjp7Im5hbWUiOiJob29rIiwic2lkZSI6InRvcCJ9LCJib2R5Ijp7Im5hbWUiOiJkb3R0ZWQifX19XSxbMCw1LCIiLDIseyJzdHlsZSI6eyJoZWFkIjp7Im5hbWUiOiJub25lIn19fV0sWzYsNywiIiwxLHsic3R5bGUiOnsidGFpbCI6eyJuYW1lIjoiaG9vayIsInNpZGUiOiJ0b3AifX19XSxbNyw4XSxbNSw2LCIiLDIseyJzdHlsZSI6eyJ0YWlsIjp7Im5hbWUiOiJob29rIiwic2lkZSI6InRvcCJ9fX1dLFs4LDldXQ==)

where we can conclude that the indicated injection exists, and thus 
\[  
\dim \mathcal{L}(B) / \mathcal{L}(A) \leq [k(p) : k] = \deg P
.\]

[^valuation_note]: Note that $v_p$ is the $p\dash$adic valuation, i.e. the coefficient of $P$ in the divisor as a formal linear combination of points.

:::


:::{.fact}
For $p\in \Sigma(K/k)$ with residue field $k_p$ and $[k_p: k] = d$, defining $K_p$ as the completion of $K$ with respect to $\abs{\wait}_p$, there is an isomorphism $K_p \cong k_p((t))$, a formal Laurent series field.
One issue is that if $d =1$ then $k \subset k_p$, but not for general $d\geq 2$.
However, taking the completion results in $k \subset K_p$ again.
This shouldn't be too surprising from the perspective of local fields in NTII.
There is a structure theory of complete discretely valued fields.
This is an *equicharacteristic* such field, i.e. the characteristic of the field agrees with that of the residue field, and all equicharacteristic discretely valued fields will be isomorphic to a ring of formal Laurent series.
This isn't a fact of the geometry of curves.
:::

## Bounds on Dimensions

:::{.definition title="$\ell(D)$: The dimension of a Riemann-Roch space"}
For $D\in \Div K$, define
\[  
\ell(D) \da \dim_k \mathcal{L}(D)
.\]
:::

:::{.exercise title="?"}
If $D\in  \Div k(t)$, show that
\[  
\ell(D) = 
\begin{cases}
\deg(D) + 1 & \deg D \geq 0 \\
0 & \text{else}.
\end{cases}
\]
:::

:::{.remark}
Recall that in a rational function field, every degree zero divisor is principal, and if you adjust by a principal divisor, you don't change $\ell(D)$.
This means that in any rational function field, any two divisors of the same degree are going to be linearly equivalent, and thus $\ell(D)$ will only depend on $\deg D$.
So rational function fields are much simpler than the fully general case.
:::

:::{.problem title="The Riemann-Roch Problem"}
Give good upper and lower bounds on $\ell(D)$ and especially $\ell(nD)$ as a function of $n$.
:::

:::{.remark}
The stronger version of knowing $\ell(D)$ in all cases is unsolvable.
If we knew the dimension of every Riemann-Roch space, then we would know too much! 
E.g. about Weierstrass points on elliptic curves. (?)
Looking at positive multiples $nD$ of a single divisor is common.
If $D$ is a single point, then the support of the divisor is the collection of places that appear with nonzero coefficients, $nD$ has the same support.
This is analogous to not allowing poles at new points, but rather allowing poles at the same points of higher order.
So it's reasonable to ask about asymptotic behavior of $\ell(nD)$ in $n$.
Secretly this is a kind of Hilbert function computation: if you have a graded algebra and you look at dimensions of its graded pieces, then there is a theorem that the Hilbert function is a polynomial for $n\gg 1$.
Here, $\ell(nD)$ will be a linear polynomial for $n\gg 1$ by the Riemann-Roch theorem, so there are some stabilization phenomena, but given a random divisor of low degree it is difficult to determine $\ell(D)$.
:::

:::{.remark}
The last corollary gave us a lower bound:
\[  
\deg(D) \geq 0 \implies \deg(D) - \ell(D) \geq -1
.\]
This can also be thought of as an lower bound on $\ell(D)$ in terms of $\deg(D)$, and next up we'll try to find an upper bound:
:::

:::{.proposition title="?"}
There exists a $\delta = \delta(K/k) \in \ZZ$ such that for all $A\in \Div K$, we have
\[  
\deg A - \ell(A) \leq \delta
.\]
:::

# Lecture 8: Riemann-Roch Spaces  (Part 2)

Recall the proposition we ended with last time:

:::{.proposition title="?" ref="prop:deg_bounded_above"}
There exists a $\delta = \delta(K/k) \in \ZZ$ such that for all $A\in \Div K$, we have
\[  
\deg A - \ell(A) \leq \delta
.\]
:::

:::{.exercise title="?"}
This proposition is enough to show the existence of rational functions whose polar divisor has as its support any finite subset $S \subset \Sigma(K/k)$.
:::

Most of the lecture will be the proof of this statement.

## Proof of Upper Bound

Rewriting \cref{lemma:divisor_order_to_subspaces} yields
\[  
A_2, A_2 \in \Div K,\, A_1 \leq A_2 \implies \deg A_1 - \ell(A_1) \leq \deg A_2 - \ell(A_2)
.\]


We now proceed to prove
\cref{prop:deg_bounded_above}
in several steps.

### Step 1

Choose an $x\in K\sm k$ and set $B\da (x)_-$.

:::{.claim}
There exists a $C\geq 0$ such that for all $n\geq 0$,
\[  
\ell(nB + C) \geq (n+1) \deg B
.\]
:::

So we give ourselves a certain effective divisor: the divisor of poles of an arbitrary nonconstant element.
We can then get a preliminary asymptotic lower bound, not on the same Riemann-Roch space, but on a new one after augmenting the space by some fixed effective divisor $C$.

:::{.proof title="?"}
Since $K/k(x)$ has finite degree, let $u_1,\cdots, u_d$ be a basis for $K$ consisting of finitely many rational functions.
Note that $d = [K: k(x)]$, and is also equal to $\deg B$ since $B$ was a divisor of poles.
Noting that the divisor groups are free commutative groups, so taking any finite number of elements in $\bigoplus \ZZ$, we can find an element that is less than or equal to all of them.
Thus we can choose a $C\geq 0$ such that 
\[  
(u_i) \geq -C && \forall 1\leq i \leq d
.\]

Since the $u_i$ are $k(x)\dash$linearly independent in $K$, the functions $\ts{x^i u_j \st\, 0\leq i \leq n,\,\, 1\leq j \leq d}$ are $k\dash$linearly independent, since any $k\dash$linear relation would immediately yield a $k(x)\dash$linear relation among the $u_i$.

:::{.exercise title="?"}
If $f_i\in \mathcal{L}(D_i)$, so the poles of $f$ are no worse than $D_i$, then the poles of $f_1 f_2$ are bounded by $D_1 + D_2$ and thus $f_1 f_2 \in \mathcal{L}(D_1 + D_2)$.
:::


Now we can note that there are $(n+1)d = \deg B$ many elements here,
and moreover, these all lie in $\mathcal{L}(nB + C)$ since each $(u_j) \geq -C$ and $(x) \geq - B$ and $i\leq n$.
From this we can conclude
\[  
\ell(nB+c) \geq (n+1) d = (n+1) \deg B
.\]

:::

### Step 2

We'll now show that throwing in the fixed divisor $C$ can't increase the Riemann-Roch space that much, and in fact
\[  
\ell(nB + C) \leq \ell(nB) + \deg C
,\]
and so we get a bound
\[  
\ell(nB) 
&\geq \ell(nB + C) - \deg C \\
&\geq (n+1) \deg B - \deg C \\
&= \deg(nB) + \qty{ [K:k(x)] - \deg C} \\
&\da \deg(nB) \pm \gamma
,\]

which shows that
\[  
\forall n\geq 0,\, \, \deg(nB) - \ell(nB) \leq \gamma
\label{eq:step_2_bound}
.\]

A problem here is that $\gamma$ depends upon everything that we've done so far, and this inequality only holds for multiples of a fixed divisor (an infinite ray emanating from $B$).

### Step 3

:::{.claim}
For all $A\in \Div K$, there exist $A_1, D \in \Div K$ and $n\geq 0$ such that $A \leq A_1$,  $A_1 \sim D$, and $D\leq nB$.
I.e. although it can't literally be true that $A \leq nB$, it will be up to linear equivalence.
:::

To see this, set $A_1 \da \max(A, 0)$.
Using the bound from \cref{eq:step_2_bound}, for $n\gg 0$ we have
\[  
\ell(nB - A_1) 
&\geq \ell(nB) - \deg A_1 \\
&\geq \deg(n B) - \gamma - \deg A_1 \\
&> 0
,\]
and so there exists a $z\in \mathcal{L}(nB - A_1)\nonzero$, a nontrivial element in the linear system.

:::{.remark}
The first inequality is an application of our lemma because $A_1$ is effective, which was the point of this maneuver.
I.e., in order to get from $nB - A_1$ to $nB$, we added $A_1$, which can only increase the dimension of the space by at most $\deg A_1$.
Finally, in the last inequality, we use the fact that $B$ has positive degree since it's a divisor of poles of a nonconstant rational function, and the remaining terms don't depend on $n$, so we can make $\deg(nB)$ arbitrarily large.
:::

So now set $D \da A_1 - (z)$, then $A_1 \sim D$ and since it's in the linear system,
\[
(z) \geq - (nB - A_1) = A_1 - nB
\]
so $-(z) \leq nB - A_1$ and by adding $A_1$ to both sides, we obtain
\[  
0 = A_1 - (z) \leq nB
.\]

What have we shown?
For any divisor $D$, we can make it less than $nB$ for some $n$, up to linear equivalence.

### Step 4

Finally, for $A\in \Div K$, choose $A_1, D$ as in the previous step, so $A\leq A_1 \sim D \leq nB$.
Then
\[  
\deg A - \ell(A) 
&\leq \deg(A_1) - \ell(A) && \text{using } A\leq A_1\\
&= \deg(D) - \ell(D) && \text{changing within linear equivalence class}\\\
&\leq \deg(nB) - \ell(nB) \\
&\leq \gamma
.\]

$\qed$

## Genus

:::{.definition title="Genus (Important!)"}
The **genus** of $K/k$ is defined as
\[  
g \da \max_{A\in \Div K}(\deg(A) - \ell(A) + 1)
.\]
This exists by the \cref{prop:deg_bounded_above}, since this set is bounded above.
:::

:::{.exercise title="?"}
Show that $g\geq 0$ always and 
\[  
g(k(t)/k) = 0
.\]
:::


:::{.remark}
Note that if the $+1$ is mostly a correction factor to match up with the topological genus of $\PP^1_{/\CC}$.
That the genus is non-negative should come from the lower bound we had from before.
It turns out that over $k=\CC$, this genus will agree on the nose with the topological genus of the corresponding compact Riemann surface.
:::

:::{.theorem title="Riemann's Inequality" def="thm:riemann_inequality"}
If $K/k$ is a function field of genus $g$,

a. For all $A\in \Div K$, 
\[  
\ell(A) \geq \deg(A) + 1 - g
.\]

b. There exists a $c = c(K) \in \ZZ$ such that for all $A \in \Div K$,
\[  
\deg(A) \geq c \implies \ell(A) = \deg(A) - g + 1
.\]
:::

:::{.remark}
This says that the dimension of the linear system is very close to the degree of the corresponding divisor, and is only off by a constant factor $g$.
Part (a) is literally just a rearrangement of the definition of the genus.
Part (b) says that if you assume $A$ has sufficiently large degree, this upper bound becomes an equality.
:::

:::{.proof title="of b"}
By the definition of $g$, since it is a maximum there exists an $A_0$ such that 
\[  
g = \deg(A_0) - \ell(A_0) + 1
.\]
Set $c\da \deg(A_0) + g$.
Then if $\deg(A) \geq c$, we have
\[  
\ell(A - A_0) 
&\geq \deg(A-A_0) - g + 1 \\
&\geq c - \deg(A_0) - g + 1 \\
&= 1
,\]
so there exists a $z\in \mathcal{L}(A- A_0)\nonzero$ since the dimension is at least 1.

Now set $A' \da A + (z)$, and note that $A' \geq A_0$.
Thus
\[  
\deg(A) - \ell(A) 
&= \deg(A') - \ell(A') \\
&\geq \deg(A_0) - \ell(A_0) && \text{by the lemma}\\
&=g-1
.\]

By maximality of the genus, we have $\deg(A) - \ell(A) \leq g-1$, which forces equality
:::

Next up: how to we make this inequality into an equality?
It turns out that there is some different divisor $D'$ and we can subtract off $\ell(D')$, and that will be the Riemann-Roch theorem.


# Lecture 9

Last time: we proved the Riemann Inequality (\cref{thm:riemann_inequality}), the content of which is that there is a non-negative quantity called the *genus* for which the stated inequality holds.
The next step will be to try to improve this inequality to an equality, for which we introduce the following definition:

:::{.definition title="Index of Speciality"}
\[  
\iota(A) \da \ell(A) - \deg A = g - 1 \geq 0
.\]
:::

Tautologically, this yields
\[  
\ell(A) - \iota(A) = \deg A - g + 1
.\]

## Riemann-Roch Theorem and Applications

:::{.theorem title="Riemann-Roch Theorem"}
If $K/k$ is a function field of genus $g$, there exists a divisor $\mathfrak{k} \in \Div K$ such that for all $D\in \Div K$, $\iota(D) = \ell(\mathfrak{k} - D)$, and thus
\[  
\ell(D) - \ell(\mathfrak{k} - D) = \deg D - g + 1
.\]
:::

:::{.remark}
As a result, $\deg(D) > \deg(\mathfrak{k})$, so $\mathfrak{k} - D$ has negative degree.
We know that $\ell(D) > 0$ iff there is a $D' \sim D$ linearly equivalent to $D$, and there's no effective divisor equivalent to a divisor of negative degree.
Thus $\iota(A) = 0$ as soon as $\deg(D) > \deg(\mathfrak{k})$.
:::

:::{.exercise title="?"}
\envlist

1. $\ell(\mathfrak{k}) = g$ and $\deg \mathfrak{k} = 2g-2$.
2. $g\geq 0$
3. If $g\geq 1$, then the least $\alpha\in \ZZ$ such that whenever $\deg(D) > \alpha$ we have $\iota(D) = 0$ is given by $\alpha \da 2g-2$.
:::

:::{.remark}
Try taking $D=0$ and $\mathfrak{k} = D$ respectively, and compute $\iota(\mathfrak{k}) = 1$.
:::

:::{.exercise title="?"}
\envlist

a. Show that the Riemann-Roch theorem uniquely characterizes $g$, i.e. there is at most one quantity $g$ for which it holds.

b. Show that if Riemann-Roch holds for $\mathfrak{k}$, then it holds for any $\mathfrak{k}' \sim \mathfrak{k}$.

c. Show that if Riemann-Roch holds for $\mathfrak{k}_1, \mathfrak{k}_2$ then $\mathfrak{k}_1 \sim \mathfrak{k}_2$.

:::


:::{.definition title="Canonical Class"}
Thus the Riemann-Roch theorem singles out a distinguished *class* of divisors $[\mathfrak{k}]$ of degree $2g-2$, which is called the **canonical class**.
Any divisor $D\in [\mathfrak{k}]$ is called a **canonical divisor**.
:::


:::{.exercise title="?"}
Let $K/k$ be a genus zero function field.

a. Show that $\Cl^0(K) = 0$, so degree zero divisors are principal.

b. Show that $D\in \Div K$ is canonical iff $\deg D = -2$.

c. Show that the index $I(K)$ can only be 1 or 2.

d. Show that $K \cong k(t)$ iff $\Sigma _1 (K/k) \neq \emptyset$ iff $I(K) = 1$.
:::

:::{.exercise title="?"}
If $K/k$ is genus 1, show that a divisor $D \in \Div K$ is canonical iff $D$ is principal.
:::

## Applications of Riemann-Roch

### Genus Zero Function Fields

Let $K/k$ be a genus zero function field with $\mathfrak{k}$ a canonical divisor, so $\deg \mathfrak{k} = -2$.
Then $\deg(-\mathfrak{k}) = 2$ and by Riemann-Roch every effective divisor is not principal and
\[  
\ell(-\mathfrak{k}) = \deg(-\mathfrak{k}) -g + 1 = 3
.\]
One can choose $-\mathfrak{k}$ to be effective, so $1 \in \mathcal{L}(-\mathfrak{k})$.
So $\mathcal{L}(\mathfrak{k})$ has a basis of the form $\ts{1,x,y}$ for some elements $x, y$.

:::{.claim}
\[  
K = k(x, y)
.\]
:::

:::{.proof title="?"}
**Case 1**: 
If either $x$ or $y$ has degree 1, this is also the degree of the function field $K / k(x)$, and then $\mathfrak{k} = k(x)$ or $k(y)$ and the function field is rational.

**Case 2**:
Since $(x) \geq -\qty{ -\mathfrak{k}}$, we have $(x)_- \leq - \mathfrak{k} + (x)_+$, so $\deg(x) \leq \deg(-\mathfrak{k}) = 2$.
So $\deg(x) = 2$.
Similarly, $deg(y) = 2$ and so $[K: k(x)] = 2$.
Thus it's enough to show that $y\not\in k(x)$.
Toward a contradiction, if $y\in k(x)$, since $[K: k(y)] = 2$, we get $k(x) = k(y)$.
In this case $y$ is a degree 1 rational function in $x$, and so is of the form $y = {ax+ b \over cx + d}$ with $a,b,c,d \in k$.
This forces $(x)_- = (y)_- = -\mathfrak{k}$, since the only possibilities for these divisors are having degrees zero or one,
and we've ruled out the degree zero possibility.

So $y$ only has poles where $x$ has poles.
This follows because for a map $f: k \to k(t)$, the places over the point at infinity are places over infinity:

![Image](figures/image_2020-12-23-00-32-06.png)

Since $(x), (y)$ has the same divisor of poles in $K$, all of their poles like over $\infty\in k(t)$.
Moreover, since $y$ is regular away from $\infty \in k(x)$, this forces $c= 0$ and $y=ax+b$.
But this exhibits a $k\dash$linear dependence between $x, y$.
:::

Now consider $1,x,y,x^2, xy, y^2 \in \mathcal{L}(-2 \mathfrak{k})$.
Since $\ell(-2 \mathfrak{k}) = 5$, these is necessarily a linear dependence in this set, so there is a tupoe $(a,b,c,d,e,f) \subset k^6$ such that 
\[  
f(x, y) \da ax^2 + bxy + xy^2 + dx + ey + f = 0
.\]

Not all of $a,b,c$ can be zero, since this yields the linear dependence $dx + ey + 1 = 0$.
Moreover $f$ must  be irreducible: if not, it would have a linear factor, which would again yield a linear dependence between $x$ and $y$.

:::{.theorem title="Genus Zero Function Fields are Quadratic Extensions"}
For $K/k$ a genus zero function field, there exists $a,b,c,d,e,f\in k$ with $a,b,c$ not all zero such that
\[  
f(x, y) \da ax^2 + bxy + xy^2 + dx + ey + f = 0 \qtext{and} K = K_f
.\]
:::

:::{.exercise title="?"}
Suppose $\ch(k) \neq 2$, and show that every genus zero function field is regular and there exist $a,b,c\in k\units$ such that $K = K_f$ where $f(x, y) = ax^2 + by^2 + c$.
:::


# Lecture 10A (Todo)

# Lecture 10B (Todo)

# Lecture 10C (Todo)

# Lecture 11A: Weil's Proof of Riemann-Roch


Let $K_{/k}$ be a one variable function field, finitely generated of transcendence degree one, with $\kappa(K) = k$, so $k$ is algebraically closed in $K$.
Define the *small Adele ring* associated to $K$, as the restricted direction product with respect to $\ts{R_v \st v\in \Sigma(K/k)}$:

\[
A_k \da \prod^{\text{res}}_{v\in \Sigma(K/k)} K
= \ts{(x_v) \in K^{\Sigma(K/k)} \st x_v \in R_v \text{ for a.e. } v }
,\]
where each factor is a copy of $K$.
Note that a *restricted* direct product is when you have a family of sets, and for each set you also attach a subset.
Then if you have a tuple in the entire direct product, it's in the restricted direct product iff for all but finitely many coordinates lie in a given subset. Here the subset is the valuation ring $R_v$.
So these are tuples of elements of $K$, indexed by places, where each element has a $p\dash$adic valuation and the only restriction is that (except for finitely many cases) we want this valuation to be nonnegative.


:::{.remark}
To get the *big* Adele ring, you'd replace $K$ with its completion with respect to the $p\dash$adic valuation.
If $k$ is finite, then this is equal to the positive characteristic Adele ring from NTII. 
If you complete, then you get a complete discretely valued field whose residue field equals the residue field at the place $v$.
So for finite extensions of $k$, the residue will be finite iff $k$ is finite, and from the structure theory of discretely valued fields, this field has a natural topology: the adic topology, coming from the inverse limit.
This will be locally compact iff the residue field is finite.
Here, since the ground field is infinite, even passing to the completion wouldn't yield anything locally compact.
So there's no advantage to passing to the completion, although there's no harm either.
:::

Note that $A_k$ is a ring, and in fact a $K\dash$algebra, but we will only need its structure as a $K\dash$vector space.
This structure comes from embedding $K\injects A_k$ diagonally, so $x \mapsto [x, x, \cdots]$, and pull back $v\in \Sigma(K/k)$, remembering that every element of $K$ (a rational function) is regular except for finitely many $v$.

If we have a valuation on $K$, we can consider a place $p$ and projecting onto the $k$th factor:
\[  
A_j \surjectsvia{\pi_p} K \mapsvia{v_p} \ZZ \union \ts{\infty}
.\]

So we now attach an adelic version of the Riemann-Roch space: for $D\in \Div K$, we set
\[  
\mathcal{A}_k(D) \da \ts{ \alpha \in \mathcal{A}_K \st v_p(\alpha) \geq -v_p(D) \, \forall p \in \Sigma(K/k)}
.\]
The only difference here is that the usual space is over $K$, and here we're over $\mathcal{A}_K$, which is a much larger space.
This makes things easier, however, in the same sense that studying a large collection of local fields is easier than studying the corresponding global field.
Note that the $p\dash$adic valuation $v_p$ is just the coefficient of $p$ in the divisor, and $\mathcal{A}_K \intersect K$ yields the usual Riemann-Roch space.

:::{.exercise title="?"}
\envlist

a. Show that $\mathcal{A}_K(D)$ is an $k\dash$subspace of $\mathcal{A}_K$.[^exc_hint_1]


b. Show that (just as for the Riemann-Roch space) $D_1 \leq D_2 \implies \mathcal{A}_K(D_1) \subseteq \mathcal{A}_K(D_2)$.


[^exc_hint_1]: Consider scaling by nonzero constants, where the valuation of constants are zero.

:::

:::{.lemma title="?"}
\[  
D_1 \leq D_2 \implies \dim_k \mathcal{A}_K(D_2) / \mathcal{A}_K(D_1) = \deg D_2 - \deg D_1
.\]
:::

Note that this is the adelic analogue of our first lemma on Riemann-Roch spaces, now with an equality instead of being bounded above.


:::{.proof title="?"}
As we did before, by induction we can assume $D_2 = D_1 + p$ for some $p\in \Sigma(K/k)$, i.e. we can go from the smaller divisor to the bigger one by repeatedly adding closed points.
Then choose an element $t\in k\units$ such that $v_p(t) = v_p(D_2)$, and define a similar map
\[  
\phi \mathcal{A}_K(D_2) &\to k_p \\
\alpha &\mapsto (t\alpha p) \mod \mfm_p
.\]
Why? 
Once you multiply by $t$, note that we're looking in the $p$th component.
The condition before was that the valuation at the $p$th component was at least $-v_p(D_2)$, but now we're adding $v_p(D_2)$.
This yields a nonnegative valuation, making the image lie inside the corresponding local ring, so it makes sense to consider it modulo the maximal ideal to get an element of the residue field.
As before, it should be clear that this is $k\dash$linear, $\ker \phi = \mathcal{A}_K(D_1)$, and is surjective.
The kernel are exactly those elements such that multiplying by $t$ makes the $p\dash$adic valuation at least 1, since that's what the maximal ideal is.
This is indeed $\mathcal{A}_K(D_1)$, since $D_1$ and $D_2$ are the same except for the added condition $D_2 = D_1 + p$ at $p$.
\

So the main difference is that the map is now *surjective*, which was not true for the original Riemann-Roch space.
Why?
This is a purely local situation.
Take an element which is zero away from the $p$ component, which is easy to do since zero is in $R_v$ for any $v$.
So can you find an element of $k$ such that multiplying by $t$ and reducing modulo the maximal ideal yields every element of the residue field?
:::

:::{.theorem title="2.13"}
For all $D$,
\[  
\dim_k \mathcal{A}_K / \qty{\mathcal{A}_K(D) + K } = \iota(D) \da \ell(D) - \deg(D) + g - 1
,\]
where $\iota(D)$ is the index of speciality of the divisor, which measures the discrepancy between the degree and the dimension.
:::

:::{.remark}
This says that adding $K$ into the adelic Riemann-Roch space results in a big $k\dash$vector space, having high dimension in the infinite dimensional $k\dash$vector space $\mathcal{A}_K$.
:::


:::{.proof title="Step 1"}
For divisors $A_1 \leq A_2$, we have a short exact sequence of $k\dash$vector spaces
\[  
0 \to \mathcal{L}(A_2) / \mathcal{L}(A_1) \mapsvia{\sigma_1} \mathcal{A}_K(A_2) / \mathcal{A}_K(A_1) \mapsvia{\sigma_2} \qty{\mathcal{A}_K(A_2) + K} / \qty{\mathcal{A}_K(A_1) + K } \to 0
.\]
The first thing we did was compute the dimension of the middle quotient space, which was $\deg D_2 - \deg D_1$.
Note that $\sigma_2$ is a quotient map, but $\sigma_1$ just comes from embedding $K\injects \mathcal{A}_K$.
To show exactness, the only nontrivial part is that $\ker(\sigma_2) \subset \im(\sigma_1)$.
So take an element $\alpha\in \mathcal{A}_K(A_1) \mod \mathcal{A}_K(A_1)$ such that $\sigma_2(\alpha) = 0$, so there exists an $x\in K$ such that $\alpha-x \in \mathcal{A}_K(A_1)$ by definition of being zero in the last quotient.
Since $\mathcal{A}_K(A_1) \subseteq \mathcal{A}_K(A_2)$, we have that $x\in \mathcal{A}_K(A_2) \intersect K \da \mathcal{L}(A_2)$.
This follows because $\alpha, \alpha-x$ are both in $\mathcal{A}_K(A_2)$.
Thus we have
\[  
\alpha + \mathcal{A}_K(A_1) = x + \mathcal{A}_K(A_1) = \sigma\qty{x + \alpha(A_1)}
.\]
:::

:::{.proof title="Step 2"}
We can now compute the dimension of this quotient.
Using step 1 and Lemma 2.12, we get
\[  
\dim_k\qty{ \mathcal{A}_K(A_2) + K } / \qty{ \mathcal{A}_K(A_1) + K }
&= \dim_k \mathcal{A}_K(A_2) / \mathcal{A}_K(A_1) - \dim_k \mathcal{L}(A_2) / \mathcal{L}(A_1) \\
&= \qty{\deg A_1 - \ell(A_2) } - \qty{\deg A_1 - \ell(A_1) } \\
&= \iota(A_1) - \iota(A_2)
,\]
where the last step follows from adding and subtracting $g-1$.
:::

:::{.proof title="Step 3"}
By step 2, it is enough to show that for all $A_1 \in \Div K$, there exists a bigger divisor $A_2 \geq A_1$ such that $\iota(A_2) = 0$ (by just adding closed points) and $\mathcal{A}_K(A_2) + K = \mathcal{A}_K$.
By Riemann's inequality, we have $\iota(A_2) =0$ if $\deg A_2 \gg 0$, so choose such an $A_2 \geq A_1$.
Thus we're reduced to showing that if $\iota(B)  = 0$ for all $B\in \Div K$, then $\mathcal{A}_K = \mathcal{A}_K(B) + K$.
We'll do this by choosing another large effective divisor.[^cone_structure]

Let $B_1 \geq B$, then we have
\[  
\ell(B_1) 
&\leq \deg(B_1) + \ell(B) - \deg(B) \\
&= \deg(B_1) - g + 1
.\]
Also, Riemann's inequality gives $\ell(B_1) \geq \deg(B_1) - g + 1$, so we have equality.
Thus any divisor greater than or equal to a non-special divisor is again non-special.
\

We want to take an arbitrary element of the Adele ring and show that it differs from an element of the adelic Riemann-Roch space associated to $B$ by an element of $K$, so we'll cleverly choose a divisor in order to do this.
So take an arbitrary element $\alpha\in \mathcal{A}_K$ of the Adele ring, then we may choose $B_1 \geq B$ such that $\alpha\in \mathcal{A}_K(B_1)$.
I.e., choosing $B_1$ large enough is allowing the poles to be however bad you want them to be, and $\alpha$ is a fixed element, all but finitely many elements have valuation $\geq 0$.

We understand the relative situation well, based on what we proved.
By step 2, since $B, B_1$ are non-special, the dimension of the quotient is zero:
\[  
\dim_k(\mathcal{A}_K(B_1) + K) / (\mathcal{A}_K(B) + K) 
&= \deg \qty{B_1 - \ell(B_1)} - \qty{\deg B - \ell(B) } \\
&= (g-1) - (g-1) \\
&= 0
.\]
But then these spaces are equal to each other, so $\mathcal{A}_K(B_1) + K = \mathcal{A}_K + K$.
But we chose $B_1$ arbitrarily large so it contained $\alpha$, and we found that the resulting space is no bigger than the original.
Note that $B_1$ was chosen so that $\alpha\in \mathcal{A}_K(B_1)$ before adding $K$, which remains true when adding $K$.
But this says $\alpha$ is in the LHS, which equals the RHS.
Then $\alpha \in \mathcal{A}_K(B)$, where $\alpha$ was arbitrary, so $\alpha\in \mathcal{A}_K(B) + K$.

[^cone_structure]: This "cone structure" on divisors is very useful!

:::

:::{.corollary title="2.14"}
This can be applied to the zero divisor:
\[  
\dim_k \mathcal{A}_K( \mathcal{A}_K(0) + K ) \iota(0) = g
.\]
:::

:::{.exercise title="?"}
Corollary 2.14 shows that if $K = k(t)$ is the rational function field, then we have $\mathcal{A}_K(0) + K = \mathcal{A}_K$.[^Adele_comment]
Show this directly.

[^Adele_comment]: So every Adele differs from a rational function by an effective Adele.

:::

:::{.remark}
Note that analogy to consider $\mathcal{A}(\QQ)$, where you get $\mathcal{A}_\QQ = \hat \ZZ + \QQ$, where $\hat \ZZ$ denotes the profinite completion.
Recall that $\AA_\QQ = \prod_p' \QQ_p \cross \RR$, and inside of this we have $\AA(0) \da \prod_p \ZZ_p \cross \RR$.
Not too crazy of a fact: given an Adele, it has finitely many places where its $p\dash$adic valuation is negative, so it shouldn't be hard to find a rational number as a correction term which doesn't change the valuation.
The fact that this works for $\QQ$ is related to $\ZZ$ being a PID.
:::

# Lecture 11B: Weil's Proof of Riemann-Roch (TODO)

# Lecture 11C: Weil's Proof of Riemann-Roch (TODO)

# Lecture 12: Chapter 3, Curves Over a Finite Field

## Finiteness of Class Groups

We consider $k= \FF_q$ a finite field, which by definition is a one variable global function field.
Idea: we've defined some affine dedekind domains (the holomorphy rings) had a finite nonempty set of places of the function field.
These are analogous to the ring of integers of a number field, or more generally $S\dash$integer rings.
Recall some basic results from NT1: the finiteness of the class group, and the finite generation of the unit group.
Here we have a class groups of affine Dedekind domain, and by Rosen's theorem, there are infinitely many as you vary over nonempty subsets of places of the function field, and they're all closely connected to a geometric class group: the degree zero divisor class group.
Thus by this analogy, when the field is finite, we'd expect that $\Cl^0(K)$ is finite as well, which is the main result we'll prove today.

## Base Extension

Let $K_{/\FF_q}$ be a one variable function field with constant field $\FF_q$, so that the only elements of $K$ that are algebraic over $\FF_q$ are already in $\FF_q$.
Since $\FF_q$ is a perfect field ($x\mapsto x^p$ is a surjection), every such function field is regular.

Let $\bar{\FF}_q$ be an algebraic closure, then for all $r\in \ZZ^+$ there exists a unique degree $r$ extension, which we'll denote $\FF_{q^r}$.
The extension $\FF_{q^r}/\FF_q$ is a cyclic galois extension (i.e. it's galois group is cyclic) with a canonical generator: the Frobenius map.

The galois theory of the constant field comes in when trying to study constant extensions of the function field.
There is a general theory of constant extensions, but in our case, every such extension will be cyclic or procyclic, so we don't need the entire theory.

For any positive integer $r$, define the extension $K_r \da K \FF_{q^r}$ given by extending scalars, which is a regular function field over $\fqr$.
There are two ways to obtain this: either take an algebraic closure of $K$ and take the compositum, or take $K\tensor_{\fq}\fqr$, which we proved was again a field.
This $K_r$ is what we get by extending constants, and the way regular function fields work is that if you make an arbitrary extension of the ground field, then you retain a regular function field over this new extension.
On the other hand, note that $K_R/K$ is a degree $r$ arithmetic extension of function field, whose galois group is also generated by Frobenius.
If we take any regular function field over $k$ and then take a finite galois extension $l/k$, then extending scalars in this way would give an extension of the upstairs fields which is galois and has the same galois group as the constant extension.
This is *arithmetic* because the only thing that changes going from $K$ to $K_r$ is the field of constants.

In the analogy of function fields as the meromorphic functions on a Riemann surface, this type of extension has no analog: since $\CC$ is algebraically closed, there are no constant extensions.
So arithmetic extensions are just extending scalars, and *geometric* extensions  don't change the constant field at all and instead have the property that if you extended scalars to the algebraic closure, you'd have an extension of the same degree.
Note that the étale fundamental group also has a similar decomposition into an arithmetic part and a geometric part (see Daniel Litt's course).

### Splitting of Places

:::{.question}
Given a place in $K$, how does it split (or not) in $K_r$?
:::

:::{.remark}
We can ask this question in whenever we have an extension of function fields.
This reduces to the usual ATI type of question: for $v\in \Sigma(K/\fq)$, choose an affine Dedekind domain $R$ such that $v\in \Sigma(K/R)$, i.e. the place is regular.
Let $S$ be the integral closure of $K$ in $K_r$; this place corresponds to a maximal ideal $\mathfrak{p}$, we then want to factor its pushforward $\mathfrak{p}_v S$.
So this question is a special case of how a prime ideal factors in an extension of Dedekind domains.
:::

We'll temporarily black-box the following lemma:

:::{.lemma title="?"}
Suppose $v$ is the downstairs place, $r$ is the degree of the extension, and $d\da \deg(v)$.
Then 

- $K_r/K$ is galois and we have $efg = r$.[^residual_degree_expl]

- This extension will be unramified: we in fact have $e=1$, so $g = \gcd(d, r)$ and $f = r/\gcd(d, r)$, and

- Each place $w\in \Sigma(K_r/\fqr)$ lying over $v$ has degree $d/\gcd(d, r)$.

[^residual_degree_expl]: $e$ is the prime ramification index, $f$ is the prime residual degree, and $g$ is the number of distinct primes. 
This result essentially comes from ANTI, replacing $\sum e_i f_i = r$.

:::

:::{.remark}
Note that having an extension of Dedekind domains coming from a galois extension of fields simplifies things: this makes the inertial degree and ramification indices coincide.
:::

:::{.example title="?"}
\envlist
- The extension is inert $\iff$ $\gcd(d, r) = 1$

  - I.e. $d, r$ are coprime and $g=e=1, f=r$.

- The extension splits completely $\iff$ $r \divides d$.

  - If $r=d$, i.e. we take a degree $d$ place and extend scalars to $K_d$, it splits completely into $d$ degree 1 places.

- All $w\divides v$ have degree 1 $\iff$ $d\divides r$.

:::

:::{.remark}
Suppose we have $w$ over $v$ with $w\in \Sigma(\fqr)$ and $v\in \Sigma(K/\fq)$.
If $v$ has degree $d$, this means that the residue field satisfies $k(v) \cong \FF_{q^{d}}$, since we have unique extensions in each degree.
If $f$ is the $f$ from ANTI, it is also the degree of the residual extension, so we know $[k(w): k(v)] = f$ and thus $k(w) \cong  \FF_q^{f d}$.

On the other hand, $k(w)$ is an extension of $\fqr$ of degree $\deg(w)$, so $k(w) \cong \FF_{ \qty{q^r}^{\deg(w)} } = \FF_{q^{r\deg(w)}}$.
Thus $r=fg$ and
\[  
q^{f\deg(v)} = q^{r\deg(w)} \implies \deg(w) = \qty{f\over r}\deg(v) = { \deg(v) \over g}
.\]

The residue field, if it changes at all, can only increase in size, since any extension of Dedekind domains induces an extension of residue fields.
So the size of the residue field of $w$ is at least as big as the size of the residue field of $v$.
But the degree of $w$ is measured relative to the extended field $\fqr$, since it's the degree of the residue field as an extension of $\fqr$.
So consider $\deg(w) = \deg(v)/g$, we see that even as the residue field is increasing by a factor of $f$, the degree of the point is decreasing by a factor of $g$.

**Upshot**:
The residue field grows, but its degree can only shrink.
Thus making an extension forces the degrees of the upstairs places to *decrease*.
:::

We're trying to find out in how many ways a discrete valuation extends to a finite degree field extension.
From ANTII, we have a result that describes this: if $v$ is a rank 1 valuation on $k$ and $L/K$ is a finite degree extension, then the extensions of $v$ to $L$ correspond with $\mspec(\hat{K}_v \tensor_K L)$, where the hat denotes completing $K$ with respect to the valuation. 
The $e,f,g$ can all be computed as well.[^pete_note_164]

[^pete_note_164]: See Pete's NTII notes, Theorem 1.64.

This is some finite degree $\hat{K}_v$ algebra, and if $L/K$ is separable then this decomposes as a finite product of finite degree field extensions of $K$ and $\hat{K}_v$, the number of which will be $g$.
The $e$ and $f$ can be read off because each extension will have a ramified and unramified part.


:::{.exercise title="?"}
\envlist

a. Show that $\FF_{q^d} \tensor_{\FF_q} \FF_{q^r} \cong  \FF_{q^l}^{d'}$ where $l = \lcm(d, r)$ and $d' = \gcd(d, r)$.

b. Generalize this to the case when $k_p / k$ and $\ell / k$ are both cyclic galois extensions.

:::

## Degree 1 Places and Rational Points on a Curve


Taking the lemma as a black box, for $r\in \ZZ^+$ let $N_r \da \abs{\Sigma_1(K_r/ \fqr) }$, i.e. the number of degree 1 places of the function field after making a degree $r$ extension.
Equivalently, $N_r = \abs{C(\fqr)}$ where $C$ is a unique complete nonsingular curve over $\fq$ corresponding to $K$, and this denotes the number of $\fqr$ rational points.
We'll eventually see these are finite.

:::{.remark}
Important way of thinking about these: degree one places of a function field over $k$ correspond to $k\dash$rational points of a curve.
:::

:::{.corollary title="Equivalence of data: places and rational points"}
\[  
N_r = \sum_{d\divides r} d\cdot \abs{\Sigma_d(K/ \fq)}
,\]
so knowing the number of closed points of each degree is equivalent to knowing the $\fqr\dash$points for all $r$.
:::

:::{.proof title="?"}
Let $w\in \Sigma_1(K_r/\fqr)$ be a degree 1 point and set $v \da w\intersect K$ so $w$ lies over $v$.
What is the degree of $v$?
Setting $d \da \deg(v)$, the lemma gives 
\[  
1 = \deg(w) = {d\over \gcd(d, r)}
,\]
which implies that $\gcd(d, r) = d$ and thus $d\divides r$.
So for each $d$ dividing $r$, every degree of $v\in \Sigma(K/\fq)$ contributes $\gcd(d, r) = d$ degree 1 points on $K_r$, i.e. every downstairs degree $d$ place splits into $d$ degree one places.
So for every such $d$, every degree $d$ closed point contributes $d$ degree 1 closed points lying above it, and conversely if $d$ does not divide $r$ then the upstairs point would not have degree 1, so this accounts for all of the degree 1 points.
:::

:::{.remark}
We saw that the degree 1 places and the rational points are the same information, and there is a third equivalently quantity: $A_n$, defined to be the number of effective divisors of degree $n$.
:::

## Finiteness of Places and Rational Points

:::{.lemma title="?"}
\envlist

a. For all $d$, the number of degree $d$ closed points $\Sigma_d(K/\fq)$ is finite (and therefore $N_r$ is finite), and

b. For all $n$, $A_n$ is finite.
:::

:::{.proof title="of a"}
Let $L/K$ be a degree $n$ extension of regular function fields over $\fq$.
We then have a restriction map
\[  
r: \Sigma(L/\fq) \surjects \Sigma(K/\fq)
\]
which we showed is surjective with finite fibers.
We can say a little bit more: for all places $w \in \Sigma(L/\fq)$, we have an inequality
\[  
\qty{1\over n}\deg(w) \leq \deg(r(w)) \leq \deg(w)
,\]
noting that we're now measuring all degrees over a common ground field $\fq$.
So things are now what you'd expect: the degree of the upstairs point is a multiple of the degree of the downstairs point.
The upper bound comes from the fact that the residue of the upstairs point is a finite extension of the residue field of the downstairs points.
The opposite inequality comes from ANTI: the degree of the residual extension is at most the degree of the entire extension.

So $r$ doesn't preserve degrees exactly, but preserves them up to a bounded factor, and thus $\Sigma_{\leq d}(L/\fq)$ is finite for all $d$ $\iff$ $\Sigma_{\leq d}(K/\fq)$ is finite for all $d$.
Because of this, we can reduce the situation by exchanging the function field $L/\fq$ with any other function field for which $L$ is a finite extension, and in particular we can take the rational function field $K = \FF_q(t)$.
What are the degree $d$ places of a rational function field?
There is exactly one place at infinity, and the remaining ones correspond to monic irreducible polynomials.
Since $\fq$ is finite, there are only finitely many such polynomials of any fixed degree.[^exact_formula]

[^exact_formula]: There is an exact formula for this quantity.

:::

:::{.proof title="of b"}
Left as an exercise.

Some remarks: how do you build an effective divisor of degree $n$?
Take closed points (places) and start adding them up with positive coefficients, then the degree of the divisor is the sum of the degrees of the places.
But if you only have finitely many places, each of which can only be used a bounded number of times (certainly no more than $n$ times!), thus one can only build finitely many effective divisors of each degree.
:::

## Finiteness of Class Group


:::{.proposition title="Finiteness of class group"}
The degree 0 divisor class group $\Cl^0(K)$ is finite.
:::

This is a geometric analog of the finiteness of the class group of the ring of integers of a number field.
By Rosen's theorem, as an immediate corollary, the class group of any affine dedekind domain over a finite ground field is finite.
This follows from looking at the exact sequence: a finite index subgroup of the class group of any dedekind domain is a quotient of $\Cl^0(K)$, and a finite index subgroup of a finite group is finite.

:::{.proof title="?"}
Set $\delta \da I(K)$ to be the index, i.e. the least possible degree of a divisor.[^Shmidt_theorem]

[^Shmidt_theorem]: 
By a theorem of Schmidt, we'll later prove that $\delta = 1$.

In any case, for all $n\in \ZZ$, we have
\[  
\Cl^n K = 
\begin{cases}
0 & \delta\notdivides n \\
\abs{\Cl^0 K} & \delta\divides n
\end{cases}
.\]
If you have any degree $n$ divisors, then $\Cl^n K$ will be a coset of $\Cl^0 K$.
Here we just look at the degree map, which is a group morphism onto its image, of which all nonempty fibers have the same size.
Thus we may work with $\Cl^n K$ for $n\gg 0$.
\

In particular, choose $n\geq g$ the genus such that $\delta \divides n$, and let $D \in \Div^n K$.
A Riemann-Roch computation shows that $\ell(D)$, the dimension of the linear system, is at least $n-g+1$, and so we have $\ell(D) \geq 1$ and $D$ is linearly equivalent to an effective divisor.
This shows that the map taking effective degree $n$ divisors to $\Cl^n K$ taking a divisor to its divisor class (restricted to effective divisors) is surjective.
But we just saw that the set of effective degree $n$ divisors is finite -- it was built out of finitely many closed points of bounded degrees -- forcing $\Cl^n K$ to be finite.
The result follows because $\Cl^n K$ is a coset of $\Cl^0 K$, all of which have the same size, and the index is finite.
:::

:::{.definition title="Class Number of $K$"}
The **class number** of $K$ is defined as
\[  
h \da \abs{\Cl^0 K}
.\]
:::

:::{.remark}
There is a much fancier proof: there exists a $g\dash$dimensional abelian variety $A / \FF_q$, the *Jacobian variety* of $C/\FF_q$, such that $\Cl^0 K + A(\FF_q)$.
It is built out of the degree 0 divisor class group in some functorial way.
In particular, $A$ is a projective variety, and thus embeds into some $\PP^N_{/\FF_q}$, and so $\abs{A(\FF_q)} \leq \abs{\PP^N_{/\FF_q}} < \aleph_0$.
\

As one varies over all function fields over all finite fields, there will only be finitely many whose class number is bounded by some fixed $h_0$.
E.g. there are only finitely many function fields of class number 1, and these can be explicitly listed.
So $h\to \infty$ in some sense, which is not proved by showing that $\abs{A(\fq)} \to \infty$, and we'll instead prove it using methods closer to what we're seeing in this course.
:::

Up next: setting up the zeta function.

# Lecture 13: Splitting Places

Recall that we previously looked at the regular function fields: we took a function field in one variable and considered the class of function fields for which we could take any extension of the constant field that we wanted.
As long as the ground field is perfect, being regular is equivalent to the constant subfield being $k$ itself.
However, we haven't done anything with them yet!

If you take an algebraic closure of the finite ground field $\FF_q$, there is a unique subextension of degree $r$ for every $r$, so we call that $\FF_{q^r}$.
The extension $\FF_{q^r}/\FF_q$ is cyclic galois, with a geometric Frobenius $x\to x^q$.
Note that $\FF_{q^r}$ is the fixed field of $F^r$, the $r$th power of the Frobenius map.
We set $K_r \da K \FF_{q^r}$, which is a regular function field over $\FF_{q^r}$. 
Note that we could view this as a function field just over $\FF_q$, but it would not be regular.
Then $K_r/K$ is a degree $r$ arithmetic extension of function fields.

:::{.question}
What happens to places when making this scalar extension?
I.e., how to places in $K$ decompose in $K_r$?
:::

:::{.remark}
This is related to an Algebraic Number Theory I problem: for $v\in \Sigma(\kfq)$ above an affine Dedekind domain $R$ such that $v\in \Sigma(K/R)$, let $S$ be the integral closure of $K$ in $K_r$.
Then we want to factor $p_v S$?
\todo[inline]{Not quite sure.}
:::

## How Places Split

:::{.lemma title="Key lemma about how places split."}
Suppose $d\da \deg(v)$.
Then $K_r/K$ is galois, so we have $efg=r$.
In fact, $c=1$, so $f = {r\over \gcd(d, r)}$ and $g = \gcd(d, r)$ and each place $w\in \Sigma(K_r / \FF_{q^r})$ has degree ${d\over \gcd(d, r)}$.
:::

:::{.remark}
We have the following cases:

- The extension is *inert* iff $\gcd(d, r) = 1$,

- The extension *splits completely* iff $r\divides d$,

- All $w$ dividing $v$ have degree 1 iff $d\divides r$.

:::

The last thing we proved was that the degree zero divisor class group is finite when we're over a finite ground field.
Why is this true?
Whenever there is a divisor of degree $n$, then the set of degree $n$ divisors is a coset of the degree zero divisors, all of which have the same cardinality.
We proved finiteness using the Riemann-Roch theorem, using the fact that the set of *effective* degree $n$ divisors is finite for all $n$.

The next main topic will be the **zeta function**, which keeps track of three equivalent packets of information: $A_n$, the number of effective divisors of degree $n$, the number of places of degree $d$ (since an effective divisor is a linear combination of these), and $N_r$ the number of degree 1 points in the degree $r$ extension, i.e. the number of $\FF_{q^r}$ rational points.

## Counting Effective Divisors

:::{.lemma title="?"}
Suppose $C\in \Cl(K)$, then 

- The number of effective divisors $D \in [C]$ is given by 
\[  
{q^{\ell(C)} -1 \over q-1} 
,\]
  where $\ell(C)$ is the dimension of the linear system associated to the divisor class $C$, and this is the dimension of a projective space over $\FF_q$.

- For all $n>2g-2$ with $\delta \divides n$, we have
\[  
A_n = h \qty{ q^{n+1-g} - 1\over q-1}
.\]
:::

:::{.proof title="?"}
\envlist

**Proof of (a)**:
The set of effective divisors linearly equivalent to $D$ is naturally viewed as the projectivization $\PP \mathcal{L}(D)$ of the one-dimensional subspaces of the linear system of that divisor class.
It is then a fact that the number of elements in a $d\dash$dimensional vector space over $\FF_q$ has dimension precisely $\frac{q^d-1}{q-1}$ elements.
The projectivization comes in because two different functions have the same divisor if one of them is a constant multiple of the other.
Note that the number of elements is computed as the number of nonzero elements divided by the number of nonzero scalars.
\

**Proof of (b)**:
This will come out of the Riemann-Roch theorem.
In order to compute the number of divisors in a divisor class, you need to know the dimension of the linear system, which is not easy in general.
However, if the divisor class has sufficiently large degree, the Riemann-Roch theorem tells you exactly what it is.
As long as $n > 2g-2$, there is no correction term, and the dimension of the linear system is equal to its degree minus the genus plus one.
So by Riemann-Roch, since $\deg(D) > 2g-2$, $D$ is non-special and $\ell([D]) = n-g+1$, which yields the desired formula for $A_n$.

:::

:::{.remark}
This is the sharpest result possible: the canonical divisor has degree $2g-2$ and is special, so this fails for the canonical class.

The upshot: there are three piece of information:

- $N_r$, the number of $\FF_{q^r}$ rational points,

- $\abs{\Sigma_d(\kfq)}$ the number of closed points / places of degree $d$,

- $A_n$ the number of effective divisors of degree $n$,

and there are simple formulas relating these.
Moreover, it is enough to know only finitely many of these quantities, where the number depends on $g$.
:::


## Hasse-Weil Zeta Functions

There is a general theory that will unify 

- The Riemann zeta function, thought of as the zeta function of $\ZZ$, 

- The Dedekind zeta function, attached to the ring of integers over a number field,

- The Hasse-Weil zeta function of a one variable function field over a finite field,

all of which will be special cases of a *Serre zeta function* which can be attached to a finite type scheme over $\ZZ$.

Note that we aren't specifically discussing schemes in this course, but you don't need to know much about what a scheme is to define the Hasse-Weil zeta function. 
Just note that an affine finite-type $\ZZ\dash$scheme corresponds to a finitely generated $\ZZ\dash$algebra, and a general finite-type $\ZZ\dash$scheme will be covered by finitely many affine ones, the zeta function will be determined by these finitely many $\ZZ\dash$algebras and some kind of inclusion-exclusion principle (since the scheme is a not necessarily disjoint union of affine schemes).

Recall that $A_n = A_n(K)$ is the number of effective divisors of degree $n$, which we've proved is finite.
We have a formula when $n> 2g-2$, namely
\[  
Z(t) = \sum_{n=0}^\infty A_n t^n = \sum_{D\in \Div^+(K)} t^{\deg(D)} \in \ZZ[[t]]
,\]
where $\Div^+$ are the effective divisors and we've collected terms based on their degree.
This is analogous to the Dedekind zeta function of a number field $K$, a formal Dirichlet series which is given by
\[  
\zeta_K(s) = \sum_{I \in \mathcal{I}\qty{\ZZ_K^\bullet}} \abs{ \ZZ_K / I}^{-s}
.\]
where the sum is now over all of the nonzero ideals of the ring of integers, where we measure the size using the *norm*, i.e. the size of the residue field.
There's an analogy between integral ideals (vs fractional ideals) and effective divisors.
We could get an Euler product decomposition for the Dedekind zeta function by only considering prime ideals, since in a Dedekind domain all ideals factor uniquely into prime ideals.
In fact, any nonzero ideal is a linear combination of prime ideals.
Similarly, the effective divisors are linear combinations of effective divisors, so an Euler product expansion is possible here too.
If we take a prime ideal, since we're in a discrete valuation ring, we can consider the local ring at that point.
We can take the residue field, which in general won't be finite, but will be a finite extension.
So a reasonable measure of the size of a prime divisor would be the dimension of its residue field as a vector space over $K$.

Note that if we wanted to make these look even more similar to each other, we could define $a_n$ (depending on $\ZZ_K$) as 
\[
a_n = \abs{\ts{I \normal \ZZ_K \st \abs{\ZZ_K/I} = n}}
,\]
which allows us to write
\[  
\zeta_K(s) = \sum_{n=1}^\infty {a_n \over n^s}
.\]

:::{.question}
Where we're going: how does $Z(t)$ depend on $K$?
:::


:::{.answer}
It turns out that it only depends on $A_0, A_1, \cdots, A_{2g-2}$, and thus $Z(t)$ depends on only finitely much information.
We will 

1. Show that $Z(t) \in \ZZ(t)$, i.e. it is a rational function and can be written $Z(t) = P(t)/ Q(t)$.

  > Note: the denominator will always be the same, $(1-t)(1-qt)$, and we'll always have $\deg P = 2g$.
  > This is essentially coming from $\ell\dash$adic cohomology.
  > We'll also determine the leading coefficient.

2. Understand $\deg P$ and $\deg Q$ in terms of the genus $g$.

3. Ask about the roots of $P(t)$, and establish a Riemann hypothesis for Dedekind zeta functions (and in particular, the Riemann zeta function).

  > In particular, what are their magnitudes? 
  > This is what Weil did, this is the big theorem in this area.
  > Note that we'll need to consider reciprocal roots, which will end up having magnitude $\sqrt{q}$.
  > We'll see why this happens, and it turns out to be analogous to fact that the nontrivial zeros of the Riemann zeta function have real part $1/2$.

:::

These are approximately in order of difficulty.
The first two will follow from Riemann-Roch, but the third will be much deeper.
This is essentially a positive characteristic analogue of the usual Riemann hypothesis.
Note that we're in a global field, the positive characteristic analog of a number field, and for number fields the Riemann hypothesis is the single outstanding problem.
In the function field case, it is a theorem!


:::{.proposition title="Formula for the zeta function exhibiting rationality"}
Let $\kfq$ have genus $g$ and $\delta = I(K)$ the index, the least positive degree of a divisor.[^delta_note]

a. If $g=0$, then
\[  
Z(t) = {1\over q-1} \qty{{q \over 1-q^\delta t^\delta} - {1 \over 1-t^\delta}}
.\]

b. If $g\geq 1$, then $Z(t) + F(t) + G(t)$ where
\[  
F(t) 
&= {1\over q-1} \sum_{0\leq \deg C \leq 2g-2} q^{\ell(C)} t^{\deg(C)} \\
G(t)
&= {h \over g-1} \qty{
{ q^{1-g} (qt)^{2g-2+\delta} \over 1 - (qt)^\delta } - {1 \over 1 - t^\delta}
}
,\]
  so $F$ involves summing over all divisor classes of degree at most $2g-2$, and $G$ is a term coming from Riemann-Roch involving the class number $h$.

[^delta_note]: It will turn out (by a theorem of Schmidt) that $\delta = 1$ in the case of a finite ground field.

:::

:::{.remark}
Note that as a consequence, it will definitely be rational in $q$, and will have a simple pole at $t=1$.
There's no major idea for the proof: when the degree of the divisor class is sufficiently large, we just have an exact formula.
If it is smaller, than the formula involves the dimension of the linear system.
:::


## Proof of Rationality

:::{.proof title="of rationality of $Z(t)$"}
Recall that $\ell(C)$ is the dimension of the associated Riemann-Roch space.

When $g=0$, by Riemann-Roch we have $\Cl^0(K) = 0$ over any ground field $\kk$ (see exercises), and so $h=1$.
Since every $n\geq 0$ satisfies $n\geq 2g-2$ when $g=0$, if $\delta\divides n$ we have
\[  
A_n = h \qty{ q^{n+1 - g} - 1 \over q-1} = {q^{n+1} - 1 \over q-1}
,\]
and since $A_n=0$ unless $n$ is divisible by $\delta$, we have
\[  
Z(t) = \sum_{n=0}^\infty A_n t^n = \sum_{n=0}^{\infty} A_{\delta n} t^{\delta n} = \sum_{n=0}^\infty {q^{\delta n + 1} -1 \over q-1} t^{\delta n}
.\]
This can now be split into two terms, each of which will have a geometric series to sum.

Now let $g\geq 1$, and write
\[  
\infsum{n} A_n t^n = \sum_{\deg(C) \geq 0} \abs{\ts{ A\in C \st A\geq 0}}t^{\deg(C)}
,\]
where we instead count the number of divisors in each divisor class (a consequence of the previous lemma).
Continuing this computation, we separate out the part where $\deg(C) \leq 2g-2$ and pull out the $-1$ in the numerator:
\[  
\cdots 
&= \sum_{\deg(C) \geq 0} {q^{\ell(C)} - 1 \over q - 1}t^{\deg(C)} \\
&= \qty{1\over q-1} \qty{ \sum_{0\leq \deg(C) \leq 2g-2} q^{\ell(C)} t^{\deg(C)} 
+ \sum_{\deg(C) > 2g-2} q^{\deg(C) - g + 1} t^{\deg(C)} - \sum_{\deg(C) \geq 0} t^{\deg(C)}
} \\
&\da F(t) + G(t)
,\]

so we can write

\[  
F(t) &= {1\over q-1} \sum_{0\leq \deg(C) \leq 2g-2} q^{\ell(C)} t^{\deg(C)}
\\
(q-1)G(t) &= \sum_{n = {2g-2 \over \delta} + 1}^\infty  h q^{n\delta + 1 - g} t^{n\delta}  - \infsum{n} ht^{n\delta}
.\]

Note that $\delta\divides 2g-2$ since the canonical divisor has degree $2g-2$ and $\delta$ is a gcd.
Note that for $g=1$, the index divides zero, which tells you nothing about it!
This now reduces to some geometric series that can be summed, which shows these are rational functions in $t$.
:::

:::{.exercise title="?"}
Let $K = \FF_q(t)$, then $g=0, \delta = 1$, and
\[  
Z(t) = {1\over (1-qt)(1-t)}
.\]
We will see in general that the numerator is of the form $L(t)$ where $L\in \ZZ[t]$ has degree $2g$.
:::

Note that this all generalized to higher dimensional projective varieties $X_{/\FF_q}$, for which these properties were proved by the work of Deligne.
In general, $Z(t)$ will be of the form
\[  
Z_X(t) = {L_1(t) \cdots L_{2d-1}(t) \over L_0(t) \cdots L_{2d}(t)}
,\]
where $d = \dim(X)$ and $\deg L_i$ will be the dimension of the $i$th $\ell\dash$adic cohomology.
Moreover, if $X_{/\FF_q}$ is a reduction mod $q$ of a variety in characteristic zero, these will be the Betti numbers of $X_{/\CC}$.
If we take a compact Riemann surface, which has a honest topological genus of $g$, the Betti numbers are $1, 2g, 1$, and this recovers the formula above for $L(t)$ and its degree.

The next result will be the following theorem:

:::{.theorem title="Schmidt, 1910ish"}
For all $\kfq$,
\[  
\delta = I(K) = 1
.\]
:::
This will greatly simplify the previous formulas.
A useful application is if you have a genus zero curve of index 1, applying Riemann-Roch  to a divisor of degree 1 shows that the function field is rational.
Thus the only genus zero function field over $\FF_q$ is the rational function field.
Useful aside: the Riemann hypothesis here gives an estimate of the number of $\FF_{q^r}$ rational points.

# Lecture 14: The Hasse-Weil Zeta Function

Recall the that *Hasse-Weil zeta function* of a one-variable function field $K/\FF_q$ over a finite ground field is defined in the following way: 
let $A_n = A_n(K)$ be the number of effective divisors of degree $n$.
We have proved that $A_n$ is finite, and for $n>2g-2$ we have a formula
\[  
Z(t) = \sum_{n=0}^\infty A_n t^n
= \sum_{D\in \Div^+(K)} t^{\deg(D)} \in \ZZ[[t]]
,\]
which is a formal power series with integer coefficients.

:::{.remark}
Recall that we have proved that it is a rational function of $t$, and in particular when $g=0, \delta = 1$
[^delta_def_reminder] we get
\[  
Z(t) = {1 \over (1-qt)(1-t)}
.\]

We got another expression which isn't fantastic: it involves this $\delta$, which we'll work toward proving is equal to 1.
When $g>1$, we broke the zeta function into two pieces $Z(t) = F(t) + G(t)$.
For divisors of sufficiently high degree, Riemann-Roch tells you what the dimension of the Riemann-Roch space is, and $G(t)$ explains the part coming from divisors of large degree.
We obtained a formula previously for $F(t)$ and $G(t)$, and once we show $\delta=1$ the formula for $G$ will simplify.
For $F(t)$, we specifically had
\[  
F(t) = {1\over q-1} \sum_{0\leq \deg(c) \leq 2g-2} q^{\ell(c) t^{\deg(c)}}
,\]
where the sum is over divisor classes and $\ell$ is the dimension of linear system corresponding to a divisor.
But this isn't a great formula: what are these classes, dhow many are in each degree, and what is the dimension of the Riemann-Roch space?

[^delta_def_reminder]: The *index* of the function field, least positive degree of a divisor.

:::

:::{.remark}
This is analogous to the Dedekind zeta function of a number field $K$, in which case
\[  
\zeta_K(s) = \sum_{T\in \ell(\ZZ_k)}^\bullet \abs{\ZZ_k/I}^{-s}
,\]
which will be covered in a separate lecture on *Serre zeta functions*.
:::

:::{.theorem title="F.K. Schmidt"}
For all $K/\FF_q$, we have $\delta = I(K) = 1$ where $I$ is the index.
:::

This will follow from the associated, but it much weaker.
However, this is one of the facts we'd like to establish to use to *prove* the Riemann hypothesis.

:::{.remark}
Pete studied this in 2004 and found that every $I\in \ZZ^+$ arises as the index of a genus one function field $K/\QQ$.
:::

Notation: for $n\in\ZZ^+$, let $\mu_n$ denote the $n$th roots of unity in $\CC$.

:::{.lemma title="?"}
For $m, r\in \ZZ^+$, set $d \da \gcd(m, r)$.
Then
\[  
\qty{1-t^{mr/d}}^d = \prod_{\xi\in \mu_r}  1 - (\xi t)^m
.\]
:::

:::{.proof title="?"}
In $\CC[x]$, we  have
\[  
(X^{r/1} - 1)^d = \prod_{\xi\in \mu_r}(X - \xi^m)
,\]
where both sides are monic polynomials whose roots include the $(r/d)$th roots of unity, each with multiplicity $d$.
On the LHS, the distinct roots are the $r/d$th roots of unity, then raising to the $d$th power gives them multiplicity $d$.
On the RHS, this is an exercise in cyclic groups: consider the $n$th power map on $\ZZ/r\ZZ$ and compute its image and kernel.
As $\xi$ ranges over $r$th roots of unity, $\xi^m$ ranges over all $r/d$th roots of unity, each occurring with multiplicity $d$.

Substituting $X= t^{-m}$ and multiplying both sides by $t^r$ yields the original result.[^special_case]

[^special_case]: 
Special case: set $m=r$, so $d=r$, then the RHS is $r$ copies of 1.

:::

## Comparing Zeta Functions After Extending Scalars

Next up, we want to compare the zeta function $Z(t)$ for a function field over $\FF_q$ to the zeta function obtained when extending scalars to $\QQ^r$.

:::{.proposition title="Factorization identity for the zeta function"}
Let $K/\FF_q$ be a function field, $r\in \ZZ^+$, and take the compositum $K_r$ of $K$ and $\FF_q^r$ viewed as a function field over $\FF_q^r$.
Let $Z(t)$ be the zeta function of $K/\FF_q$ and $Z_r(t)$ the zeta function of $K_r/\FF_q^r$.
Then
\[  
Z_r(t^r) = \prod_{\xi \in \mu_r} Z(\xi t)
.\]
:::

:::{.proof title="?"}
We have an Euler product formula
\[  
Z(t) = \prod_{p\in \Sigma(K/\FF_q)} (1 - t^{\deg(p)})^{-1} 
.\]
where the sum is over places of the function field.[^proving_euler_prod_rmk]

[^proving_euler_prod_rmk]: 
Proving this Euler product formula might show up in a separate lecture, but it is not any more difficult than proving it for the Riemann zeta function.

:::{.exercise}
Why is this product expansion true?
Write as a geometric series with ratio $t^{\deg(p)}$.
Here just expand each summand to get 
\[  
Z(t) = \prod_p \sum_{j=1}^\infty t^{j\deg(p)}
.\]
Multiplying this out and collecting terms is in effect multiplying out the prime divisors to get effective divisors.
:::

We now use the result about splitting that was stated (but not proved): 

:::{.claim}
If $p\in \Sigma_m(K/\FF_q)$ is a degree $n$ place and $r\in \ZZ^+$, then there exist precisely 
\[
d\da \gcd(m, r)
\]
places $p^r$ of $K_r$ lying over $p$, where each place $p^r$ has degree $m/d$.
:::

In order to compare $Z_r(t)$ to $Z(t)$, we collect the $p'$ into ones that have the same fiber.
We then can range over all $p$ first, then over all $p'$ in the fiber above $p$, yielding
\[  
Z_r(t^r) = \prod_{p\in \Sigma(K_{/\FF_q})} \prod_{p'/p} {1 \over 1 - t^{r\deg(p')}}
.\]

Using the Euler product identity, we have for $p\in \Sigma_m(K_{/\FF_q})$ and $d\da \gcd(m, r)$ we can express the innermost product as

\[  
\prod_{p'/p} {1 \over 1 - t^{r\deg(p')}} = (1 - t^{rm/d})^{-d} = \prod_{\xi\in \mu_r} (1- (\xi t)^m)^{-1}
,\]
where we've used the fact that we know there are exactly $d$ places and each contributes the same degree in the first expression.
By using $-d$ in the previous lemma, we get the last term.
Combining all of this yields
\[  
Z_r(t^r) 
= \prod_{\xi \in \mu_r} \prod_{p\in \Sigma(K_{/\FF_q})} (1- (\xi t)^{\deg p})^{-1} 
= \prod_{\xi \in \mu_r} Z(\xi t)
.\]
:::


:::{.remark}
Similar to taking an abelian extension of number fields and noting that the Dedekind zeta function factors into a finite product: the original zeta function, and in general, Hecke $L$ functions.
If you do this for an abelian number field over $\QQ$, then the Dedekind zeta function of the upstairs number field will be a finite product where one of the terms in the Riemann zeta function and the others are Dirichlet $L$ functions associated to certain Dirichlet characters.
So this is some (perhaps simpler) version of that.
:::

## Proof That $\delta = 1$

We can finally prove Schmidt's theorem that $\delta = 1$:

:::{.proof title="$\delta = 1$"}
Take a $\delta$th root of unity $\xi \in \mu_\delta$.
Then for all places $p \in \Sigma(K_{/\FF_q})$, $\delta$ divides $\deg p$ by definition since it is a gcd, and so we have
\[  
Z(\xi t) 
= \prod_{p\in \Sigma(K_{/\FF_q})} (q - (\xi t)^{\deg p} )^{-1} 
= \prod_{p\in \Sigma_{K_{\FF_q}}} {1 \over 1 - t^{\deg p}} = Z(t)
,\]
using the fact that $\xi^{\deg p} = 1$.

We're now in a situation where we can apply the previous proposition, which gives the following identity for the zeta function over the degree $\delta$ extension:
\[  
Z_{\delta}(t^\delta) = \prod_{\xi \in \mu_\delta} Z(\xi t) = Z(t)^\delta
.\]

Our previous formulas show that any zeta function for a 1-variable function field over a finite field has a simple pole at $t=1$, and since $\ord_{t-1}(t^\delta) = 0$, we get
\[  
-1 = \ord_{t-1} Z_\delta(t^\delta) = \ord_{t-1} Z(t)^\delta) = -\delta
,\]
where for the first equality we're using the fact that the $(t-1)\dash$adic valuation of $Z_\delta(t^\delta)$ is one, and for the RHS, the ordinary zeta function has a simple pole at $t=1$ and since we have a valuation, raising something to the $\delta$th power is just $\delta$ times the original valuation.

:::

There is some modest representation theory (character theory) that shows up when looking at zeta functions of abelian extensions.

:::{.remark}
We can also conclude that every genus zero function field $\kfq$ is isomorphic to $\FF_q(t)$ and thus rational, since such a function field rational iff it has index one.
Why?
By Riemann-Roch, index one implies existence of a divisor of degree one, and taking a genus zero curve says that every divisor of nonnegative degree is linearly equivalent to an effective divisor.
Thus if you have a divisor of degree one, you have an effective divisor of degree one, which makes the function field a degree one extension of a rational function field.
:::

:::{.exercise title="?"}
Let $K = \FF_q(t)$, then show that $g=0, \delta = 1$, and
\[  
Z(t) = {1 \over (1-qt)(1-t)}
.\]

> Hint: go back to complicated formulas and substitute $\delta=1$ to simplify things.

:::

Thus for rationality of the zeta function, we can get rid of the $\delta$ cluttering up formulas.


## The Functional Equation

Going back to the plan, we wanted to show

1. Rationality: $Z(t) \in \QQ(t)$ and thus $Z(t) = P(t) / Q(t)$,

2. Understand the degrees of $P$ and $Q$ in terms of the genus, and

3. Ask about the roots of $P(t)$ to understand the analog of the Riemann Hypothesis for Dedekind zeta functions

We'll want to establish a functional equation, as is the usual yoga for zeta functions, since it helps establish a meromorphic continuation to $\CC$.
The algebraic significance of the functional equation is that it aids in understand several equivalent packets of data:

- The number of effective divisors of a given degree,

- The number of places of a given degree,

- The number of rational points over each finite degree extension of the base field.


:::{.theorem title="Functional Equation"}
Let $\kfq$ be a function field of genus $g$, then
\[  
Z(t) = q^{g-1} t^{2g-2} Z\qty{1\over qt}
.\]
:::

:::{.proof title="?"}
For $g=0$, we know that 
\[  
Z(t) = {1 \over (1-t)(1-qt)}
,\]
and plugging in ${1\over qt}$ is a straightforward calculation.
So assume $g\geq 1$.

The idea was that we wrote $Z(t) = F(t) + G(t)$.
The $F(t)$ piece came from summing over divisor classes of degree between $0$ and $2g-2$ and recording the dimension of the associated linear system.
The tricky piece $G(t)$ came from summing an infinite geometric series to get a more innocuous closed-form expression of a rational function.
So the strategy here is to separately establish the functional equation for each of $F$ and $G$ separately.
How to do this: for $g=0$, there was no $F(t)$ piece. 
If we have a closed form it's just a computational check.
For $F(t)$, we'll use our greatest weapon and dearest ally, the Riemann-Roch theorem.
This will provide the extra symmetry we need.

We essentially already applied Riemann-Roch to $G(t)$ to get the closed-form expression, but we haven't applied it to the small degree divisors.
This doesn't tell you what the dimension is, but rather gives you a duality result: ti gives the dimension in terms of the dimension of a complementary divisor.

Take a canonical divisor $\mathcal{K} \in \div(K)$, so $\deg \mathcal{K} = 2g-2$.
As $C$ runs through all divisor classes of $\mathcal{K}$ of degree $d$ with $0\leq d \leq 2g-2$, so does the complementary divisor $\mathcal{K}-C$.

We can thus write

\[  
(q-1) F(t) 
&= \sum_{0 \leq \deg C \leq 2g-2 } q^{\ell(C)} t^{\deg(C)} \\
(q-1)G(t)
&= h \qty{ {q^g t^{2g-1} \over 1-qt} - {1 \over 1-t} }
.\]

We can thus compute
\[  
(q-1) F\qty{1\over qt}
&= \sum_{0\leq \deg C \leq 2g-2} q^{\ell(C)} \qty{1\over {qt} }^{\deg C} \\
&= \sum_{0\leq \deg C \leq 2g-2} q^{\ell(\mathcal{K} - C)} \qty{1\over {qt} }^{2g-2-\deg C}
,\]
where in the second step we've exchanged $C$ for $\mathcal{K}- C$ and noted that $\deg(\mathcal{K}-C) = 2g-2-\deg(C)$.
We now do the calculation another way,
\[  
(q-1) F(t) 
&= \sum_{0\leq \deg C \leq 2g-2} q^{\ell(C)} t^{\deg C} \\
&=
q^{g-1} t^{2g-1} \sum_{0\leq \deg C \leq 2g-2} q^{\deg(C) - (2g-2) + \ell(\mathcal{K}-C)} t^{\deg(C) - (2g-2)} && \text{by Riemann-Roch} \\
&= q^{g-1} t^{2g-2} \sum_{0 \leq \deg C \leq 2g-2} q^{\ell(\mathcal{K} - C)} \qty{1\over qt}^{\deg(\mathcal{K} - C)} \\
&= q^{g-1} t^{2g-2} (q-1) F\qty{1\over qt}
.\]
where we've used Riemann-Roch to find that $\ell(C) = \ell(\mathcal{K}-C) + \deg(C) - g + 1$.
Cancelling the common factor of $(q-1)$ establishes the functional equation for $F(T)$.

Now using the fact that $\delta = 1$, we have
\[  
(q-1)G(t) = h \qty{ {q^g t^{2g-1} \over 1-qt} - {1\over 1-t} }
,\]
and thus
\[  
(q-1) q^{g-1} t^{2g-2} G\qty{1\over qt}
&= hq^{g-1} t^{2g-2} \qty{q^g \qty{1\over qt}^{2g-1} - {1\over 1 - q \qty{1\over qt}} - {1\over 1 - {1\over qt}} } \\
&=
h\qty{ {-1\over 1-t} + {q^g t^{2g-1} \over 1-qt}} \\
&= (q-1) G(t)
,\]
which establishes the functional equation for $G(t)$.
:::

## The $L$ Polynomial

:::{.definition title="The $L$ Polynomial"}
\[  
L(t) \da (1-t) (1-qt)  Z(t) \in \ZZ[t]
.\]
:::

This clears the denominators in $Z(t)$, so this is now a polynomial of degree at most $2g$.
We can thus rewrite
\[  
Z(t) = {L(t) \over (1-t)(1-qt)} = {a_{2g} t^{2g} + \cdots + a_1 t + a_0 \over (1-t)(1-qt)}
.\]
Note that if we know $L(t)$, then we know $Z(t)$, and in particular we would like to know what the coefficients $a_j$ are.
We'll be able to determine $a_0 = 1$ in all cases, as well as $a_{2g}$ in all cases pretty easily.
So it looks like it only remains to compute $a_1, \cdots, a_{2g-1}$, but the functional equation will give a "mirror" relation between pairs of coefficients.
The upshot is that the functional equation shows that we only need to know $a_1, \cdots, a_g$ to completely determine $Z(t)$.
If $g=1$, just one coefficient suffices.
It turns out that $a_1$ will be $q+1$ minus the number of degree one places.

:::{.question}
\envlist

- What are the constraints on these quantities? 

- Can we write the zeta function in a nice way?

- Exactly what do we need to compute to determine it?

:::


It will turn out that computing the number of rational points over $\FF_{q}, \FF_{q^2}, \cdots, \FF_{q^g}$ will be possible.
For example, for a hyperelliptic curve, we'll have an explicit defining equation and can make an explicit point count, and you only need $g$ of them.

# Lecture 15: The $L\dash$Polynomial

## Big List of Important Facts 

Recall that we had $Z(t) + F(t) + G(t)$:

\[  
(q-1) F(t) 
&= \sum_{0 \leq \deg C \leq 2g-2 } q^{\ell(C)} t^{\deg(C)} \\
(q-1)G(t)
&= h \qty{ {q^g t^{2g-1} \over 1-qt} - {1 \over 1-t} }
.\]

Note that $F(t)$ is a polynomial of degree at most $2g-2$, and clearing denominators in $G(t)$ yields a polynomial of degree at most $2g$


:::{.definition title="The $L\dash$polynomial"}
The $L\dash$polynomial is defined as
\[  
L(t) \da (1-t)(1-qt) Z(t) = (1-t)(1-qt) \sum_{n=0}^\infty A_n t^n \in \ZZ[t]
.\]
:::

It turns out that the degree bound of $2g$ is sharp, and the coefficients closer to the middle are most interesting:

:::{.theorem title="?"}
Let $K/\FF_q$ be a function field of genus $g\geq 1$, then

a. $\deg L = 2g$.
b. $L(1) = h$
c. $L(t) = q^g t^{2g} L\qty{1\over qt}$.
d. Writing $L(t) = \sum_{j=1}^{2g} a_j t^{j}$,

  - $a_0 = 1$ and $a_{2g} = q^g$.
  - For all $0\leq j \leq g$, we have $a_{2g-j} = q^{g-j}a_j$.
  - $a_1 = \abs{\Sigma_1(K/\fq)} - (q+1)$, which notably does not depend on $g$.

- Write $L(t) = \prod_{j=1}^{2g} (1 - \alpha_j t) \in \CC[t]$ [^why_this_expansion]

e. The $\alpha_j \in \bar{\ZZ}$ [^algebraic_ints_note]
(which were *a priori* in $\CC$) and can be ordered such that for all $1\leq j \leq g$, we have $a_j a_{g+j} = q$. [^hint_at_rh]

f. If $L_r(t) = (1-t)(1-q^rt) Z_r(t)$ then $L_r(t) = \prod_{j=1}^{2g}(1-\alpha_j^r t)$, where $K_r$ is the constant extension $K \fqr /\fqr$

[^hint_at_rh]: This is the first hint at the Riemann hypothesis: if for example they all had the same complex modulus, this would force $\abs{a_j} = \sqrt q$.
Thus proving that they all have the same absolute value is 99% of the content!

[^algebraic_ints_note]: $\bar \ZZ$ denotes the algebraic integers.

[^why_this_expansion]: The polynomial isn't monic, but rather has a constant coefficient, so this expansion is somewhat more natural than (say) $\prod (t-\alpha)$.

:::

Note that the $\alpha_j$ are reciprocal roots.

## Proofs

### The degree of $L$ and $L(1)$

:::{.proof title="of a"}
We saw from $Z(t) = F(t) + G(t)$ that $\deg L \leq 2g$.
Equality will follow from the proof of (d) part 1, since this would imply that $a_{2g} = q^g \neq 0$.
:::

:::{.proof title="of b"}
Our formula $Z(t) = F(t) + G(t)$ and Schmidt's theorem (showing $\delta = 1$) gives
\[  
L(t) = (1-t) (1-qt) F(t) + {h \over q-1} \qty{ q^g t^{2g-2} (1-t) - (1-qt)}
,\]
where we've expanded $G$ but not $F$ because it involves various $\ell(D)$ which are difficult to compute. 
It is some polynomial though, and we can evaluate $L$ at 1 to get $L(1) = h$.
Thus the class number is the sum of the coefficients!
:::

### Functional Equation

:::{.proof title="of c"}
This follows easily from the functional equation for $Z(t)$, which we already established using the Riemann-Roch theorem:
\[  
Z(t) = q^{g-1} t^{2g-2} Z\qty{1\over qt}
.\]
We can compute
\[  
q^g t^{2g} L\qty{1\over qt} 
&= q^g t^{2g} \qty{1 - {1\over qt}} \qty{1 - {1\over t}} Z\qty{1\over qt} \\
&= q^{g-1} t^{2g-2} (1-t) (1-qt) Z\qty{1\over qt} \\
&= (1-t) (1-qt) Z(t) \\
&\da L(t)
,\]
where we've distributed one $q$ and two $t$s in the first steps.
:::

### Coefficients $a_j$ for $j=0, 1, 2g$ and Duality

:::{.proof title="of d"}
Using the functional equation from (c), we can write
\[  
L(t) = q^g t^{2g}  L\qty{1\over qt} = \qty{a_{2g} \over q^g} + \qty{a_{2g-1} \over q^{g-1}}t + \cdots +  \qty{a_0 q^g} t^{2g}
,\]
where we're correcting by enough in $t$ but not enough in $q$ and seeing what we get.
Equating coefficients, for $0\leq j \leq g$ we have
\[  
a_{2g-j} = q^{g-j} a_j
\label{eq:sym_formula_proofc}
.\] 

Using the fact that $A_0$ is the number of effective degree zero divisors, which is only zero, we have $A_0 = 1$ and we can multiply formal power series to obtain 
\[  
L(t) = a_0 + a_1 t + \cdots + a_{2g} t^{2g} 
&= (1-t)(1-qt) \sum_{n=0}^\infty A_n t^n \\
&= \qty{ 1 - (q+1)t + qt^2 }(1 + A_1 t + A_2 t^2 + \cdots)\\
&= 1 + \qty{A_1 - (q+1) }t + \cdots
.\]
From this, we can read off

- $L(0) = a_0 = 1$
- $a_1 = A_1 - (q+1) = \Sigma_1(K/k) - (q+1)$
- $a_{2g} = a_{2g-0} = q^{g-0}a_0 = a^g$ by taking $j=0$ in \cref{eq:sym_formula_proofc}, and thus $\deg L = 2g$.

:::

### Absolute Values of Roots / RH

:::{.proof title="of e (the most interesting!)"}
Consider the **reciprocal polynomial** 
\[  
L^{\perp}(t) \da t^{2g} L\qty{1\over t}
= t^{2g} + a_1 t^{2g-1} + \cdots + q^g
.\]
The original polynomial had $\ZZ$ coefficients and constant term 1, so this polynomial is monic and has a nonzero constant term.
Thus its roots are patently nonzero algebraic integers in $\bar{\ZZ}\nonzero$.
If $L^{\perp}(t) = \prod_{j=1}^{2g} (t-\alpha_j)$, then 
\[  
L(t) = t^{2g} L^{\perp}\qty{1\over t} = \prod_{j=1}^{2g} (1 - \alpha_j t)
\]
and if the roots of $L(t)$ are $r_j$, then the roots of $L^{\perp}(t)$ are the reciprocal roots $1/r_j$ and vice-versa.
This shows the first assertion that $r_j \in \bar{\ZZ}$ as well.

The most interesting part is what follows.
Making the substitution $t=qu$ and using (c) we get
\[  
L^{\perp}(t)
&= \prod_{j=1}^{2g} (t- \alpha_j) \\
&\da t^{2g} L\qty{1\over t} \\
&= q^{2g} u^{2g} L\qty{1\over qu} && \text{by (c)}
.\]

Using $u = t/q$, we can write 
\[  
q^g L(u) 
&= q^g \prod_{j=1}^{2g} (1 - \alpha_j u) \\
&= q^g \prod_{j=1}^{2g} \qty{ 1 - {\alpha_j \over q}t} \\
&= q^g \prod_{j=1}^{2g} {\alpha_j \over q} \prod_{j=1}^{2g}\qty{ t - {1\over \alpha_j} } \\
&= \prod_{j=1}^{2g} \qty{t - {q\over \alpha_j}}
,\]
where we've pulled out a factor of $-\alpha_j/q$ and
in the last step we've used that $\prod_{j=1}^{2g} \alpha_j = q^g$. 
This follows because the $\alpha_j$ are the roots of $L^{\perp}$, which has even degree, so the product of all of the roots is equal to the constant term of $L^{\perp}$, which is the leading term of $L$, which we showed was $q^g$.

This says that if we take these roots $\alpha_j$ as a multiset and replace each $\alpha_j$ with $q/\alpha_j$, we get the same multiset back.
I.e., this multiset is stable under the involution
\[  
\CC\units &\to \CC\units \\
z &\mapsto {q\over z}
.\]
This almost pairs up the elements of this finite set of roots, except it may have fixed points.
The complex numbers $\alpha$ such that $\alpha = q/\alpha$ are precisely $\pm \sqrt q$.
So group the $\alpha_i^{-1}$ into

- $k$ **pairs** of nonfixed points, where $\alpha_i \neq q/\alpha_i$,
- $m$ points such that $\alpha_i = \sqrt q$,
- $n$ points such that $\alpha_i = -\sqrt q$.

So we'd like to show that $m$ and $n$ are both even, so when we're pairing roots with reciprocals these get paired with themselves.
We know $2k + m + n = 2g$, so $m+n$ is even.
We also know that 
\[  
q^g 
&= \prod_{j=1}^{2g} \alpha_j \\
&= q^k \qty{\sqrt{q}}^m \qty{-\sqrt q}^n  \\
&= (-1)^n q^{k + {m \over 2} + {n\over 2}} \\
&= (-1)^n q^g
.\]
This forces $n$ to be even, and since $m = 2g-2k-n$, $m$ must be even as well.
:::

:::{.proof title="of f"}
We used Dirichlet's character-style decomposition of $Z(t)$ in Schmidt's theorem, and we'll use it again here.
Write 
\[  
L_r(t^r) 
&= (1-t^r) (1-q^r t^r) Z_r(t^r) \\
&= (1-t^r) (1-q^r t^r) \prod_{\xi \in \mu_r} Z(\xi t) \\
&= (1-t^r) (1-q^r t^r) \prod_{\xi \in \mu_r} {L(\xi t) \over (1-\xi t)(1-q\xi t) } \\
&= \prod_{\xi \in \mu_r} L(\xi t) 
,\]

where we've used that
\[  
\prod_{\xi \in \mu_r} {1\over 1 - \xi t} &= 1-t^r \\
\prod_{\xi \in \mu_r} {1\over 1 - q\xi t} &= 1-q^rt^r \\
\]
which leads to all of the denominators canceling.
We can then expand $L_r(t^r)$ as a product to compute
\[  
L_r(t^r) 
&= \prod_{\xi \in \mu_r} L(\xi t) \\
&= \prod_{\xi\in \mu_r} \prod_{j=1}^{2g} (1- \alpha_j qt) \\
&= \prod_{j=1}^{2g} \prod_{\xi\in \mu_r} (1- \alpha_j qt)  && \text{since these are finite products}\\
&= \prod_{j=1}^{2g} (1 - \alpha_j^r t^r)
.\]

From this we can conclude that $L_r(t) = \prod_{j=1}^{2g} (1- \alpha_j^r t)$, since $t^r$ is just an indeterminate and these are all identities of polynomials.
:::

## Applications and Corollaries


### Counting Rational Points

:::{.corollary title="?"}
Suppose $K/\fq$ is genus $g\geq 1$ and $L(t) = \prod_{j=1}^{2g}(1- \alpha_j t)$.
Then for all $r\in \ZZ^{\geq 0}$, we have a nice expression for $N_r$:
\[  
N_r \da \abs{\Sigma_1(K_r/\fqr)} = q^r + 1 - \sum_{j=1}^{2g} \alpha_j^r
.\]
:::

:::{.proof title="?"}
Let $L_r(t) = \sum_{j=1}^{2g} a_{j, r} = \prod_{j=1}^{2g} (1 - \alpha_j^r t)$,
so $a_{1, r} = -\sum_{j=1}^{2g} \alpha_j^r$.
Then using (d) part 3, we can write
\[  
\abs{\Sigma_1(K_r/\fqr)} = q^r + 1 + a_{1, r} = q^r + 1 - \sum_{j=1}^{2g} \alpha_j^r
.\]
This follows from consider $\prod (1-\alpha_j^r t)$, where extracting the $t^1$ coefficient involves choosing $-\alpha_j^r$ once and 1 from all of the remaining terms, and then you sum over the disjoint possibilities.
:::

:::{.remark}
We'd really like to compute the coefficients of the $L$ polynomials, since we can solve a polynomial equation to get the roots.
But the Galois groups of these polynomials may not be solvable, so the term $\sum \alpha_j^r$ will in general be some symmetric function in the complex roots.
Note that any symmetric polynomial in the roots is also a symmetric polynomial in the coefficients.
:::

### Relating Rational Points to Coefficients

:::{.corollary title="?"}
For $K/\fq$ a function field, define
\[  
S_r \da N_r - (q^r + 1) = - \sum_{j=1}^{2g} \alpha_j^r
.\]
Note that $N_r = \abs{\Sigma(K_r/\fqr)}$ is the number of $\fqr\dash$rational point.
Then

a. $L'(t)/L(t) = \sum_{r=1}^\infty S_r t^{r-1}$.
b. $a_0 = 1$, and for all $1\leq i \leq g$, 
\[  
ia_i = S_i a_0 + S_{i-1} a_1 + \cdots + S_1 a_{i-1}
.\]
:::

:::{.remark}
What's the usefulness here?
If you only have the coefficients of the $L$ polynomials, taking the logarithmic derivative gives access to these quantities $S_r$.
The second formula is a recursive expression for the $a_i$ in terms of the $S_i$.
So you can compute the coefficients of the $L$ polynomial by counting $\fqr\dash$rational points on your curve (or places on your function field) for $r=1,2,\cdots, g$.
Similarly, if you have all of the coefficients for a $Z$ polynomial, you can solve for the $S_i$.
:::

:::{.proof title="of a"}
Essentially just a computation.
Logarithmically differentiating both sides of $L(t) = \prod_{j=1}^{2g} (1-\alpha_j t)$ and expanding in a geometric series yields
\[  
{L'(t)  \over L(t) } 
&= \sum_{j=1}^{2g} {-\alpha_j \over a -\alpha_j t} \\
&= \sum_{j=1}^{2g} (-\alpha_j) \sum_{r=0}^\infty \qty{\alpha_j t}^r \\
&= \sum_{r=1}^{\infty} \qty{\sum_{j=1}^{2g} (-\alpha_j^r) }t^{r-1} \\
&= \sum_{r=1}^{\infty} S_r t^{r-1}
.\]
:::

:::{.proof title="of b"}
Clearing denominators and equating coefficients in $L'(t) = L(t) \sum_{r=1}^{\infty} S_r t^{r-1}$ yields the result immediately, since the $ia_i$ are what appear as coefficients in the derivative of a formal power series, whereas the RHS is a Cauchy product.
:::

:::{.remark}
The moral: to compute zeta functions, you don't have to enumerate divisors and compute dimensions of Riemann-Roch spaces.
Note that the Riemann-Roch theorem tells us something interesting about these dimensions, but doesn't compute the dimension outright!
Instead, it suffices to compute $\fqr\dash$rational points for $r\leq g$.

A few lectures ago we discussed the places on a hyperelliptic function field, including a place at infinity.
Computing the zeta function of a hyperelliptic curve involves plugging in $x\dash$values and determining if it is

- A nonzero non-square: no $y\dash$values,
- Zero: exactly one $y\dash$value,
- A nonzero square: two $y\dash$values.

This is what happens at the finite places.
To handle the place at $\infty$, there is a recipe for the degree of the polynomial in terms of the coefficients.
So for any hyperelliptic function field (and in particular, for any elliptic function field) we have a concrete algorithm for computing their zeta functions.
Note that this is not necessarily a *good* algorithm: it still involves plugging in many values and checking if things are squares in finite values.
It seems that most people who compute a lot of zeta functions mostly focus on hyperelliptic function fields.

How are you going to compute zeta functions or even places for more complicated function fields?
The Riemann-Hurwitz formula says that since any function field is a finite degree extension of a rational function field, the curve is given as a degree 2 branched cover of $\PP^1$, it suffices to compute the fibers of this cover in order to get point counts.
::: 


# Lecture 16


## Weil Bounds

Last time: we finished a discussion of the Hasse-Weil zeta function over a finite ground field $\fq$.

:::{.exercise title="?"}
Let $K/\fq$ be a function field of genus 1.

a. Show 
\[  
Z(t) = { 1-at + qt^2 \over (1-t)(1-qt)}
,\]
  where $a = q+1 - \abs{\Sigma_1(K/\FF_q)}$.

b. Let $L(t) \da (1-\alpha_1 t)(1-\alpha_2 t)$.
  Show that $a = \alpha_1 + \alpha_2$, and that for all $r\in \ZZ^{+}$, 
  \[  
  \abs{\Sigma_1 (K_r / \FF_{q^r}} = q^r +1 - \alpha_1^r - q^r/\alpha_1^r
  .\]
  Thus for elliptic curves $E/\FF_q$, knowing $\abs{E(\FF_q)}$ determines $\abs{E(\FF_{q^r})}$ for all $r\in \ZZ^+$.

c. Suppose $a^r = 0$ and show

  \[  
  r \text{ odd} &\implies \abs{\Sigma_1 (K_r/\FF_{q^r}) } = q^r + 1 \\
  r \equiv 2\mod 4 &\implies \abs{\Sigma_1 (K_r/\FF_{q^r}) } = (q^{r/2} + 1)^2 \\
  r \equiv 0\mod 4 &\implies \abs{\Sigma_1 (K_r/\FF_{q^r}) } =  (q^{r/2} - 1)^2 \\
  .\]
:::

:::{.theorem title="?"}
Let $K/\FF_q$ be a function field of genus $g$ with $L\dash$polynomial $L(t) = \prod_{i=1}^g (1 - \alpha_i t)$.
Then $\abs \alpha_i = \sqrt{q}$ for all $i$.
:::

:::{.remark}
In order to prove this, Weil had to develop foundations for algebraic geometry in positive characteristic.
His original proof used intersection theory on algebraic surfaces.
:::


:::{.corollary title="Weil Bounds"}
If $K/\FF_q$ is a function field of genus $g$, then
\[  
\abs{ \abs{\Sigma_1 (K/\FF_q)} - (q+1) } \leq 2g \sqrt{ q}
.\]
:::

:::{.remark}
This says that the number of $\FF_q$ points is approximately $q+1$< where the error is controlled by the genus.
:::

:::{.proof title="?"}
We know
\[  
\abs{\Sigma_1(K/\FF_q)} = q + 1 - \sum \alpha_i
.\]
Thus 
\[  
\abs{ 
\Sigma_1(K/\FF_q) - (q+1)
}
=
\abs{
\sum \alpha_i
}
\leq
\sum_{i=1}^{2g} \abs{\alpha_i}
=2g\sqrt q
.\]
:::

:::{.corollary title="?"}
For $r\gg 0$, $N_r \da \abs{\Sigma_1(K_r/ \FF_{q^r})} \geq 1$.
:::

:::{.proof title="?"}
The Weil bounds yield
\[  
N_r \geq q^r + 1 - 2g q^{r/2}
\geq 
q^{r/2} \qty{q^{r/2} - 2g} \converges{r\to \infty} \infty
.\]
This can be alternatively phrased as 
\[  
N_r = q^r + O_g(q^{r/2})
.\]
Note that we've used the fact that making any separable extension of a function field will preserve the genus, and so $g$ is fixed.
:::

:::{.remark}
So for $r$ large enough, there is an $\FF_{q^r}\dash$rational point, and $N_r \to \infty$ exponentially fast in $r$.
:::

:::{.remark}
As a consequence, if $\omega\in \Sigma_1(K_r/ \FF_{q^r})$, let $v\da \omega\intersect K$.
We saw that $\deg(v) = d$ which divides $r$, so we can form the divisor $r/d[p] \in \Div^r K$ for any place $p$ below $v$.
So any degree 1 place yields a degree $r$ divisor, which shows that $\Div^r K \neq \emptyset$ for all $r$ large enough and thus $\delta=1$ (which is Schmidt's theorem).
:::

:::{.exercise title="?"}
\envlist

a. Show that there is a constant $C$ depending only on $g$ such that if $r\geq C$ then for all $n\geq 2$, $N_{nr} > N_r$.


b. Use the following fact to show that there exists a constant $D$ depending on $g$ such that for all $d\geq D$, $\Sigma_d(K/\FF_q) \neq \emptyset$:
\[  
N_r = \sum_{d\divides r} d \abs{ \Sigma_d(K/\FF_q) }
.\]
:::

:::{.remark}
Note that this is stronger than Schmidt's theorem: it implies that not only do you have a divisor of degree $d$, but also a place of degree $d$.
:::


:::{.exercise title="?"}
\envlist

a. Use the Weil bounds to show that when $g=0$, $\abs{\Sigma_1(K/\FF_q)} = q+1$.
Deduce that every genus zero function field is rational.

b. Use the Weil bounds to show that if $g=1$, then $\abs{\Sigma_1(K/\FF_q)} \geq \qty{\sqrt q - 1}^2 > 0$, and thus every genus 1 function field over $\FF_q$ is elliptic.[^def_ell_ff]

[^def_ell_ff]: 
By definition, a genus 1 function field with a degree 1 place, which can be used as the origin for the group structure.

:::

:::{.corollary title="Serre Bounds"}
Let $K/\FF_q$ be a function field of genus $f$, then
\[  
\abs{
\Sigma_1(K/\FF_q) - (q + 1)
}
\leq g \floor{2 \sqrt q}
.\]
::: 


:::{.remark}
We write
\[  
M_q(g) &\da \text{The maximal } \abs{\Sigma(K/\FF_q)} \text{ as $K$ ranges over genus $g$ function fields} \\
m_q(g) &\da \text{The minimal } \abs{\Sigma(K/\FF_q)} \text{ as $K$ ranges over genus $g$ function fields} \\
A(q) &\da \limsup_{g\to \infty} {M_q(g) \over g}
.\]
This is essentially the best constant that can be put in front of $g$ in the bounds.
With these definitions, we have
\[  
A(q) \leq 2\sqrt q && \text{by Weil bounds }\\
A(q) \leq \floor{2\sqrt q} && \text{by Serre bounds }\\
.\]
Note that we can do much better, e.g. $A(2) \leq \sqrt{2} - 1$, but it is not known if this is sharp.
:::

:::{.proof title="of Serre's bound"}
We may assume $g \geq 1$, and write $L(t) = \prod_{i=1}^{2g} (1-\alpha_i t)$, where the $\alpha_i$ may be ordered such that $\alpha_i \alpha_{g+-} = g$ for all $i$.
By the Riemann hypothesis, we have $\abs {\alpha_i} = \sqrt q$, and so for each $i$ we have $\bar{\alpha_i} = q/\alpha_i = \alpha_{g+i}$.
We now pair in the following way: set
\[  
\gamma_i &\da \qty{ \alpha_i + \bar{\alpha_i} } + \floor{2\sqrt q} + 1 \\
\delta  &\da -\qty{ \alpha_i + \bar{\alpha_i} } + \floor{2\sqrt q} + 1 \\
.\]
These are real algebraic integers and by the Riemann hypothesis they are positive.
Since $L^{\perp}(t) \da \prod t-\alpha_i \in \ZZ[t]$, take any complex embedding 
\[  
\sigma: \QQ\qty{\ts{\alpha_i}} \injects \CC
,\]
which preserves the $\alpha_i$. 
If $\sigma(\alpha_i) = \alpha_j$, then we have
\[  
\sigma(\bar{\alpha_i}) = \sigma\qty{q/\alpha_i} = q/\sigma(\alpha_i) = \bar{\sigma(\alpha_i)} = \alpha_j
,\]
and thus $\sigma$ preserves the multisets of the $\gamma_i$ and $\delta_i$.

Now set $\gamma\da \prod \gamma_i$ and $\delta \da \prod \delta_i$, making these both positive real integers that are fixed by every embedding $\sigma$, and thus $\gamma, \delta\in \ZZ^+$.
We can now apply the AM-GM inequality:
\[  
{1\over g} \sum_{i=1}^g \gamma_i 
&\geq \qty{ \prod_{i=1}^g \gamma_i}^{1\over g} 
= \gamma^{1/g} \geq 1
,\]
and thus
\[  
g \leq \sum \gamma_i 
= \sum_{\alpha_i + \bar{\alpha_i}} + g\floor{2\sqrt q} + g 
= \sum \alpha_i  + g\floor{2\sqrt q} + g 
,\]
and we can conclude that $-\sum \alpha_i \leq g\floor{2\sqrt g}$.
Repeating the argument with the $\delta_i$ yields $\sum \alpha_i \leq g \floor{2\sqrt q}$, meaning that $\abs{\sum \alpha_i } \leq g \floor{2\sqrt q}$.
Thus
\[  
\abs{ \abs{\Sigma_1(K/\FF_q)} - (q+1)  } = \abs{\sum \alpha_i} \leq g \floor{2\sqrt q}
.\]
:::

:::{.remark}
An application to class numbers: since $g = L(1)$, by the Riemann hypothesis we have 
\[  
\sqrt{q} - 1 \leq \abs{\alpha_i - 1} \leq \sqrt{q} + 1
\]
and thus
\[  
\qty{\sqrt q - 1}^{2g} \leq h \leq \qty{\sqrt q + 1}^{2g}
.\]

There is a slight improvement:
\[  
\qty{\sqrt q - 1}^{2g} \leq \qty{q+1 - \floor{2\sqrt q} }^g \leq h \leq \floor{\qty{\sqrt q + 1}^2}^g = \qty{q+1 + \floor{2\sqrt q}}^g
.\]
::: 


:::{.corollary title="?"}
\envlist

a. For all $q\geq 5$, we have 
\[  
h\ geq \qty{\sqrt 5 - 1}^{2g} \geq 1.236^{2g}
.\]

b. The class number grows exponentially in the genus not just for each fixed $q$ but uniformly over all $q\geq 5$.
  In particular, if $g\geq 1$, this forces $h> 1$.

:::

What exactly is happening at small $q$, such as $q\in \ts{2,3,4}$?

:::{.theorem title="?"}
For $K/\FF_q$ of genus $g\geq 1$, 
\[  
h \geq \qty{q-1 \over 2} \qty{q^{2g} + 1 - 2gq^g \over g\qty{q^{g+1} - 1}}
.\]
:::



:::{.exercise title="?"}
\envlist

a. Show that 
\[  
h\geq  \qty{q-1 \over 2}\qty{{ q^{g-1} \over g} - {2\over q}}
,\]
  which still grows exponentially in $g$.

b. Show that for any $1<C<2$, setting $\underline{h}(g)$ to be the minimum class number of a genus $g$ function field over *any* finite field, we have $\underline{h}(g) \gg C^g$ and is thus also growing exponentially in $g$.

c. Deduce that for all $H\in \ZZ$, the collection $\mathfrak{C}(H) \da \ts{(q, g) \st \exists K/\FF_q \text{ of genus } g\geq 1 \text{ and } h\leq H}$ is a finite set.
:::

:::{.question title="Class Number Problem"}
Find $\mathfrak{C}(H)$ for each $H$.
For $H=1$, this has been solved, but there hasn't been much work on the $H=2,3$ cases.
:::


The following proof: very neat! Pete likes it.

:::{.proof title="?"}
The number $A_{2g}$ of effective degree $2g$ divisors on $K$ is $h\qty{q^{g+1} - 1 \over q-1}$
by an application of the Riemann-Roch theorem, since $2g > 2g-2$.
Let $Q\in \Sigma_1(K_{2g} / \FF_{q^{2g}})$ be a degree one place and restrict to $K$ to obtain $P \da Q\intersect K$ which has degree $\ell$ dividing $2g$.
Then $\qty{2g \over \deg(P)} P$ has degree $2g$, and this yields a map
\[  
\Sigma_1(K_{2g} / \FF_{q^{2g}}) &\to \text{Effective degree $2g$ divisors} \\
Q &\mapsto {2g \over \deg P} P
.\]
This is not necessarily surjective, but how far is it from being injective?
The fibers have size at most $2g$ since we have a degree $2g$ extension of Dedekind domains.
Thus
\[  
\abs{\Sigma_1 (K_{2g} / \FF_{q^{2g}}) } \leq A_{2g}
,\]
and substituting the known value of $A_{2g}$ and rearranging yields
\[  
h 
&\geq {1\over 2g} \qty{q-1 \over q^{g+1} - 1} N_{2g} \\
&\geq  \qty{1\over 2g} \qty{q-1 \over q^{g+1} - 1} \qty{ q^{2g} + 1 - 2g q^g}
&& \text{by the Weil bounds} \\
&= \qty{q-1 \over 2} \qty {q^{2g} + 1 - 2gq^g \over  g\qty{q^{g+1} - q}}
.\]
:::

# Lecture 17 (Todo) 

# Lecture 18 (Todo) 

# Lecture 19 (Todo) 

# Lecture 20 (Todo) 

# Lecture 21 (Todo) 

# Lecture 22 (Todo) 

# Lecture 23 (Sketch)

\todo[inline]{What is an isogeny?}
\todo[inline]{What is an Artin-Schreier extension?}
\todo[inline]{What is Kummer theory?}
\todo[inline]{What are Weil differentials?}
\todo[inline]{What are Kahler differentials?}
\todo[inline]{What is the Riemann Hurwitz formula?}

:::{.corollary title="?"}
Let $k$ be a perfect field of characteristic $p>0$, $d\in \ZZ^{\geq 0}$ with $\gcd(d, p) = 1$, and let $f\in k[x]$ and $L\da K(p^{-1} (f))$.
Then $[L:K] = p$ and $L/k$ is a regular function field of genus $g = {1\over 2}(p-1)(d-1)$ that is unramified away from $\infty$.
:::

## Artin-Schreier Extensions of Function Fields

:::{.fact}
For $k$ a field, $\ch(k) = p > 0$, and $a, b\in k$, TFAE:

1. $k(p^{-1}(a)) = k(p^{-1}(b))$

2. $a$ and $b$ generate the same cyclic subgroup of $k/p(k)$.

In particular, if $K(p^{-1}(u))/k$ is an Artin-Schreier extension, then for all $x\in k$, $k(p^{-1}(u - (x^p - x))) = k(p^{-1}(u))$.
:::

:::{.lemma title="?"}
Let $k$ a *perfect* field of characteristic $p>0$, $K/k$ a function field, $u\in K$, and $p\in \Sigma(K/k)$.

- There exists a $z\in K$ such that $z_v \da v_p(u - (z^p - z))$ satisfies either

  - $z_v \geq 0$, or
  - $z_v\leq 0$ and $z_p$ is prime to $p$.

- There exists a most one $m\in \ZZ$ that is negative and prime to $p$ such that for some $z\in K$ we have $v_p(u - (z^p - z)) = m$.
If such an $m$ exists, it is given by $m = \max\ts{v_p(u - (z^p - z)) \st z\in K }$.

- It follows that precisely *one* of the two alternatives in the first statement holds.
:::

:::{.theorem title="Genus Formula for Artin-Schreier Extensions"}
Let $k$ a *perfect* field of characteristic $p>0$, $K/k$ a function field, $u\in K$, $L\da K(p^{-1}(u))$, $p\in \Sigma(K/k)$, and set
\[  
M_p \da 
\begin{cases}
\abs{m} & \text{if there exists a $z\in K$ such that } v_p(u - (z^p - z)) = m \\
-1 & \text{if there exists a $z\in K$ such that } v_p(u - (z^p - z)) \geq 0 \\
\end{cases}
.\]

Then

a. If $M_p = -1$, then $p$ is unramified in $L$.

b. If $M_p \geq 1$, then $p$ is totally ramified in $L$.
  Letting $\tilde p$ be the unique place lying over $p$, then
  \[  
  d(\tilde p / p) = (p-1)(M_p + 1) && \text{(wild ramification)}
  .\]

c. Suppose there exists a $p$ such that $M_p \geq 1$.
  Then $[L: K] = p$, $L/k$ is regular, and we have a genus formula
  \[  
  g_L = p g_K + \qty{p-1 \over 2} \qty{ -2 + \sum_{p\in \Sigma(K/k)}(M_p+1)\deg p }
  .\]

:::





# Lecture 24: Hermitian Function Fields (Sketch)

\todo[inline]{What is an elementary $p\dash$group?}
\todo[inline]{What is geometrically irreducible?}

:::{.theorem title="Stichtenoth Prop 6.4.1"}
Let $k$ be a perfect field of characteristic $p>0$, $q \da p^s$ some power of $p$, $K \da k(x)$.
Let $u \in k\units$ and suppose $T^q + \mu T$ splits in $k$.[^q_artin]
Let $f\in k[x]$ with $\deg(f) = M$ where $p\not\divides M$.
Then

a. The polynomial 
\[  
P(x, y) \da y^q + uy -f(x) \in k[x]
\]
is geometrically irreducible, and so $L\da \ff(k[x,y]/\gens{p})$ is a regular function field over $k$.

b. We have $[L: K] = q$.

c. $A\da \ts{\gamma\in k \st \gamma^q + u\gamma = 0}$ is an order $q$ subgroup of $\GG_a/k \da (k, +)$.
  Moreover, for all $\sigma\in \Aut(L/K)$, there exists a unique $\gamma(\sigma)\in A$ such that $\sigma(y) = y + \gamma(\sigma)$ and $\sigma \mapsto \gamma(\sigma)$ yields an isomorphism $\Aut(L/K) \mapsvia{\sim} A$.

d. No finite place of $K$ ramifies in $L$, while $p_\infty$ is totally ramified.
If $\tilde p_ \infty / p_ \infty$, then $d(\tilde p_ \infty / p_ \infty) = (q-1)(M+1)$.

e. We have
\[  
g_L = \qty{1\over 2}(q-1)(m-1)
.\]

[^q_artin]: When $u=-1$, this recovers $q\dash$Artin-Schreier extensions.

:::

Next up: one of the most important function fields of all time!

:::{.definition title="Hermitian Function Field"}
Set $A_q \da \FF_{q^2}(x, y)$ and consider the polynomial
\[  
y^q + y = x^{q+1}
.\]
Then $u=1, M = q+1$, and $g = \qty{1\over 2}(q)(q-1) = {q \choose 2}$.
:::

:::{.theorem title="?"}
\[  
\abs{\Sigma_1(A_q / \FF_{q^2})} = q^3 + 1
.\]
:::

\todo[inline]{What are the Weil bounds?}

:::{.corollary title="Ihara"}
If $K/\FF_q$ is a maximal function field of genus $g$, then 
\[  
g\leq \qty{1\over 2}\qty{q - \sqrt q}
.\]
:::

:::{.fact}
If $K/\FF_{q^2}$ is maximal, then $N_1 = q^2 + 1 + 2gq = q^2 + q - \sum_{j=1}^{2g} \alpha_j$.
Applying the RH, $\abs{\alpha_j} = q$, and it follows that $\alpha_j = -q$ for all $j$ and thus
\[  
L(t) = \qty{1+qt}^{2g}
.\]
:::

:::{.theorem title="Kleiman, Serre"}
If $K/\FF_q \subset L/\FF_q$ is a finite extension of function fields, then $L_K(t)$ divides $L_L(t)$.
:::

:::{.corollary title="?"}
If $L/\FF_{q^2}$ is maximal, so is $K/\FF_{q^2}$.
:::

:::{.theorem title="Stichtenoth?"}
\[  
\Aut(A_1 / \FF_{q^2}) \cong \operatorname{PGU}_3(\FF_{q^2})
,\]
the *projective unitary group*, which is of order $q^3(q^2-1)(q^3+1)$.
:::

:::{.remark}
The size of this group $G_q$ is asymptotically $G_q \sim q^8$, while $g(A_q) \sim {q^2\over 2}$, so this is a lot of automorphisms compared to the sizes of automorphism groups of Riemann surfaces.
More precisely, $G_q > 16 g(q)^4$.
:::

:::{.theorem title="Stichtenoth"}
For any other function field $K/k$ for any field $k$, $\abs{\Aut(K/k)} < 16g^4$.
:::

:::{.remark}
This only happens in positive characteristic, when $\ch(k), g, q$ match up in a very specific way.
So Hermitian function fields are the algebraic curves with the most symmetries.
:::

:::{.theorem title="Hurwtiz"}
In characteristic zero, if $g\geq 2$ then $\abs{\Aut(K/k)} \leq 84(g-1)$.
:::




# Lecture 25: Differential Pullback Theorem (Sketch)

This will recover the Riemann-Hurwitz formula by taking degrees.

:::{.lemma title="?"}
Let $K/k \subset L/\ell$ be a finite degree extension of function fields, and suppose $K/k$ is regular and $L/K$ is separable.
Then $\ell/k$ and $L/\ell$ are separable and $L\ell$ is regular.

\begin{tikzcd}
	& {L} \\
	{K} && {\ell} \\
	& {k}
	\arrow["{\scriptscriptstyle\text{separable}}", from=2-1, to=1-2, no head]
	\arrow[from=1-2, to=2-3, no head]
	\arrow[from=2-3, to=3-2, no head]
	\arrow["{\scriptscriptstyle\text{regular}}"', from=2-1, to=3-2, no head]
\end{tikzcd}
[Link to diagram](https://q.uiver.app/?q=WzAsNCxbMSwyLCJrIl0sWzIsMSwiXFxlbGwiXSxbMSwwLCJMIl0sWzAsMSwiSyJdLFszLDIsIlxcc2NyaXB0c2l6ZVxcdGV4dHtzZXBhcmFibGV9IiwwLHsic3R5bGUiOnsiaGVhZCI6eyJuYW1lIjoibm9uZSJ9fX1dLFsyLDEsIiIsMCx7InN0eWxlIjp7ImhlYWQiOnsibmFtZSI6Im5vbmUifX19XSxbMSwwLCIiLDAseyJzdHlsZSI6eyJoZWFkIjp7Im5hbWUiOiJub25lIn19fV0sWzMsMCwiXFxzY3JpcHRzaXplXFx0ZXh0e3JlZ3VsYXJ9IiwyLHsic3R5bGUiOnsiaGVhZCI6eyJuYW1lIjoibm9uZSJ9fX1dXQ==)
:::

Recall some facts/definitions:

- The **adele ring of $K$** is defined as 
  \[
  \mathcal{A}_K \da \prod_{v\in \Sigma(K/k)}' K
  \]
  which is a *restricted direct product*, i.e. each element $\alpha\in \mathcal{A}_K$ has the property that for almost every $p$, the $p\dash$adic valuation of the $p$th coordinate $v_p(\alpha_p) \geq 0$.
  There is a diagonal embedding
  \[  
  K &\injects \mathcal{A}_K \\
  f &\mapsto (f, f, \cdots)
  .\]

- For any divisor $D\in \Div K$, define
\[  
\mathcal{A}_K(D) \da \ts{\alpha\in \mathcal{A}_K \st v_p(\alpha_p) \geq - v_p(D)\,\, \forall p}
,\]
  the adelic analog of the Riemann-Roch space.

- A space of linear forms
\[
\Omega(D) \da \ts{\omega: \mathcal{A}_K \to A \st \ker \omega \supseteq K + \mathcal{A}_K(D)}
\]
  where $D_1 \leq D_2 \implies \Omega_K(D_2) \leq \Omega_K(D_1)$.

- $\Omega_K \da \directlim_{D} \Omega_K(D)$.

- For any $\omega \in \Omega_K\nonzero$, $(\omega) \da \max\ts{D \st \omega=0 \text{ on } \mathcal{A}_K(D) + K}$.

- $\mathcal{A}_{L/K} = \ts{\alpha\in \mathcal{A}_L \st \alpha q_1 = \alpha q_2 \text{ if } Q_1, Q_2 / p} \leq_{\Vect_\ell} A_L$

- The **adelic trace map**
\[  
\Tr_{L/K} : \mathcal{A}_{L/K} & \to \mathcal{A}_K  \\
\alpha &\mapsto \Tr_{L/K}(\alpha) / p = \Tr_{L/K}(\alpha_Q) && \text{for any }Q/p
.\]

:::{.theorem title="?"}
Let $\omega\in \Omega_K$, then there exists a unique $\omega^* \in \mathcal{A}_L$ such that

- For all $\alpha\in \mathcal{A}_{L/K}$, we have $\Tr_{\ell/k} \omega^*(\alpha) = \omega(\Tr_{L/K}(\alpha))$.

$\omega^*$ is formally denoted $\mathrm{Cotr}_{L/K}(\omega)$ and called the **cotrace** of $\omega$.
:::

:::{.theorem title="?"}
If $K/k \subset L/\ell$ is a finite extension of function fields with $K/k$ regular, then for all $\omega\in \mathcal{A}_K\nonzero$, we have $\omega^* \in \mathcal{A}_L\nonzero$.
Moreover,
\[  
(\omega^*) = \iota_{L/K}((\omega)) + D(L/K)
.\]
Taking degrees yields the Riemann-Hurwitz formula.
:::

# Lecture 26 (Todo) 
